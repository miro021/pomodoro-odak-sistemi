<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro OS v7.0 - Visual Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'blob': 'blob 10s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'breathe': 'breathe 4s ease-in-out infinite',
                        'slide-down': 'slideDown 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'listening': 'listening 1.5s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        listening: {
                            '0%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' },
                            '70%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' },
                            '100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- React Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&family=Patrick+Hand&display=swap');

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
        
        .glass-panel { 
            background: rgba(18, 18, 18, 0.75); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); 
        }
        
        .dynamic-island {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        body { margin: 0; font-family: 'Outfit', sans-serif; background: #000; overflow-x: hidden; }
        
        /* Font for "Handwritten" notes */
        .font-hand { font-family: 'Patrick Hand', cursive; }

        input[type=range] {
            -webkit-appearance: none; 
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        /* --- PRINT STYLES FOR INFOGRAPHICS --- */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { 
                visibility: visible; 
            }
            #printable-area { 
                position: fixed; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: 100%;
                margin: 0;
                padding: 20px;
                background: white !important; 
                color: black !important;
                z-index: 9999;
                overflow: visible;
                display: block !important;
            }
            
            /* Ensure colors print correctly */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            /* Hide UI elements inside the printable area if needed */
            .no-print { display: none !important; }
            
            /* Typography adjustments for print */
            h1, h2, h3 { color: #000 !important; }
            p { color: #333 !important; }
            .bg-slate-900 { background-color: #f0f0f0 !important; }
            .text-white { color: #000 !important; }
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            background-color: currentColor;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Play, Pause, RotateCcw, Plus, Trash2, Check, Settings, X, 
            Volume2, VolumeX, BarChart2, Moon, Sun, Image as ImageIcon, 
            CloudRain, Waves, Coffee, Flame, Trees, Calendar, 
            User, Zap, LayoutGrid, Sparkles, Loader2, Key, MessageCircle, Send,
            Wand2, Target, Trophy, Library, Wind, Keyboard, BookOpen, Clock, Maximize2, Minimize2,
            StickyNote, GraduationCap, Layers, Radio, ChevronRight, ChevronLeft, RefreshCw,
            Music, Headphones, Cloud, Umbrella, Leaf, Snowflake, SunDim, Upload, Youtube,
            Lightbulb, Palette, Monitor, Printer, PieChart, Split, Brain, FileText, Heart,
            Mic, MicOff, Speaker, Gamepad2, Command, Activity, Share2, Download
        } from 'lucide-react';

        // --- EXPANDED BACKGROUNDS ---
        const BACKGROUNDS = {
            spring: ["https://images.unsplash.com/photo-1490750967868-58cb75069ed6?q=80&w=2600"],
            summer: ["https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2600"],
            autumn: ["https://images.unsplash.com/photo-1509565840034-3c385bed64f3?q=80&w=2600"],
            winter: ["https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=2600"],
            cyber: ["https://images.unsplash.com/photo-1515630278258-407f66498911?q=80&w=2600"],
            space: ["https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2600"]
        };

        const SEASONS_CONFIG = {
            spring: { label: 'İlkbahar', icon: Leaf, color: 'emerald' },
            summer: { label: 'Yaz', icon: SunDim, color: 'yellow' },
            autumn: { label: 'Sonbahar', icon: Wind, color: 'orange' },
            winter: { label: 'Kış', icon: Snowflake, color: 'blue' },
            cyber: { label: 'Cyberpunk', icon: Zap, color: 'purple' },
            space: { label: 'Uzay', icon: Moon, color: 'indigo' }
        };

        const INTERNAL_SOUNDS = [
            { id: 'rain', label: 'Yağmur (Pink Noise)', icon: CloudRain, type: 'pink' },
            { id: 'wind', label: 'Rüzgar (Brown Noise)', icon: Wind, type: 'brown' },
            { id: 'focus', label: 'Odak (White Noise)', icon: Radio, type: 'white' },
        ];

        const MEDIA_PRESETS = [
            { id: 'spotify_focus', type: 'spotify', label: 'Deep Focus', icon: Headphones, link: 'playlist/37i9dQZF1DWZeKCadgRdKQ' },
            { id: 'spotify_piano', type: 'spotify', label: 'Peaceful Piano', icon: Music, link: 'playlist/37i9dQZF1DX4sWSpwq3LiO' },
            { id: 'spotify_lofi', type: 'spotify', label: 'Lofi Beats', icon: Coffee, link: 'playlist/37i9dQZF1DWWQRwui0ExPn' },
            { id: 'spotify_rain', type: 'spotify', label: 'Yağmurlu Gün', icon: CloudRain, link: 'playlist/37i9dQZF1DX2pSTOxoPbx9' },
            { id: 'spotify_jazz', type: 'spotify', label: 'Jazz Vibes', icon: Wind, link: 'playlist/37i9dQZF1DXbITWG1ZJK8t' }
        ];

        const App = () => {
            // --- CORE STATE ---
            const [mode, setMode] = useState('focus');
            const [activeTab, setActiveTab] = useState('timer');
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [zenMode, setZenMode] = useState(false);
            const [breathMode, setBreathMode] = useState(false);
            
            // --- DATA STATE ---
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('pomo_tasks') || '[]'));
            const [newTask, setNewTask] = useState('');
            const [exams, setExams] = useState(() => JSON.parse(localStorage.getItem('pomo_exams') || '[]')); 
            const [newExamTitle, setNewExamTitle] = useState('');
            const [newExamDate, setNewExamDate] = useState('');
            const [notes, setNotes] = useState(() => localStorage.getItem('pomo_notes') || '');
            const [stats, setStats] = useState(() => JSON.parse(localStorage.getItem('pomo_history') || '[]'));

            // --- AUDIO & MEDIA STATE ---
            const [activeSounds, setActiveSounds] = useState({});
            const [masterVolume, setMasterVolume] = useState(1);
            const [activeEmbed, setActiveEmbed] = useState(null); 

            // --- SEASON & BACKGROUND STATE ---
            const [currentSeason, setCurrentSeason] = useState('autumn');
            const [bgIndex, setBgIndex] = useState(0);

            // --- AI & ADVANCED FEATURES STATE ---
            const [studyProfile, setStudyProfile] = useState(() => JSON.parse(localStorage.getItem('pomo_profile') || '{"grade":"","weakSubjects":"","hoursPerDay":4}'));
            const [studyPlan, setStudyPlan] = useState(() => JSON.parse(localStorage.getItem('pomo_plan') || 'null'));
            const [isGeneratingPlan, setIsGeneratingPlan] = useState(false);
            const [isBreakingTask, setIsBreakingTask] = useState(false);
            
            // --- INFOGRAPHIC GENERATOR STATE ---
            const [aiTopic, setAiTopic] = useState('');
            const [infographicData, setInfographicData] = useState(null);
            const [aiImage, setAiImage] = useState(null);
            const [isAiWorking, setIsAiWorking] = useState(false);

            // --- SOCRATIC TUTOR STATE ---
            const [tutorMessages, setTutorMessages] = useState([]);
            const [tutorTopic, setTutorTopic] = useState('');
            const [isTutorThinking, setIsTutorThinking] = useState(false);

            // --- FLASHCARDS ---
            const [flashcards, setFlashcards] = useState(() => JSON.parse(localStorage.getItem('pomo_flashcards') || '[]'));
            const [flashcardTopic, setFlashcardTopic] = useState('');
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [isCardFlipped, setIsCardFlipped] = useState(false);
            const [isGeneratingCards, setIsGeneratingCards] = useState(false);
            
            // --- SYSTEM CONFIG ---
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [showSettings, setShowSettings] = useState(false);
            const [durations, setDurations] = useState({ focus: 25, shortBreak: 5, longBreak: 15 });
            
            // --- CHAT & VOICE (GLOBAL) ---
            const [isCoachOpen, setIsCoachOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([{role: 'system', text: "Sistem hazır. Mikrofonu açıp komut verebilirsin."}]);
            const [chatInput, setChatInput] = useState('');
            const [isAiProcessing, setIsAiProcessing] = useState(false);
            
            // --- GLOBAL VOICE STATE ---
            const [isGlobalVoiceActive, setIsGlobalVoiceActive] = useState(false);
            const [voiceFeedback, setVoiceFeedback] = useState(''); 
            const [voiceEnabled, setVoiceEnabled] = useState(true);
            const [queueLength, setQueueLength] = useState(0); 

            // --- REFS ---
            const timerRef = useRef(null);
            const audioCtxRef = useRef(null);
            const audioNodesRef = useRef({}); 
            const chatEndRef = useRef(null);
            const tutorEndRef = useRef(null);
            const recognitionRef = useRef(null);
            const isSystemSpeakingRef = useRef(false);
            
            // --- QUEUE SYSTEM REFS ---
            const requestQueue = useRef([]);
            const isProcessingQueue = useRef(false);

            // --- FIXED QUEUE PROCESSOR ---
            const processQueue = async () => {
                if (isProcessingQueue.current || requestQueue.current.length === 0) return;
                
                isProcessingQueue.current = true;
                setQueueLength(requestQueue.current.length);

                const currentItem = requestQueue.current[0];
                const { prompt, systemInstruction, resolve, reject, retryCount } = currentItem;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); 

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        system_instruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined
                    };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        if (response.status === 429 || response.status === 503 || errorText.includes('Quota')) {
                            throw new Error("429");
                        }
                        throw new Error(`API Hatası: ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Hata: Boş yanıt.";

                    requestQueue.current.shift();
                    setQueueLength(requestQueue.current.length);
                    resolve(text);
                    
                    setTimeout(() => {
                        isProcessingQueue.current = false;
                        processQueue();
                    }, 2000);

                } catch (e) {
                    if (e.message === "429" && retryCount < 3) {
                        const waitTime = (retryCount + 1) * 10000;
                        setVoiceFeedback(`⏳ Kota sınırı... ${waitTime/1000}s bekleniyor`);
                        requestQueue.current[0].retryCount += 1;
                        setTimeout(() => {
                            isProcessingQueue.current = false;
                            processQueue();
                        }, waitTime);
                    } else {
                        requestQueue.current.shift();
                        setQueueLength(requestQueue.current.length);
                        if (e.message === "429") {
                            reject(new Error("Çok fazla istek. Lütfen biraz bekle."));
                        } else {
                            reject(e);
                        }
                        isProcessingQueue.current = false;
                        processQueue();
                    }
                }
            };

            const addToQueue = (prompt, systemInstruction) => {
                return new Promise((resolve, reject) => {
                    requestQueue.current.push({ prompt, systemInstruction, resolve, reject, retryCount: 0 });
                    setQueueLength(requestQueue.current.length);
                    processQueue();
                });
            };

            const callGemini = (prompt, systemInstruction = "") => {
                if (!apiKey) throw new Error("API Anahtarı eksik.");
                return addToQueue(prompt, systemInstruction);
            };

            // --- SOUND ENGINE ---
            const createNoiseBuffer = (ctx, type) => {
                const bufferSize = ctx.sampleRate * 2;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                if (type === 'white') {
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                } else if (type === 'pink') {
                    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                        b6 = white * 0.115926;
                    }
                } else if (type === 'brown') {
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        data[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = data[i];
                        data[i] *= 3.5;
                    }
                }
                return buffer;
            };

            const toggleInternalSound = (soundId, type) => {
                if (!audioCtxRef.current) audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume();
                const ctx = audioCtxRef.current;

                if (activeSounds[soundId]) {
                    const node = audioNodesRef.current[soundId];
                    if (node) { try{node.stop(); node.disconnect();}catch(e){} delete audioNodesRef.current[soundId]; }
                    setActiveSounds(prev => { const n={...prev}; delete n[soundId]; return n; });
                } else {
                    const buffer = createNoiseBuffer(ctx, type);
                    const source = ctx.createBufferSource();
                    source.buffer = buffer;
                    source.loop = true;
                    const gainNode = ctx.createGain();
                    gainNode.gain.value = 0.5 * masterVolume;
                    source.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    source.start();
                    audioNodesRef.current[soundId] = source;
                    source._gainNode = gainNode;
                    setActiveSounds(prev => ({...prev, [soundId]: 0.5}));
                }
            };

            const updateInternalVolume = (soundId, vol) => {
                const newVol = parseFloat(vol);
                setActiveSounds(prev => ({...prev, [soundId]: newVol}));
                const source = audioNodesRef.current[soundId];
                if (source && source._gainNode) source._gainNode.gain.value = newVol * masterVolume;
            };

            const stopAllSounds = () => {
                Object.keys(audioNodesRef.current).forEach(id => { try{audioNodesRef.current[id].stop(); audioNodesRef.current[id].disconnect();}catch(e){} });
                audioNodesRef.current = {};
                setActiveSounds({});
                setActiveEmbed(null);
            };

            useEffect(() => {
                Object.keys(audioNodesRef.current).forEach(id => {
                    const source = audioNodesRef.current[id];
                    const indVol = activeSounds[id] || 0.5;
                    if(source && source._gainNode) source._gainNode.gain.value = indVol * masterVolume;
                });
            }, [masterVolume]);

            const playBeep = () => {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.type = 'sine';
                osc.frequency.setValueAtTime(880, ctx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(440, ctx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.5, ctx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
                osc.start();
                osc.stop(ctx.currentTime + 0.5);
            };

            // --- PERSISTENCE ---
            useEffect(() => { localStorage.setItem('pomo_tasks', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem('pomo_exams', JSON.stringify(exams)); }, [exams]);
            useEffect(() => { localStorage.setItem('pomo_notes', notes); }, [notes]);
            useEffect(() => { localStorage.setItem('gemini_api_key', apiKey); }, [apiKey]);
            useEffect(() => { localStorage.setItem('pomo_profile', JSON.stringify(studyProfile)); }, [studyProfile]);
            useEffect(() => { localStorage.setItem('pomo_plan', JSON.stringify(studyPlan)); }, [studyPlan]);
            useEffect(() => { localStorage.setItem('pomo_history', JSON.stringify(stats)); }, [stats]);

            // --- TIMER LOGIC ---
            useEffect(() => {
                if (isActive && timeLeft > 0) {
                    timerRef.current = setInterval(() => setTimeLeft(p => p - 1), 1000);
                } else if (timeLeft === 0) {
                    clearInterval(timerRef.current);
                    setIsActive(false);
                    playBeep();
                    if(mode === 'focus') {
                        const today = new Date().toISOString().split('T')[0];
                        setStats(prev => [...prev, { date: today, duration: durations.focus }]);
                        handleChatSend("Sayac bitti. Ne yapmalıyım?", true);
                    }
                }
                return () => clearInterval(timerRef.current);
            }, [isActive, timeLeft, mode]);

            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages, isAiProcessing]);
            useEffect(() => { tutorEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [tutorMessages]);

            // --- VOICE & SPEECH HELPERS ---
            const speakText = (text) => {
                if (!voiceEnabled || !window.speechSynthesis) return;
                
                if (recognitionRef.current) {
                    try { recognitionRef.current.stop(); } catch(e){}
                }
                isSystemSpeakingRef.current = true; 

                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR';
                utterance.rate = 1.0;
                
                utterance.onend = () => {
                    isSystemSpeakingRef.current = false; 
                    if (isGlobalVoiceActive && recognitionRef.current) {
                        try { recognitionRef.current.start(); } catch(e){}
                    }
                };

                window.speechSynthesis.speak(utterance);
            };

            // --- CONTINUOUS VOICE RECOGNITION EFFECT ---
            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!recognitionRef.current) {
                    const recognition = new SpeechRecognition();
                    recognition.lang = 'tr-TR';
                    recognition.continuous = true; 
                    recognition.interimResults = false;

                    recognition.onresult = (event) => {
                        if (isSystemSpeakingRef.current) return;

                        const transcript = event.results[event.results.length - 1][0].transcript.trim();
                        if(!transcript) return;

                        console.log("Duyulan:", transcript);
                        setVoiceFeedback(transcript);
                        setTimeout(() => setVoiceFeedback(''), 3000);
                        
                        handleChatSend(transcript, true); 
                    };

                    recognition.onend = () => {
                        if (isGlobalVoiceActive && !isSystemSpeakingRef.current) {
                            try { recognition.start(); } catch(e) {}
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error("Speech error", event.error);
                        if (event.error === 'not-allowed') setIsGlobalVoiceActive(false);
                    };

                    recognitionRef.current = recognition;
                }

                const recognition = recognitionRef.current;
                if (isGlobalVoiceActive) {
                    try { recognition.start(); } catch(e) {}
                } else {
                    try { recognition.stop(); } catch(e) {}
                }

                return () => {
                    try { recognition.stop(); } catch(e) {}
                };
            }, [isGlobalVoiceActive]); 

            const toggleGlobalVoice = () => {
                if (!apiKey) {
                    alert("Lütfen önce ayarlardan Gemini API anahtarını girin.");
                    setShowSettings(true);
                    return;
                }
                setIsGlobalVoiceActive(!isGlobalVoiceActive);
            };

            // --- MASTER COMMAND CENTER (AI LOGIC) ---
            const handleChatSend = async (overrideText = null, isSilent = false) => {
                const textToSend = overrideText || chatInput;
                if (!textToSend.trim()) return;

                if (!apiKey) {
                    setChatMessages(prev => [...prev, {role: 'user', text: textToSend}, {role: 'system', text: "⚠️ Lütfen Ayarlar'dan API Anahtarını gir."}]);
                    setChatInput(''); return;
                }

                if(!isSilent) setChatMessages(prev => [...prev, {role: 'user', text: textToSend}]);
                setChatInput('');
                
                setIsAiProcessing(true);
                const watchdog = setTimeout(() => {
                    setIsAiProcessing(false);
                    if(isGlobalVoiceActive) setVoiceFeedback("⏱️ Zaman aşımı");
                }, 60000);

                const systemPrompt = `
                    Sen "Pomodoro Student OS" sistemisin. Adın Jarvis.
                    Kısa JSON cevap ver:
                    { "response_text": "Kısa Türkçe cevap", "commands": [{"action": "...", "payload": "..."}] }
                    
                    ACTIONS: SET_TIMER, START_TIMER, PAUSE_TIMER, SET_MODE, ADD_TASK, ADD_NOTE, PLAY_SOUND, STOP_SOUNDS, SET_THEME, OPEN_TAB, GENERATE_PLAN, ENABLE_BREATH, TOGGLE_ZEN, CLEAR_TASKS
                `;

                try {
                    const rawResponse = await callGemini(textToSend, systemPrompt);
                    
                    let jsonResponse;
                    try {
                        const cleanJson = rawResponse.replace(/```json/g, '').replace(/```/g, '').trim();
                        jsonResponse = JSON.parse(cleanJson);
                    } catch (e) {
                        jsonResponse = { response_text: rawResponse, commands: [] };
                    }

                    if(!isSilent) setChatMessages(prev => [...prev, {role: 'system', text: jsonResponse.response_text}]);
                    if(isGlobalVoiceActive) setVoiceFeedback(jsonResponse.response_text);
                    speakText(jsonResponse.response_text);

                    if (jsonResponse.commands && Array.isArray(jsonResponse.commands)) {
                        jsonResponse.commands.forEach(cmd => executeCommand(cmd));
                    }

                } catch (error) {
                    console.error(error);
                    setChatMessages(prev => [...prev, {role: 'system', text: `⚠️ ${error.message || 'Hata oluştu'}`}]);
                } finally {
                    clearTimeout(watchdog);
                    setIsAiProcessing(false);
                    setTimeout(() => setVoiceFeedback(''), 5000);
                }
            };

            const executeCommand = (cmd) => {
                switch(cmd.action) {
                    case 'SET_TIMER':
                        const mins = parseInt(cmd.payload);
                        if (!isNaN(mins)) { setIsActive(false); setTimeLeft(mins * 60); }
                        break;
                    case 'START_TIMER': setIsActive(true); break;
                    case 'PAUSE_TIMER': setIsActive(false); break;
                    case 'SET_MODE': 
                        if(durations[cmd.payload]) { setMode(cmd.payload); setTimeLeft(durations[cmd.payload]*60); setIsActive(false); }
                        break;
                    case 'ADD_TASK':
                        setTasks(prev => [...prev, {id: Date.now(), title: cmd.payload, completed: false}]);
                        break;
                    case 'ADD_NOTE':
                        setNotes(prev => prev + "\n- " + cmd.payload);
                        break;
                    case 'PLAY_SOUND':
                        if (cmd.payload.startsWith('spotify')) {
                            const preset = MEDIA_PRESETS.find(p => p.id === cmd.payload);
                            if(preset) setActiveEmbed(preset);
                        } else {
                            toggleInternalSound(cmd.payload, cmd.payload === 'rain' ? 'pink' : cmd.payload === 'wind' ? 'brown' : 'white');
                        }
                        break;
                    case 'STOP_SOUNDS': stopAllSounds(); break;
                    case 'SET_THEME': if (BACKGROUNDS[cmd.payload]) setCurrentSeason(cmd.payload); break;
                    case 'OPEN_TAB': setActiveTab(cmd.payload); break;
                    case 'GENERATE_PLAN': generateStudyPlan(); setActiveTab('planner'); break;
                    case 'ENABLE_BREATH': setBreathMode(true); break;
                    case 'TOGGLE_ZEN': setZenMode(cmd.payload === 'on' || !zenMode); break;
                    case 'CLEAR_TASKS': setTasks([]); break;
                    default: break;
                }
            };

            // --- AI INFOGRAPHIC GENERATOR ---
            const generateAiInfographic = async () => {
                if(!aiTopic.trim()) return;
                setIsAiWorking(true);
                setInfographicData(null); setAiImage(null);
                
                // Enhanced Prompt for structured "Infographic" data
                const prompt = `
                    Konu: "${aiTopic}".
                    Bu konuyu 5 yaşındaki bir çocuğa anlatır gibi ama aynı zamanda bir lise öğrencisinin işine yarayacak kadar bilgi içeren, renkli, eğlenceli ve görsel bir anlatım istiyorum.
                    
                    Bana şu JSON formatında cevap ver:
                    {
                        "title": "Konu Başlığı",
                        "simple_explanation": "Konuyu en basit, hikayeleştirilmiş haliyle anlat (EL5).",
                        "key_points": ["Önemli madde 1 (emojili)", "Önemli madde 2 (emojili)", "Önemli madde 3 (emojili)"],
                        "fun_fact": "Konuyla ilgili şaşırtıcı bir 'Biliyor muydunuz?' bilgisi.",
                        "analogy": "Konuyu gerçek hayattan bir şeye benzet (Metafor/Analoji). Örn: Hücre bir fabrikadır...",
                        "image_prompt": "Vector illustration of ${aiTopic}, educational, colorful, infographic style, minimal background, bright colors"
                    }
                `;

                try {
                    const res = await callGemini(prompt);
                    const data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                    setInfographicData(data);
                    
                    if(data.image_prompt) {
                        // Using pollinations.ai with optimized prompt for infographic feel
                        const encodedPrompt = encodeURIComponent(data.image_prompt + " vector art, flat design, vibrant");
                        setAiImage(`https://image.pollinations.ai/prompt/${encodedPrompt}?width=800&height=600&nologo=true&seed=${Math.random()}`);
                    }
                } catch(e) {
                    alert("İnfografik oluşturulamadı: " + e.message);
                } finally {
                    setIsAiWorking(false);
                }
            };

            // --- OTHER AI FUNCTIONS ---
            const generateStudyPlan = async () => {
                if (!apiKey) { alert("API Anahtarı eksik."); return; }
                setIsGeneratingPlan(true);
                const taskList = tasks.filter(t=>!t.completed).map(t=>t.title).join(", ");
                const prompt = `
                    Öğrenci Profili: ${studyProfile.grade}. sınıf, Zayıf: ${studyProfile.weakSubjects}, Süre: ${studyProfile.hoursPerDay} saat.
                    Mevcut Bekleyen Görevler: ${taskList}.
                    4 bloklu plan (JSON): [{"subject": "...", "topic": "...", "duration": "...", "tip": "..."}]
                `;
                try {
                    const res = await callGemini(prompt);
                    const cleanRes = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    setStudyPlan(JSON.parse(cleanRes));
                } catch (e) { 
                    alert("Plan oluşturulamadı: " + e.message); 
                } finally {
                    setIsGeneratingPlan(false);
                }
            };

            const installPlanToTasks = () => {
                if(!studyPlan) return;
                const newTasks = studyPlan.map(item => ({
                    id: Date.now() + Math.random(),
                    title: `${item.subject}: ${item.topic} (${item.duration}dk)`,
                    completed: false
                }));
                setTasks(prev => [...prev, ...newTasks]);
                handleChatSend("Planı görev listeme ekledim.", true); 
            };

            const breakDownTask = async (taskTitle) => {
                if(!apiKey) { alert("API Anahtarı gerekli"); return; }
                setIsBreakingTask(true);
                try {
                    const res = await callGemini(`"${taskTitle}" görevini 3 parçaya böl. JSON array: ["1", "2", "3"]`);
                    const subTasks = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                    subTasks.forEach(st => setTasks(prev => [...prev, {id: Date.now() + Math.random(), title: st, completed: false}]));
                } catch(e) {} finally {
                    setIsBreakingTask(false);
                }
            };

            const handleGenerateFlashcards = async () => {
                if(!flashcardTopic.trim()) return;
                setIsGeneratingCards(true);
                try {
                    const res = await callGemini(`Konu: "${flashcardTopic}". 5 soru-cevap. JSON: [{"q": "...", "a": "..."}]`);
                    setFlashcards(JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim()));
                    setCurrentCardIndex(0); setIsCardFlipped(false);
                } catch(e) {
                    alert("Kart hatası: " + e.message);
                } finally {
                    setIsGeneratingCards(false);
                }
            };
            
            // --- SOCRATIC TUTOR (AI HOCA) ---
            const startTutorSession = async () => {
                if(!tutorTopic) return;
                setIsTutorThinking(true);
                setTutorMessages([{role: 'system', text: `Sıraya alındı: ${tutorTopic} dersi.`}]);
                
                const prompt = `Konu: "${tutorTopic}". Sokratik hoca ol. Tek bir başlangıç sorusu sor.`;
                try {
                    const res = await callGemini(prompt);
                    setTutorMessages(prev => [...prev, {role: 'ai', text: res}]);
                } catch(e) { 
                    setTutorMessages(prev => [...prev, {role: 'system', text: "Hata oluştu: " + e.message}]);
                } finally {
                    setIsTutorThinking(false);
                }
            };

            const sendTutorReply = async (reply) => {
                setTutorMessages(prev => [...prev, {role: 'user', text: reply}]);
                setIsTutorThinking(true);
                
                const history = tutorMessages.map(m => `${m.role === 'user' ? 'Student' : 'Teacher'}: ${m.text}`).join("\n");
                const prompt = `Geçmiş:\n${history}\nCevap: "${reply}". Değerlendir ve yeni soru sor.`;
                
                try {
                    const res = await callGemini(prompt);
                    setTutorMessages(prev => [...prev, {role: 'ai', text: res}]);
                } catch(e) {
                    setTutorMessages(prev => [...prev, {role: 'system', text: "Bağlantı hatası."}]);
                } finally {
                    setIsTutorThinking(false);
                }
            };

            // --- HELPERS ---
            const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            const themeColor = SEASONS_CONFIG[currentSeason].color; 
            const currentBg = BACKGROUNDS[currentSeason][bgIndex % BACKGROUNDS[currentSeason].length];
            
            // PDF PRINT FUNCTION
            const handlePrint = () => {
                window.print();
            };

            return (
                <div className={`min-h-screen w-full relative text-white font-sans selection:bg-${themeColor}-500 selection:text-white overflow-y-auto custom-scrollbar`}>
                    
                    {/* BACKGROUND LAYER */}
                    <div className="fixed inset-0 z-0 no-print">
                        <div className="absolute inset-0 bg-cover bg-center transition-all duration-1000 transform scale-105" style={{ backgroundImage: `url(${currentBg})` }} />
                        <div className={`absolute inset-0 bg-black/40 backdrop-blur-[2px]`}></div>
                        <div className={`absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/90`}></div>
                    </div>

                    {/* --- DYNAMIC ISLAND TOP BAR --- */}
                    <div className={`fixed top-0 left-0 right-0 z-[100] flex justify-center pt-4 transition-transform duration-500 no-print ${zenMode ? '-translate-y-32' : 'translate-y-0'}`}>
                        <div className={`dynamic-island h-14 rounded-full px-2 flex items-center gap-4 animate-slide-down max-w-3xl w-full mx-4 justify-between pointer-events-auto ${isGlobalVoiceActive ? 'shadow-[0_0_20px_rgba(239,68,68,0.5)] border-red-500/50' : ''}`}>
                             <div className="flex items-center gap-3 pl-2">
                                 {/* VOICE CONTROL TOGGLE */}
                                 <button 
                                    onClick={toggleGlobalVoice} 
                                    className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${isGlobalVoiceActive ? 'bg-red-600 animate-listening' : 'bg-white/10 hover:bg-white/20'}`}
                                    title={isGlobalVoiceActive ? "Sesli Kontrolü Kapat" : "Sesli Kontrolü Başlat"}
                                 >
                                      {isGlobalVoiceActive ? <Mic size={20} className="text-white"/> : <MicOff size={20} className="text-white/50"/>}
                                 </button>
                                 
                                 {/* STATUS TEXT ON ISLAND */}
                                 {isAiProcessing || isProcessingQueue.current ? (
                                     <div className="flex items-center gap-2 text-purple-300 animate-pulse text-sm font-bold">
                                         {queueLength > 0 ? <Activity size={14}/> : <Sparkles size={14}/>} 
                                         {queueLength > 0 ? `Sırada: ${queueLength}` : "Düşünüyor..."}
                                     </div>
                                 ) : voiceFeedback ? (
                                     <div className="text-sm font-medium text-white/90 line-clamp-1 animate-fade-in px-2">
                                         "{voiceFeedback}"
                                     </div>
                                 ) : (
                                     <div className="flex items-center gap-1 overflow-hidden max-w-[200px]">
                                        <div className={`w-8 h-8 rounded-full bg-${themeColor}-600 flex items-center justify-center font-bold text-xs shadow-lg shadow-${themeColor}-500/20 mr-2`}>
                                            {SEASONS_CONFIG[currentSeason].icon && React.createElement(SEASONS_CONFIG[currentSeason].icon, {size:16})}
                                        </div>
                                         {Object.keys(activeSounds).length > 0 ? (
                                             Object.keys(activeSounds).map(id => {
                                                 const s = INTERNAL_SOUNDS.find(sl => sl.id === id);
                                                 return s ? <s.icon key={id} size={14} className="text-white/70 mx-1"/> : null;
                                             })
                                         ) : <span className="text-xs text-white/30 hidden sm:block">Sessiz Mod</span>}
                                         {activeEmbed && <div className="flex items-center gap-1 ml-2 text-green-400 text-xs animate-pulse"><Music size={12}/> Spotify</div>}
                                     </div>
                                 )}
                             </div>

                             <div className="flex items-center gap-2 pr-1">
                                 <button onClick={() => setBgIndex(p => p + 1)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors hidden sm:block" title="Arka Planı Değiştir"><ImageIcon size={18}/></button>
                                 <button onClick={() => setBreathMode(true)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors hidden sm:block" title="Nefes Egzersizi"><Wind size={18}/></button>
                                 <div className="w-[1px] h-6 bg-white/10 mx-1 hidden sm:block"></div>
                                 <button onClick={() => setZenMode(true)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors" title="Zen Modu"><Maximize2 size={18}/></button>
                                 <button onClick={() => setShowSettings(true)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors"><Settings size={18}/></button>
                             </div>
                        </div>
                    </div>

                    {/* --- MAIN CONTENT AREA --- */}
                    <div className={`relative z-10 w-full pt-24 pb-32 px-8 flex justify-center transition-opacity duration-700 ${zenMode ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                        
                        {/* --- TIMER TAB --- */}
                        {activeTab === 'timer' && (
                            <div className="w-full grid grid-cols-1 lg:grid-cols-12 gap-6 h-full max-w-[1600px]">
                                {/* LEFT: Tasks */}
                                <div className="lg:col-span-3 flex flex-col gap-6 animate-slide-up">
                                    <div className="glass-panel rounded-[2rem] p-6 flex flex-col relative overflow-hidden min-h-[400px]">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold flex items-center gap-2 text-lg"><LayoutGrid className={`text-${themeColor}-400`}/> Görevler</h3>
                                            <span className="bg-white/10 px-2 py-0.5 rounded text-xs font-mono">{tasks.filter(t=>!t.completed).length} Aktif</span>
                                        </div>
                                        <form onSubmit={(e)=>{e.preventDefault(); if(newTask) { setTasks([...tasks, {id:Date.now(), title:newTask, completed:false}]); setNewTask(''); }}} className="relative mb-4">
                                            <input value={newTask} onChange={e=>setNewTask(e.target.value)} placeholder="Yeni görev..." className="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-white/30 transition-all text-sm placeholder:text-white/20" />
                                            <button type="submit" className={`absolute right-2 top-2 p-1.5 rounded-lg bg-${themeColor}-500 text-white hover:scale-105 transition-transform`}><Plus size={16}/></button>
                                        </form>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1">
                                            {tasks.map(task => (
                                                <div key={task.id} className="group/item flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/5 transition-all cursor-pointer">
                                                    <button onClick={() => setTasks(tasks.map(t=>t.id===task.id?{...t, completed:!t.completed}:t))} className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all ${task.completed ? 'bg-green-500 border-green-500' : 'border-white/20 hover:border-white/50'}`}>
                                                        {task.completed && <Check size={12} />}
                                                    </button>
                                                    <span className={`flex-1 text-sm ${task.completed ? 'line-through text-white/30' : 'text-white/90'}`}>{task.title}</span>
                                                    {!task.completed && (
                                                        <button onClick={() => breakDownTask(task.title)} disabled={isBreakingTask} className="text-purple-400 hover:text-purple-300 p-1 opacity-50 hover:opacity-100" title="AI ile Parçala">
                                                            {isBreakingTask ? <Loader2 size={14} className="animate-spin"/> : <Split size={14}/>}
                                                        </button>
                                                    )}
                                                    <button onClick={() => setTasks(tasks.filter(t=>t.id!==task.id))} className="opacity-0 group-hover/item:opacity-100 text-red-400 hover:text-red-300 p-1"><Trash2 size={14}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="glass-panel min-h-[200px] rounded-[2rem] p-6 flex flex-col relative group">
                                        <div className="absolute top-4 right-4 text-white/20 group-hover:text-white/50 transition-colors"><StickyNote size={20}/></div>
                                        <h3 className="font-bold text-lg mb-2">Hızlı Notlar</h3>
                                        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} className="flex-1 bg-transparent border-none outline-none resize-none text-sm text-white/80 placeholder:text-white/20 leading-relaxed custom-scrollbar min-h-[150px] font-hand text-lg" placeholder="Buraya not al..."></textarea>
                                    </div>
                                </div>

                                {/* CENTER: Timer */}
                                <div className="lg:col-span-6 flex flex-col items-center justify-start pt-10 relative animate-slide-up min-h-[600px]">
                                    <div className="relative w-[450px] h-[450px] flex items-center justify-center group">
                                        <div className={`absolute inset-0 rounded-full bg-${themeColor}-500/10 blur-[80px] group-hover:bg-${themeColor}-500/20 transition-all duration-1000 animate-pulse`}></div>
                                        <svg className="w-full h-full transform -rotate-90 drop-shadow-2xl">
                                            <circle cx="50%" cy="50%" r="180" stroke="rgba(255,255,255,0.05)" strokeWidth="12" fill="none" />
                                            <circle cx="50%" cy="50%" r="180" stroke="currentColor" strokeWidth="12" fill="none" strokeDasharray={2 * Math.PI * 180} strokeDashoffset={2 * Math.PI * 180 * (1 - timeLeft / (durations[mode] * 60))} strokeLinecap="round" className={`text-${themeColor}-500 transition-all duration-1000 ease-linear`} />
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center z-10">
                                            <div className="flex gap-2 mb-6">
                                                {['focus', 'shortBreak', 'longBreak'].map(m => (
                                                    <button key={m} onClick={() => { setMode(m); setIsActive(false); setTimeLeft(durations[m]*60); }} className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all ${mode === m ? 'bg-white text-black shadow-lg shadow-white/20' : 'bg-black/20 text-white/50 hover:bg-white/10 hover:text-white'}`}>{m === 'focus' ? 'Odak' : m === 'shortBreak' ? 'Kısa' : 'Uzun'}</button>
                                                ))}
                                            </div>
                                            <div className={`text-9xl font-bold font-mono tracking-tighter tabular-nums text-white drop-shadow-2xl select-none ${isActive ? 'animate-float' : ''}`}>{formatTime(timeLeft)}</div>
                                            <p className={`mt-4 text-sm font-medium tracking-[0.3em] uppercase text-${themeColor}-300 opacity-80`}>{isActive ? 'Akıştasınız' : 'Hazır mısınız?'}</p>
                                        </div>
                                        <div className="absolute -bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                                            <button onClick={() => { setIsActive(false); setTimeLeft(durations[mode]*60); }} className="p-4 rounded-2xl glass-panel hover:bg-white/10 active:scale-95 transition-all"><RotateCcw size={24}/></button>
                                            <button onClick={() => setIsActive(!isActive)} className={`h-20 w-24 rounded-3xl bg-${themeColor}-600 flex items-center justify-center shadow-xl shadow-${themeColor}-600/30 hover:scale-105 active:scale-95 transition-all border border-white/10`}>{isActive ? <Pause size={36} fill="white"/> : <Play size={36} fill="white" className="ml-1"/>}</button>
                                            <button onClick={() => setIsCoachOpen(true)} className="p-4 rounded-2xl glass-panel hover:bg-purple-500/20 text-purple-300 active:scale-95 transition-all shadow-purple-500/20 shadow-lg border-purple-500/30"><MessageCircle size={24}/></button>
                                        </div>
                                    </div>
                                </div>

                                {/* RIGHT: Widgets */}
                                <div className="lg:col-span-3 flex flex-col gap-6 animate-slide-up">
                                    <div className="glass-panel p-5 rounded-[2rem] min-h-[180px] relative overflow-hidden group">
                                         <div className="absolute top-0 right-0 p-3 opacity-20"><Target size={40}/></div>
                                         <h3 className="font-bold text-lg mb-3">AI Planı</h3>
                                         {studyPlan ? (
                                             <div className="space-y-3">
                                                 {studyPlan.slice(0, 2).map((item, i) => (
                                                     <div key={i} className="bg-white/5 rounded-xl p-3 border border-white/5">
                                                         <div className="flex justify-between items-start">
                                                             <span className="font-bold text-sm text-purple-300">{item.subject}</span>
                                                             <span className="text-xs bg-white/10 px-1.5 rounded">{item.duration}dk</span>
                                                         </div>
                                                         <p className="text-xs text-white/60 mt-1 line-clamp-1">{item.topic}</p>
                                                     </div>
                                                 ))}
                                                 <button onClick={() => setActiveTab('planner')} className="w-full py-2 text-xs text-white/50 hover:text-white hover:bg-white/5 rounded-lg transition-colors">Detaylar →</button>
                                             </div>
                                         ) : (
                                             <div className="text-center py-4">
                                                 <p className="text-sm text-white/50 mb-3">Günlük planın hazır değil.</p>
                                                 <button onClick={() => setActiveTab('planner')} className="bg-purple-600/80 hover:bg-purple-600 px-4 py-2 rounded-xl text-sm font-bold w-full transition-colors">Oluştur</button>
                                             </div>
                                         )}
                                    </div>
                                    <div className="glass-panel flex-1 rounded-[2rem] p-6 flex flex-col min-h-[300px]">
                                        <h3 className="font-bold flex items-center gap-2 text-lg mb-4"><GraduationCap className={`text-${themeColor}-400`}/> Sınavlar</h3>
                                        <div className="flex gap-2 mb-4">
                                            <input value={newExamTitle} onChange={e=>setNewExamTitle(e.target.value)} placeholder="Sınav Adı" className="flex-1 bg-white/5 rounded-lg px-3 py-2 text-xs outline-none focus:bg-white/10"/>
                                            <input type="date" value={newExamDate} onChange={e=>setNewExamDate(e.target.value)} className="w-24 bg-white/5 rounded-lg px-2 py-2 text-xs outline-none focus:bg-white/10 text-white/70"/>
                                            <button onClick={()=>{if(newExamTitle&&newExamDate){setExams([...exams, {id:Date.now(), title:newExamTitle, date:newExamDate}]); setNewExamTitle('');}}} className={`p-2 rounded-lg bg-${themeColor}-500/50 hover:bg-${themeColor}-500`}><Plus size={14}/></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                            {exams.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(exam => {
                                                const diff = Math.ceil((new Date(exam.date) - new Date()) / (1000 * 60 * 60 * 24));
                                                const isUrgent = diff <= 3 && diff >= 0;
                                                return (
                                                    <div key={exam.id} className={`flex items-center justify-between p-3 rounded-xl border ${isUrgent ? 'bg-red-500/20 border-red-500/30' : 'bg-white/5 border-white/5'} hover:border-white/20`}>
                                                        <div><div className="font-medium text-sm">{exam.title}</div><div className={`text-[10px] ${isUrgent?'text-red-300':'text-white/40'}`}>{new Date(exam.date).toLocaleDateString('tr-TR')}</div></div>
                                                        <div className="flex items-center gap-2"><span className={`text-xs font-bold px-2 py-1 rounded ${isUrgent ? 'bg-red-500 text-white' : 'bg-white/10 text-white/70'}`}>{diff < 0 ? 'Geçti' : diff === 0 ? 'Bugün' : `${diff} Gün`}</span><button onClick={() => setExams(exams.filter(e=>e.id!==exam.id))} className="text-white/20 hover:text-white"><X size={12}/></button></div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- AI VISUAL LEARNER TAB (UPDATED) --- */}
                        {activeTab === 'ai_study' && (
                            <div className="w-full max-w-6xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] flex flex-col min-h-[600px] no-print">
                                    <h2 className="text-3xl font-bold flex items-center gap-3 mb-6"><Brain className="text-pink-400"/> AI Görsel Öğrenme İstasyonu</h2>
                                    <div className="flex gap-4 mb-8">
                                        <input value={aiTopic} onChange={e=>setAiTopic(e.target.value)} placeholder="Hangi konuda poster hazırlayayım? (Örn: Fotosentez)" className="flex-1 bg-white/5 border border-white/10 rounded-xl px-6 py-4 text-lg outline-none focus:border-pink-500 transition-colors"/>
                                        <button onClick={generateAiInfographic} disabled={isAiWorking} className="bg-pink-600 hover:bg-pink-500 px-8 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 text-lg transition-transform hover:scale-105">
                                            {isAiWorking ? <Loader2 className="animate-spin"/> : <Sparkles/>} Posteri Hazırla
                                        </button>
                                    </div>
                                </div>

                                {/* THE INFOGRAPHIC PRINT AREA */}
                                {infographicData && (
                                    <div id="printable-area" className="w-full bg-white text-black p-8 rounded-[2rem] shadow-2xl animate-pop border-8 border-white">
                                        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                            {/* Header */}
                                            <div className="md:col-span-12 flex justify-between items-center border-b-4 border-black pb-4 mb-4">
                                                <div>
                                                    <h1 className="text-5xl font-black uppercase tracking-tighter text-black">{infographicData.title}</h1>
                                                    <p className="text-xl font-medium text-gray-600 mt-2 font-hand">Pomodoro OS ile Hazırlandı</p>
                                                </div>
                                                <div className="hidden md:block">
                                                    <div className="bg-black text-white px-6 py-2 rounded-full font-bold text-xl transform -rotate-2">
                                                        AI DERS NOTU
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Left Column: Image & Explanation */}
                                            <div className="md:col-span-7 space-y-6">
                                                {/* Hero Image */}
                                                <div className="w-full h-80 bg-gray-100 rounded-3xl border-4 border-black overflow-hidden relative shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    {aiImage ? (
                                                        <img src={aiImage} alt="Topic Visual" className="w-full h-full object-cover"/>
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center bg-yellow-100 text-yellow-800">
                                                            <ImageIcon size={64}/>
                                                            <span className="ml-2 font-bold">Görsel Hazırlanıyor...</span>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Simple Explanation (EL5) */}
                                                <div className="bg-blue-100 p-6 rounded-3xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    <h3 className="font-black text-2xl mb-3 flex items-center gap-2"><User size={28}/> 5 Yaşındaki Halime Anlat</h3>
                                                    <p className="text-xl leading-relaxed font-medium text-gray-800">{infographicData.simple_explanation}</p>
                                                </div>

                                                {/* Analogy */}
                                                <div className="bg-yellow-100 p-6 rounded-3xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    <h3 className="font-black text-2xl mb-3 flex items-center gap-2"><Lightbulb size={28}/> Akılda Tutma Kancası (Analoji)</h3>
                                                    <p className="text-xl italic font-serif text-gray-800 border-l-4 border-yellow-500 pl-4">
                                                        "{infographicData.analogy}"
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Right Column: Key Points & Fun Fact */}
                                            <div className="md:col-span-5 space-y-6">
                                                {/* Key Points */}
                                                <div className="bg-green-100 p-6 rounded-3xl border-4 border-black h-auto shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    <h3 className="font-black text-2xl mb-4 flex items-center gap-2"><Check size={28}/> Anahtar Bilgiler</h3>
                                                    <ul className="space-y-4">
                                                        {infographicData.key_points.map((point, i) => (
                                                            <li key={i} className="flex items-start gap-3 text-lg font-bold text-gray-800">
                                                                <span className="bg-black text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-sm">{i+1}</span>
                                                                {point}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>

                                                {/* Fun Fact */}
                                                <div className="bg-pink-100 p-6 rounded-3xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transform rotate-1">
                                                    <h3 className="font-black text-2xl mb-3 flex items-center gap-2"><Sparkles size={28}/> Biliyor Muydun?</h3>
                                                    <p className="text-lg font-hand font-bold text-pink-900">
                                                        {infographicData.fun_fact}
                                                    </p>
                                                </div>
                                                
                                                {/* QR / Footer */}
                                                <div className="mt-auto pt-4 text-center opacity-50 text-sm font-mono">
                                                    Generated by Pomodoro OS AI<br/>
                                                    {new Date().toLocaleDateString()}
                                                </div>
                                            </div>
                                        </div>

                                        {/* ACTION BUTTONS (Hidden when printing) */}
                                        <div className="no-print mt-8 flex justify-center gap-4">
                                            <button onClick={handlePrint} className="bg-white text-black px-8 py-3 rounded-xl font-bold text-lg flex items-center gap-2 hover:bg-gray-200 transition-colors shadow-lg">
                                                <Printer/> PDF / Yazdır
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* --- AI PLANNER TAB --- */}
                        {activeTab === 'planner' && (
                            <div className="w-full max-w-4xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] flex flex-col min-h-[600px]">
                                    <h2 className="text-3xl font-bold flex items-center gap-3 mb-6"><Target className="text-purple-400"/> AI Çalışma Planlayıcısı</h2>
                                    {!studyPlan ? (
                                        <div className="flex-1 flex flex-col items-center justify-center max-w-lg mx-auto w-full space-y-4">
                                            <p className="text-white/60 text-center mb-4">Gemini AI ile kişiselleştirilmiş program oluştur.</p>
                                            <input value={studyProfile.grade} onChange={e=>setStudyProfile({...studyProfile, grade:e.target.value})} placeholder="Kaçıncı sınıfsın? (Örn: 12)" className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-purple-500 transition-colors"/>
                                            <input value={studyProfile.weakSubjects} onChange={e=>setStudyProfile({...studyProfile, weakSubjects:e.target.value})} placeholder="Zayıf olduğun dersler?" className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-purple-500 transition-colors"/>
                                            <div className="w-full">
                                                <label className="text-xs text-white/40 ml-1">Günlük Çalışma Saati: {studyProfile.hoursPerDay}</label>
                                                <input type="range" min="1" max="10" value={studyProfile.hoursPerDay} onChange={e=>setStudyProfile({...studyProfile, hoursPerDay:e.target.value})} className="w-full mt-2"/>
                                            </div>
                                            <button onClick={generateStudyPlan} disabled={isGeneratingPlan} className="w-full bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 mt-4 disabled:opacity-50 transition-all">
                                                {isGeneratingPlan ? <Loader2 className="animate-spin"/> : <Sparkles/>} Programı Oluştur
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-xl font-semibold">Bugünün Programı</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={installPlanToTasks} className="bg-green-600 hover:bg-green-500 px-4 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2"><Check size={14}/> Görevlere Ekle</button>
                                                    <button onClick={()=>setStudyPlan(null)} className="text-xs text-white/40 hover:text-white border border-white/10 px-3 py-1 rounded-full">Yeniden Oluştur</button>
                                                </div>
                                            </div>
                                            <div className="grid gap-4">
                                                {studyPlan.map((item, i) => (
                                                    <div key={i} className="glass-panel bg-white/5 p-4 rounded-xl flex items-center gap-4 hover:bg-white/10 transition-colors">
                                                        <div className="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-300 font-bold">{i+1}</div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between">
                                                                <h4 className="font-bold text-lg">{item.subject}</h4>
                                                                <span className="text-xs bg-white/20 px-2 py-1 rounded">{item.duration} dk</span>
                                                            </div>
                                                            <p className="text-white/70 text-sm">{item.topic}</p>
                                                            <p className="text-white/40 text-xs mt-1 italic">💡 {item.tip}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* --- SOCRATIC TUTOR TAB --- */}
                        {activeTab === 'tutor' && (
                            <div className="w-full max-w-4xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-0 rounded-[2rem] flex flex-col h-[600px] overflow-hidden">
                                    <div className="p-6 bg-gradient-to-r from-blue-900/30 to-purple-900/30 border-b border-white/10 flex justify-between items-center">
                                        <h2 className="text-2xl font-bold flex items-center gap-3"><Brain className="text-blue-400"/> Sokratik AI Hoca</h2>
                                        {tutorMessages.length > 0 && <button onClick={()=>{setTutorMessages([]); setTutorTopic('');}} className="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full">Dersi Bitir</button>}
                                    </div>
                                    
                                    {tutorMessages.length === 0 ? (
                                        <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-4">
                                            <div className="w-20 h-20 rounded-full bg-blue-500/20 flex items-center justify-center mb-2"><GraduationCap size={40} className="text-blue-300"/></div>
                                            <h3 className="text-xl font-bold">Özel Ders Başlasın</h3>
                                            <p className="text-white/50 text-center max-w-md">Konuyu yaz, AI seni sınasın, eksiklerini bulsun ve öğretsin.</p>
                                            <div className="flex w-full max-w-md gap-2">
                                                <input value={tutorTopic} onChange={e=>setTutorTopic(e.target.value)} placeholder="Örn: Limit ve Türev" className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none"/>
                                                <button onClick={startTutorSession} disabled={!tutorTopic || isTutorThinking} className="bg-blue-600 hover:bg-blue-500 px-6 rounded-xl font-bold">Başla</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <>
                                            <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-black/20">
                                                {tutorMessages.map((msg, i) => (
                                                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                        <div className={`max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white/10 border border-white/5 text-gray-200 rounded-bl-none'}`}>
                                                            {msg.role === 'system' ? <span className="italic opacity-70">{msg.text}</span> : msg.text}
                                                        </div>
                                                    </div>
                                                ))}
                                                {isTutorThinking && <div className="flex justify-start"><div className="bg-white/10 p-4 rounded-2xl rounded-bl-none"><Loader2 className="animate-spin" size={16}/></div></div>}
                                                <div ref={tutorEndRef}></div>
                                            </div>
                                            <div className="p-4 bg-black/40 border-t border-white/10">
                                                <form onSubmit={(e)=>{e.preventDefault(); const val=e.target.elements.reply.value; if(val){sendTutorReply(val); e.target.elements.reply.value='';}}} className="flex gap-2">
                                                    <input name="reply" placeholder="Cevabını yaz..." className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-blue-500 transition-colors" autoComplete="off"/>
                                                    <button type="submit" disabled={isTutorThinking} className="p-3 bg-blue-600 rounded-xl hover:bg-blue-500 disabled:opacity-50"><Send size={20}/></button>
                                                </form>
                                            </div>
                                        </>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- MIXER TAB --- */}
                        {activeTab === 'mixer' && (
                            <div className="w-full max-w-6xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">
                                    <div className="lg:col-span-4 glass-panel p-6 rounded-[2rem] flex flex-col min-h-[500px]">
                                        <div className="flex justify-between items-center mb-6">
                                            <h3 className="font-bold flex items-center gap-2 text-xl"><Music className="text-pink-400"/> Dahili Ses Motoru</h3>
                                            <button onClick={stopAllSounds} className="text-xs bg-red-500/20 hover:bg-red-500 text-red-200 px-3 py-1 rounded-full transition-colors">Tümünü Durdur</button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar grid grid-cols-1 gap-3 pb-4">
                                            {INTERNAL_SOUNDS.map(sound => (
                                                <div key={sound.id} className={`p-3 rounded-xl border transition-all ${activeSounds[sound.id] ? 'bg-white/10 border-white/30' : 'bg-transparent border-white/5 hover:bg-white/5'}`}>
                                                    <div className="flex items-center justify-between mb-2 cursor-pointer" onClick={() => toggleInternalSound(sound.id, sound.type)}>
                                                        <div className="flex items-center gap-3">
                                                            <sound.icon size={20} className={activeSounds[sound.id] ? `text-${themeColor}-400` : 'text-white/40'}/>
                                                            <span className="text-sm font-medium">{sound.label}</span>
                                                        </div>
                                                        <div className={`w-3 h-3 rounded-full ${activeSounds[sound.id] ? 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.5)]' : 'bg-white/10'}`}></div>
                                                    </div>
                                                    {activeSounds[sound.id] !== undefined && (
                                                        <input type="range" min="0" max="1" step="0.05" value={activeSounds[sound.id]} onChange={(e) => updateInternalVolume(sound.id, e.target.value)} className="w-full h-1"/>
                                                    )}
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="lg:col-span-8 flex flex-col gap-6">
                                        <div className="glass-panel p-0 rounded-[2rem] flex-1 overflow-hidden relative bg-black/50 border border-white/10 flex items-center justify-center min-h-[350px]">
                                            {activeEmbed ? (
                                                <div className="w-full h-full flex flex-col items-center justify-center">
                                                    <p className="text-white/50 text-sm mb-2">Spotify şu an global oynatıcıda aktif</p>
                                                    <div className="w-32 h-32 rounded-full bg-green-500/20 flex items-center justify-center animate-pulse-slow">
                                                        <Music size={48} className="text-green-500"/>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="text-center text-white/30 flex flex-col items-center">
                                                    <Monitor size={64} className="mb-4 opacity-50"/>
                                                    <p>Spotify listesi seç veya sesleri karıştır.</p>
                                                </div>
                                            )}
                                        </div>
                                        <div className="glass-panel p-6 rounded-[2rem]">
                                            <h3 className="font-bold flex items-center gap-2 text-md mb-4 text-white/60 uppercase tracking-widest">Spotify İstasyonları</h3>
                                            <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                                {MEDIA_PRESETS.map(preset => (
                                                    <button key={preset.id} onClick={() => setActiveEmbed(preset)} className={`p-3 rounded-xl flex flex-col items-center justify-center gap-2 transition-all border ${activeEmbed?.id === preset.id ? 'bg-white/20 border-white/50 scale-105' : 'bg-white/5 border-white/5 hover:bg-white/10'}`}>
                                                        <preset.icon size={24} className={activeEmbed?.id === preset.id ? 'text-[#1DB954]' : 'text-white/50'}/>
                                                        <span className="text-xs font-bold text-center">{preset.label}</span>
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- STATS TAB --- */}
                        {activeTab === 'stats' && (
                            <div className="w-full max-w-4xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] flex flex-col min-h-[600px]">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-3xl font-bold flex items-center gap-2"><BarChart2 className="text-blue-400"/> Çalışma Kayıtları</h2>
                                        <button onClick={() => window.print()} className="flex items-center gap-2 bg-white text-black px-4 py-2 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                                            <Printer size={18}/> Raporu Yazdır / PDF
                                        </button>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                        <div className="bg-white/5 rounded-2xl p-6 border border-white/5">
                                            <div className="text-white/40 text-sm mb-1">Toplam Oturum</div>
                                            <div className="text-4xl font-bold">{stats.length}</div>
                                        </div>
                                        <div className="bg-white/5 rounded-2xl p-6 border border-white/5">
                                            <div className="text-white/40 text-sm mb-1">Toplam Süre</div>
                                            <div className="text-4xl font-bold text-green-400">{stats.reduce((a,b) => a + (b.duration||25), 0)} dk</div>
                                        </div>
                                        <div className="bg-white/5 rounded-2xl p-6 border border-white/5">
                                            <div className="text-white/40 text-sm mb-1">Son Çalışma</div>
                                            <div className="text-lg font-bold">{stats.length > 0 ? stats[stats.length-1].date : '-'}</div>
                                        </div>
                                    </div>
                                    <div id="printable-area" className="flex-1 bg-white/5 rounded-2xl overflow-hidden">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="bg-white/10 text-white/60 text-sm uppercase">
                                                    <th className="p-4">Tarih</th>
                                                    <th className="p-4">Oturum Tipi</th>
                                                    <th className="p-4">Süre (Dk)</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-white/5">
                                                {stats.length > 0 ? [...stats].reverse().map((stat, i) => (
                                                    <tr key={i} className="hover:bg-white/5">
                                                        <td className="p-4 text-white/80">{stat.date}</td>
                                                        <td className="p-4 text-white/80">Pomodoro Focus</td>
                                                        <td className="p-4 font-mono text-green-300">{stat.duration || 25}</td>
                                                    </tr>
                                                )) : (
                                                    <tr><td colSpan="3" className="p-8 text-center text-white/30">Henüz kayıt yok.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- FLASHCARDS TAB --- */}
                        {activeTab === 'flashcards' && (
                            <div className="w-full max-w-4xl flex flex-col animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] h-full flex flex-col items-center min-h-[600px]">
                                    <div className="w-full flex justify-between items-center mb-8">
                                        <h2 className="text-3xl font-bold flex items-center gap-2"><Layers className="text-purple-400"/> AI Bilgi Kartları</h2>
                                        <div className="flex gap-2">
                                            <input value={flashcardTopic} onChange={e=>setFlashcardTopic(e.target.value)} placeholder="Örn: Mitoz Bölünme" className="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none w-64"/>
                                            <button onClick={handleGenerateFlashcards} disabled={isGeneratingCards} className="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50">
                                                {isGeneratingCards ? <Loader2 className="animate-spin" size={18}/> : <Wand2 size={18}/>} Oluştur
                                            </button>
                                        </div>
                                    </div>
                                    {flashcards.length > 0 ? (
                                        <div className="flex-1 flex flex-col items-center justify-center w-full max-w-2xl">
                                            <div className="perspective-1000 w-full h-80 cursor-pointer" onClick={() => setIsCardFlipped(!isCardFlipped)}>
                                                <div className={`relative w-full h-full text-center transition-transform duration-700 transform-style-3d ${isCardFlipped ? 'rotate-y-180' : ''}`}>
                                                    <div className="absolute inset-0 backface-hidden glass-panel rounded-3xl flex items-center justify-center p-8 border-2 border-white/5 bg-[#1a1a1a]">
                                                        <div>
                                                            <div className="text-xs uppercase tracking-widest text-purple-400 mb-4">Soru {currentCardIndex + 1}/{flashcards.length}</div>
                                                            <div className="text-2xl font-bold leading-relaxed">{flashcards[currentCardIndex].q}</div>
                                                        </div>
                                                    </div>
                                                    <div className="absolute inset-0 backface-hidden glass-panel rounded-3xl flex items-center justify-center p-8 border-2 border-purple-500/30 bg-purple-900/20 rotate-y-180">
                                                        <div>
                                                            <div className="text-xs uppercase tracking-widest text-green-400 mb-4">Cevap</div>
                                                            <div className="text-xl leading-relaxed">{flashcards[currentCardIndex].a}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-8 mt-8">
                                                <button onClick={() => { setCurrentCardIndex(p => Math.max(0, p - 1)); setIsCardFlipped(false); }} disabled={currentCardIndex === 0} className="p-4 rounded-full glass-panel hover:bg-white/10 disabled:opacity-30"><ChevronLeft size={24}/></button>
                                                <button onClick={() => setIsCardFlipped(!isCardFlipped)} className="flex items-center gap-2 text-white/50 hover:text-white"><RefreshCw size={16}/> Çevir</button>
                                                <button onClick={() => { setCurrentCardIndex(p => Math.min(flashcards.length - 1, p + 1)); setIsCardFlipped(false); }} disabled={currentCardIndex === flashcards.length - 1} className="p-4 rounded-full glass-panel hover:bg-white/10 disabled:opacity-30"><ChevronRight size={24}/></button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex flex-col items-center justify-center text-white/30">
                                            <Layers size={64} className="mb-4 opacity-50"/>
                                            <p>Konu yaz ve yapay zekanın senin için çalışma kartları hazırlamasını bekle.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* --- GLOBAL MEDIA PLAYER --- */}
                    {activeEmbed && (
                        <div className="fixed bottom-24 right-8 w-80 h-24 shadow-2xl rounded-2xl overflow-hidden glass-panel border-t border-white/20 z-50 animate-slide-up group no-print">
                            <iframe 
                                style={{borderRadius: "0px"}} 
                                src={`https://open.spotify.com/embed/${activeEmbed.link}?utm_source=generator&theme=0`} 
                                width="100%" 
                                height="100%" 
                                frameBorder="0" 
                                allowFullScreen="" 
                                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                                loading="lazy"
                            ></iframe>
                            <button onClick={() => setActiveEmbed(null)} className="absolute top-1 right-1 bg-black/80 hover:bg-red-500 text-white p-1 rounded-full transition-colors opacity-0 group-hover:opacity-100"><X size={12}/></button>
                        </div>
                    )}

                    {/* --- AI COACH CHAT (SESLİ KOMUT SİSTEMİ) --- */}
                    {isCoachOpen && (
                        <div className="fixed bottom-24 right-8 w-96 h-[500px] glass-panel rounded-3xl flex flex-col border border-white/10 shadow-2xl z-50 animate-slide-up bg-[#0a0a0a]/90 no-print">
                            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-purple-900/30 to-blue-900/30">
                                <h3 className="font-bold flex items-center gap-2 text-purple-300"><Sparkles size={16}/> AI Öğrenci Koçu</h3>
                                <div className="flex gap-2">
                                    <button onClick={() => setVoiceEnabled(!voiceEnabled)} className={`p-1.5 rounded-lg ${voiceEnabled ? 'bg-white/20 text-white' : 'text-white/30'}`} title="Sesli Yanıt">{voiceEnabled ? <Volume2 size={16}/> : <VolumeX size={16}/>}</button>
                                    <button onClick={() => setIsCoachOpen(false)} className="hover:bg-white/10 p-1.5 rounded-full"><X size={18}/></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                                {chatMessages.map((msg, i) => (
                                    msg.role !== 'system' && (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-[#1a1a1a] border border-white/10 text-gray-200 rounded-bl-none'}`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    )
                                ))}
                                {isAiProcessing && (
                                    <div className="flex justify-start ml-2">
                                        <div className="bg-[#1a1a1a] border border-white/10 p-3 rounded-2xl rounded-bl-none flex gap-1">
                                            <div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={chatEndRef}></div>
                            </div>
                            
                            {/* Input Area */}
                            <div className="p-3 border-t border-white/10 bg-black/40">
                                <div className="flex gap-2">
                                    <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleChatSend()} placeholder="Bir şeyler sor veya komut ver..." className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 transition-colors" disabled={isAiProcessing} />
                                    <button onClick={() => handleChatSend()} disabled={isAiProcessing} className="p-2 bg-purple-600 rounded-xl hover:bg-purple-500 disabled:opacity-50"><Send size={18}/></button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- SETTINGS MODAL --- */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                            <div className="glass-panel w-full max-w-md rounded-3xl p-6 bg-[#0f0f0f] border border-white/10 shadow-2xl animate-fade-in">
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="text-white/50"/> Ayarlar</h2>
                                    <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-white/10 rounded-full"><X size={20}/></button>
                                </div>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-xs font-bold text-white/40 uppercase mb-3 block">Mevsim Modu</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <select value={currentSeason} onChange={e=>setCurrentSeason(e.target.value)} className="bg-black/40 border border-white/10 rounded-xl px-3 text-sm outline-none w-full py-2">
                                                {Object.entries(SEASONS_CONFIG).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-white/40 uppercase mb-2 block">Pomodoro Süreleri (dk)</label>
                                        <div className="grid grid-cols-3 gap-3">
                                            {Object.entries(durations).map(([k, v]) => (
                                                <input key={k} type="number" value={v} onChange={e => setDurations({...durations, [k]: parseInt(e.target.value)||1})} className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-center outline-none focus:bg-white/10" placeholder={k} />
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-purple-400 uppercase mb-2 block flex items-center gap-2"><Key size={12}/> Gemini API Anahtarı</label>
                                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AI_zaSy..." className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none" />
                                    </div>
                                </div>
                                <button onClick={() => { setTimeLeft(durations[mode]*60); setShowSettings(false); }} className="w-full mt-6 bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Kaydet</button>
                            </div>
                        </div>
                    )}

                    {/* --- DOCK NAVIGATION --- */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 no-print">
                        <div className="glass-panel p-2 rounded-2xl flex items-center gap-2 shadow-2xl shadow-black/50 border border-white/20">
                            <button onClick={() => setActiveTab('mixer')} className={`p-3 rounded-xl transition-all ${activeTab === 'mixer' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Ses Mikseri"><Music size={24}/></button>
                            <button onClick={() => setActiveTab('timer')} className={`p-4 rounded-xl transition-all mx-2 ${activeTab === 'timer' ? `bg-${themeColor}-500 text-white shadow-lg shadow-${themeColor}-500/50 scale-110 -translate-y-4` : 'text-white/60 hover:bg-white/10'}`} title="Odaklan"><Clock size={28} fill={activeTab==='timer'?"currentColor":"none"} /></button>
                            <button onClick={() => setActiveTab('ai_study')} className={`p-3 rounded-xl transition-all ${activeTab === 'ai_study' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="AI Görsel Öğrenme"><ImageIcon size={24}/></button>
                            <button onClick={() => setActiveTab('planner')} className={`p-3 rounded-xl transition-all ${activeTab === 'planner' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="AI Planlayıcı"><Target size={24}/></button>
                            <button onClick={() => setActiveTab('tutor')} className={`p-3 rounded-xl transition-all ${activeTab === 'tutor' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Sokratik Hoca"><GraduationCap size={24}/></button>
                            <button onClick={() => setActiveTab('flashcards')} className={`p-3 rounded-xl transition-all ${activeTab === 'flashcards' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Kartlar"><Layers size={24}/></button>
                            <button onClick={() => setActiveTab('stats')} className={`p-3 rounded-xl transition-all ${activeTab === 'stats' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Kayıtlar"><BarChart2 size={24}/></button>
                        </div>
                    </div>

                    {/* ZEN MODE */}
                    {zenMode && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center">
                            <div className="text-center animate-fade-in group">
                                <div className="text-[12rem] font-bold font-mono tracking-tighter text-white drop-shadow-2xl select-none">
                                    {formatTime(timeLeft)}
                                </div>
                                <button onClick={() => setZenMode(false)} className="text-white/30 hover:text-white transition-colors flex items-center gap-2 mx-auto text-sm uppercase tracking-widest border border-white/10 px-6 py-2 rounded-full hover:bg-white/5 opacity-0 group-hover:opacity-100 duration-300">
                                    <Minimize2 size={16}/> Çıkış
                                </button>
                            </div>
                        </div>
                    )}

                    {/* BREATH MODE */}
                    {breathMode && (
                        <div className="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center backdrop-blur-xl animate-fade-in" onClick={()=>setBreathMode(false)}>
                            <div className="text-center">
                                <div className="w-64 h-64 bg-blue-400/20 rounded-full flex items-center justify-center animate-breathe relative">
                                    <div className="w-48 h-48 bg-blue-400/40 rounded-full absolute animate-pulse"></div>
                                    <div className="text-2xl font-bold text-blue-200 animate-pulse-slow">Nefes Al... Ver...</div>
                                </div>
                                <p className="mt-8 text-white/50 text-sm">Ekrana tıklayarak çık</p>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>