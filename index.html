<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pomodoro OS v7.0 - Visual Learner</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'blob': 'blob 10s infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'breathe': 'breathe 4s ease-in-out infinite',
                        'slide-down': 'slideDown 0.5s ease-out',
                        'slide-up': 'slideUp 0.5s ease-out',
                        'fade-in': 'fadeIn 0.5s ease-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'listening': 'listening 1.5s ease-in-out infinite',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-100%)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        listening: {
                            '0%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0.7)' },
                            '70%': { boxShadow: '0 0 0 10px rgba(239, 68, 68, 0)' },
                            '100%': { boxShadow: '0 0 0 0 rgba(239, 68, 68, 0)' },
                        },
                        pop: {
                            '0%': { transform: 'scale(0.9)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <!-- React Import Map -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.263.1"
        }
    }
    </script>

    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&family=Patrick+Hand&display=swap');

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }
        
        .glass-panel { 
            background: rgba(18, 18, 18, 0.75); 
            backdrop-filter: blur(24px); 
            -webkit-backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); 
        }
        
        .dynamic-island {
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 10px 40px rgba(0,0,0,0.6);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        body { margin: 0; font-family: 'Outfit', sans-serif; background: #000; overflow-x: hidden; }
        
        /* Font for "Handwritten" notes */
        .font-hand { font-family: 'Patrick Hand', cursive; }

        input[type=range] {
            -webkit-appearance: none; 
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px; 
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 2px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        /* --- PRINT STYLES FOR INFOGRAPHICS --- */
        @media print {
            body * { visibility: hidden; }
            #printable-area, #printable-area * { 
                visibility: visible; 
            }
            #printable-area { 
                position: fixed; 
                left: 0; 
                top: 0; 
                width: 100%; 
                height: 100%;
                margin: 0;
                padding: 20px;
                background: white !important; 
                color: black !important;
                z-index: 9999;
                overflow: visible;
                display: block !important;
            }
            
            /* Ensure colors print correctly */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            /* Hide UI elements inside the printable area if needed */
            .no-print { display: none !important; }
            
            /* Typography adjustments for print */
            h1, h2, h3 { color: #000 !important; }
            p { color: #333 !important; }
            .bg-slate-900 { background-color: #f0f0f0 !important; }
            .text-white { color: #000 !important; }
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            background-color: currentColor;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    
        /* --- TEKNOFEST PACK: Accessibility --- */
        .hc { filter: contrast(1.25) saturate(1.1); }
        .hc .glass-panel { border-color: rgba(255,255,255,0.25) !important; background: rgba(0,0,0,0.55) !important; }
        .dys { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; letter-spacing: 0.02em; }
        .dys * { font-variant-ligatures: none; }
</style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import {
            Play,
            Pause,
            RotateCcw,
            Plus,
            Trash2,
            Check,
            Settings,
            X,
            Camera,
            Volume2,
            VolumeX,
            BarChart2,
            Moon,
            Sun,
            Image as ImageIcon,
            CloudRain,
            Waves,
            Coffee,
            Flame,
            Trees,
            Calendar,
            User,
            Zap,
            LayoutGrid,
            Sparkles,
            Loader2,
            Key,
            MessageCircle,
            Send,
            Wand2,
            Target,
            Trophy,
            Library,
            Wind,
            Keyboard,
            BookOpen,
            Clock,
            Maximize2,
            Minimize2,
            StickyNote,
            GraduationCap,
            Layers,
            Radio,
            ChevronRight,
            ChevronLeft,
            RefreshCw,
            Music,
            Headphones,
            Cloud,
            Umbrella,
            Leaf,
            Snowflake,
            SunDim,
            Upload,
            Youtube,
            Lightbulb,
            Palette,
            Monitor,
            Printer,
            PieChart,
            Split,
            Brain,
            FileText,
            Heart,
            Mic,
            MicOff,
            Speaker,
            Gamepad2,
            Command,
            Activity,
            Share2,
            Gauge,
            Download,
            Star,
            ListMusic
        } from 'lucide-react';

        // --- EXPANDED BACKGROUNDS ---
        const BACKGROUNDS = {
            spring: ["https://images.unsplash.com/photo-1490750967868-58cb75069ed6?q=80&w=2600"],
            summer: ["https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2600"],
            autumn: ["https://images.unsplash.com/photo-1509565840034-3c385bed64f3?q=80&w=2600"],
            winter: ["https://images.unsplash.com/photo-1483729558449-99ef09a8c325?q=80&w=2600"],
            cyber: ["https://images.unsplash.com/photo-1515630278258-407f66498911?q=80&w=2600"],
            space: ["https://images.unsplash.com/photo-1451187580459-43490279c0fa?q=80&w=2600"]
        };

        const SEASONS_CONFIG = {
            spring: { label: 'İlkbahar', icon: Leaf, color: 'emerald' },
            summer: { label: 'Yaz', icon: SunDim, color: 'yellow' },
            autumn: { label: 'Sonbahar', icon: Wind, color: 'orange' },
            winter: { label: 'Kış', icon: Snowflake, color: 'blue' },
            cyber: { label: 'Cyberpunk', icon: Zap, color: 'purple' },
            space: { label: 'Uzay', icon: Moon, color: 'indigo' }
        };

        const INTERNAL_SOUNDS = [
            { id: 'rain', label: 'Yağmur (Pink Noise)', icon: CloudRain, type: 'pink' },
            { id: 'wind', label: 'Rüzgar (Brown Noise)', icon: Wind, type: 'brown' },
            { id: 'focus', label: 'Odak (White Noise)', icon: Radio, type: 'white' },
        ];

        const MEDIA_PRESETS = [
            { id: 'spotify_focus', type: 'spotify', label: 'Deep Focus', icon: Headphones, link: 'playlist/37i9dQZF1DWZeKCadgRdKQ' },
            { id: 'spotify_piano', type: 'spotify', label: 'Peaceful Piano', icon: Music, link: 'playlist/37i9dQZF1DX4sWSpwq3LiO' },
            { id: 'spotify_lofi', type: 'spotify', label: 'Lofi Beats', icon: Coffee, link: 'playlist/37i9dQZF1DWWQRwui0ExPn' },
            { id: 'spotify_rain', type: 'spotify', label: 'Yağmurlu Gün', icon: CloudRain, link: 'playlist/37i9dQZF1DX2pSTOxoPbx9' },
            { id: 'spotify_jazz', type: 'spotify', label: 'Jazz Vibes', icon: Wind, link: 'playlist/37i9dQZF1DXbITWG1ZJK8t' }
        ];

        
        // --- TEKNOFEST AI CORE (Impact+Focus+DNA) ---
        // Not: Kamera tabanlı göz/poz analizi için harici ML gerekir. Bu çekirdek motor,
        // kamera olmadan da (gizlilik-öncelikli) güçlü odak analizi yapar.

        const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
        const safeJsonParse = (s, fallback) => { try { return JSON.parse(s); } catch { return fallback; } };

        // Focus Engine: Çok-kanallı odak skoru (0..100)
        const useFocusEngine = ({ enabled, samplingMs = 5000 }) => {
            const [focusScore, setFocusScore] = useState(85);
            const [focusLabel, setFocusLabel] = useState('İyi');
            const [signals, setSignals] = useState({ visibility: true, idleSec: 0, events5s: 0, keys5s: 0, typingCV: 0, tabLeaves: 0 });

            const evCounter = useRef({ total: 0, keys: 0, keyIntervals: [] });
            const lastKeyTs = useRef(null);
            const lastEventTs = useRef(Date.now());
            const tabLeaves = useRef(0);

            useEffect(() => {
                if (!enabled) return;

                const onAnyActivity = () => { evCounter.current.total += 1; lastEventTs.current = Date.now(); };
                const onKey = () => {
                    evCounter.current.keys += 1;
                    const t = Date.now();
                    if (lastKeyTs.current) {
                        const dt = t - lastKeyTs.current;
                        if (dt > 20 && dt < 3000) {
                            evCounter.current.keyIntervals.push(dt);
                            if (evCounter.current.keyIntervals.length > 40) evCounter.current.keyIntervals.shift();
                        }
                    }
                    lastKeyTs.current = t;
                    lastEventTs.current = t;
                };
                const onVisibility = () => { if (document.hidden) tabLeaves.current += 1; };

                window.addEventListener('mousemove', onAnyActivity, { passive: true });
                window.addEventListener('mousedown', onAnyActivity, { passive: true });
                window.addEventListener('scroll', onAnyActivity, { passive: true });
                window.addEventListener('touchstart', onAnyActivity, { passive: true });
                window.addEventListener('keydown', onKey);
                document.addEventListener('visibilitychange', onVisibility);

                const tick = setInterval(() => {
                    const vis = !document.hidden;
                    const idleSec = Math.floor((Date.now() - lastEventTs.current) / 1000);
                    const events5s = evCounter.current.total;
                    const keys5s = evCounter.current.keys;

                    // Typing rhythm stability: coefficient of variation
                    let cv = 0;
                    const arr = evCounter.current.keyIntervals;
                    if (arr.length >= 6) {
                        const mean = arr.reduce((a, b) => a + b, 0) / arr.length;
                        const varr = arr.reduce((a, b) => a + (b - mean) ** 2, 0) / arr.length;
                        const sd = Math.sqrt(varr);
                        cv = mean > 0 ? sd / mean : 0;
                    }

                    // Reset counters
                    evCounter.current.total = 0;
                    evCounter.current.keys = 0;

                    const activityNorm = clamp(events5s / 28, 0, 1);
                    const idlePenalty = clamp(idleSec / 25, 0, 1);
                    const typingPenalty = clamp((cv - 0.32) / 0.78, 0, 1);
                    const visPenalty = vis ? 0 : 1;

                    // Tab-leave penalty (distraction radar signal)
                    if (!useFocusEngine._lastTab) useFocusEngine._lastTab = 0;
                    const tabDelta = Math.max(0, tabLeaves.current - useFocusEngine._lastTab);
                    useFocusEngine._lastTab = tabLeaves.current;
                    const tabPenalty = clamp(tabDelta, 0, 3); // cap per sample

                    // Premium focus scoring: smoother + stronger penalties for real distractions
                    let score = 100;
                    score -= visPenalty * 60;
                    score -= idlePenalty * 32;
                    score -= tabPenalty * 22;
                    score += activityNorm * 14;
                    score -= typingPenalty * 10;

                    // Exponential smoothing (stable UI, still responsive)
                    setFocusScore(prev => clamp(Math.round(prev * 0.7 + score * 0.3), 0, 100));

                    setSignals({ visibility: vis, idleSec, events5s, keys5s, typingCV: Number(cv.toFixed(2)), tabLeaves: tabLeaves.current });
                }, samplingMs);

                return () => {
                    clearInterval(tick);
                    window.removeEventListener('mousemove', onAnyActivity);
                    window.removeEventListener('mousedown', onAnyActivity);
                    window.removeEventListener('scroll', onAnyActivity);
                    window.removeEventListener('touchstart', onAnyActivity);
                    window.removeEventListener('keydown', onKey);
                    document.removeEventListener('visibilitychange', onVisibility);
                };
            }, [enabled, samplingMs]);

            useEffect(() => {
                if (!enabled) return;
                if (focusScore >= 85) setFocusLabel('Mükemmel');
                else if (focusScore >= 70) setFocusLabel('İyi');
                else if (focusScore >= 50) setFocusLabel('Orta');
                else setFocusLabel('Düşük');
            }, [enabled, focusScore]);

            return { focusScore, focusLabel, signals };
        };

        // Learning Impact Score: açıklanabilir, oyunlanması zor, 0..100
        const computeImpactScore = ({ preAcc, postAcc, focusAvg, focusedMinutes, repeats, priorRepeats }) => {
            const gain = clamp(postAcc - preAcc, -1, 1);
            const gainScore = (gain + 1) / 2; // 0..1
            const focusScore = clamp(focusAvg / 100, 0, 1);

            const eff = focusedMinutes > 0
                ? clamp(gainScore / clamp(focusedMinutes / 25, 0.25, 2.5), 0, 1.25)
                : 0;

            const repRed = priorRepeats > 0 ? clamp((priorRepeats - repeats) / priorRepeats, -1, 1) : 0;
            const repScore = clamp((repRed + 1) / 2, 0, 1);

            const raw = (gainScore * 0.55) + (eff * 0.20) + (focusScore * 0.15) + (repScore * 0.10);
            return clamp(Math.round(raw * 100), 0, 100);
        };

        // Learning DNA: gerçek kullanım verisinden kişisel profil
        const buildDNA = ({ sessions, tabUse }) => {
            const hourBuckets = new Array(24).fill(null).map(() => ({ sum: 0, n: 0 }));
            sessions.forEach(s => {
                const h = new Date(s.ts).getHours();
                hourBuckets[h].sum += s.focusAvg || 0;
                hourBuckets[h].n += 1;
            });
            const hourAverages = hourBuckets.map((b, h) => ({ h, avg: b.n ? b.sum / b.n : 0, n: b.n }));
            hourAverages.sort((a, b) => (b.avg - a.avg));
            const peak = hourAverages.filter(x => x.n >= 2).slice(0, 3).map(x => x.h);

            const durCandidates = sessions.filter(s => (s.focusAvg || 0) >= 70).map(s => s.blockMins).filter(Boolean);
            let bestFocusMins = 25;
            if (durCandidates.length >= 3) {
                const avg = durCandidates.reduce((a, b) => a + b, 0) / durCandidates.length;
                bestFocusMins = clamp(Math.round(avg), 15, 50);
            }

            const v = tabUse.ai_study || 0;
            const t = (tabUse.tutor || 0) + (tabUse.planner || 0);
            const r = tabUse.flashcards || 0;
            const total = v + t + r;

            let modality = 'Dengeli';
            if (total >= 6) {
                const vv = v / total, tt = t / total, rr = r / total;
                if (vv >= 0.45) modality = 'Görsel Ağırlıklı';
                else if (rr >= 0.40) modality = 'Tekrar/Flashcard Ağırlıklı';
                else if (tt >= 0.45) modality = 'Metin/Sokratik Ağırlıklı';
            }

            return { peakHours: peak, bestFocusMins, modality };
        };

        
        // --- TEKNOFEST ULTRA: Live DNA v2 + Sustain/Recovery Metrics (Gemini-ready) ---
        const computeSustainScore = (histSessions) => {
            const recent = (histSessions || []).slice(-10);
            if (!recent.length) return 50;
            // sustain: how stable focus is over last sessions (lower variance => higher)
            const arr = recent.map(s => (s.lfi ?? s.focusAvg ?? 0)).filter(x => typeof x === 'number');
            if (!arr.length) return 50;
            const mean = arr.reduce((a,b)=>a+b,0)/arr.length;
            const varr = arr.reduce((a,b)=>a + (b-mean)**2,0)/arr.length;
            const sd = Math.sqrt(varr);
            const sustain = clamp(Math.round(100 - (sd * 1.8)), 0, 100);
            return sustain;
        };

        const computeRecoveryScore = (histSessions) => {
            // recovery: how well user bounces back after distractions (tabDelta/idle)
            const recent = (histSessions || []).slice(-10);
            if (!recent.length) return 50;
            const vals = recent.map(s => {
                const dis = typeof s.distraction === 'number' ? s.distraction : 0;
                const lfi = (typeof s.lfi === 'number' ? s.lfi : (s.focusAvg || 0));
                // If distraction high but lfi still high => good recovery
                const r = clamp(Math.round((lfi) - dis*60), 0, 100);
                return r;
            });
            const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
            return clamp(Math.round(avg), 0, 100);
        };

        const buildLiveDNAv2 = ({ sessions, tabUse }) => {
            const base = buildDNA({ sessions, tabUse });
            const sustain = computeSustainScore(sessions);
            const recovery = computeRecoveryScore(sessions);

            // streak estimate: consecutive focus sessions today
            const today = new Date().toISOString().split('T')[0];
            const todaySessions = (sessions || []).filter(s => (s.ts || '').startsWith(today) && (s.blockMins || 0) >= 10);
            const streak = todaySessions.length;

            // distraction fingerprint
            const recent = (sessions || []).slice(-12);
            const avgTab = recent.length ? recent.reduce((a,s)=>a+(s.tabDelta||0),0)/recent.length : 0;
            const avgIdle = recent.length ? recent.reduce((a,s)=>a+(s.idleEndSec||0),0)/recent.length : 0;

            // skill ladder: a stable, explainable "level"
            const avgLfi = recent.length ? recent.reduce((a,s)=>a+(s.lfi||s.focusAvg||0),0)/recent.length : 0;
            const level = clamp(Math.floor(avgLfi/10), 0, 10);

            return {
                ...base,
                sustain,
                recovery,
                streak,
                avgTab: Number(avgTab.toFixed(2)),
                avgIdle: Math.round(avgIdle),
                level
            };
        };

        const safeSlice = (s, n) => (s || '').toString().slice(0, n);

        const geminiUltraAnalyze = async ({ payload, apiKey, callGeminiFn }) => {
            if (!apiKey) throw new Error("API Anahtarı eksik.");
            const systemInstruction = `
Sen "Teknofest AI Ultra Core"sun.
Sadece JSON döndür. Şema:
{
  "headline": "Kısa başlık",
  "diagnosis": ["Madde 1", "Madde 2", "Madde 3"],
  "next_actions": [{"title":"Eylem","why":"Kısa gerekçe","command":{"action":"OPEN_TAB","payload":"timer"}}],
  "timer_tuning": {"focus": 0, "shortBreak": 0, "longBreak": 0},
  "music_strategy": {"mode":"audius|radio|local","query":"string","reason":"string"},
  "goal": {"name":"string","target":"string","metric":"LFI|Sustain|Recovery","days": 7}
}
Kurallar:
- timer_tuning değerleri 0 ise dokunma; doluysa 15..50 / 4..10 / 10..25 aralığında.
- music_strategy sadece öneri; kullanıcı onayı olmadan zorla çalma.
- diagnosis ve next_actions kısa, uygulanabilir.
`.trim();

            const prompt = `Veri (JSON):\n${JSON.stringify(payload)}\n\nŞemaya göre üret.`;
            const raw = await callGeminiFn(prompt, systemInstruction);
            const clean = raw.replace(/```json/g,'').replace(/```/g,'').trim();
            const j = JSON.parse(clean);

            // sanitize
            const out = {
                ts: new Date().toISOString(),
                headline: safeSlice(j.headline, 120),
                diagnosis: Array.isArray(j.diagnosis) ? j.diagnosis.map(x=>safeSlice(x, 140)).slice(0,6) : [],
                next_actions: Array.isArray(j.next_actions) ? j.next_actions.slice(0,5) : [],
                timer_tuning: j.timer_tuning || {},
                music_strategy: j.music_strategy || null,
                goal: j.goal || null
            };
            return out;
        };


        const scoreTest = (test, answers) => {
            if (!test?.questions?.length) return { correct: 0, total: 0, acc: 0 };
            let correct = 0;
            test.questions.forEach((q, i) => {
                const a = answers[i];
                if (a != null && String(a) === String(q.correct)) correct += 1;
            });
            const total = test.questions.length;
            const acc = total ? correct / total : 0;
            return { correct, total, acc };
        };


        
        // --- VISION + AUDIO ENGINE (On-device, fail-safe) ---
        // Not: Bu çekirdek, HARİCİ ML KÜTÜPHANESİ OLMADAN da stabil çalışır.
        // Eğer tarayıcı FaceDetector API destekliyorsa, yüz var/yok algısı yapar.
        // Gaze/pose için daha ileri ML (MediaPipe) ileride eklenebilir; burada sistem asla çökmez.

        const isSecureCamContext = () => {
            try {
                const host = window.location.hostname;
                const proto = window.location.protocol;
                return window.isSecureContext || proto === 'https:' || host === 'localhost' || host === '127.0.0.1';
            } catch { return false; }
        };

        const useVisionEngine = ({ enabled, micEnabled, videoRef, sampleMs = 500 }) => {
            const [status, setStatus] = useState('off'); // off | on | blocked | error
            const [errMsg, setErrMsg] = useState('');
            const [facePresent, setFacePresent] = useState(null); // true | false | null (unknown)
            const [trust, setTrust] = useState(55); // 0..100
            const [vas, setVas] = useState(70); // Vision Attention Score 0..100 (proxy)
            const [audio, setAudio] = useState({ rms: 0, hiss: 0, peak: 0 });

            const streamRef = useRef(null);
            const canvasRef = useRef(null);
            const rafRef = useRef(null);

            const audioCtxRef = useRef(null);
            const analyserRef = useRef(null);
            const micStreamRef = useRef(null);

            const stopCamera = () => {
                try { streamRef.current?.getTracks?.().forEach(t => t.stop()); } catch {}
                streamRef.current = null;
                if (videoRef?.current) {
                    try { videoRef.current.pause(); } catch {}
                    try { videoRef.current.srcObject = null; } catch {}
                }
                setStatus('off');
            };

            const startCamera = async () => {
                setErrMsg('');
                if (!enabled) return;
                if (!navigator.mediaDevices?.getUserMedia) {
                    setStatus('error');
                    setErrMsg("Tarayıcı kamera API desteklemiyor.");
                    return;
                }
                if (!isSecureCamContext()) {
                    setStatus('blocked');
                    setErrMsg("Kamera için HTTPS veya localhost gerekir.");
                    return;
                }
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: { ideal: 640 }, height: { ideal: 360 }, facingMode: 'user' },
                        audio: false
                    });
                    streamRef.current = stream;
                    if (videoRef?.current) {
                        videoRef.current.srcObject = stream;
                        videoRef.current.muted = true;
                        videoRef.current.playsInline = true;
                        await videoRef.current.play();
                    }
                    setStatus('on');
                } catch (e) {
                    const name = e?.name || '';
                    setStatus(name === 'NotAllowedError' || name === 'SecurityError' ? 'blocked' : 'error');
                    setErrMsg(name === 'NotAllowedError' ? "Kamera izni verilmedi." : (e?.message || "Kamera açılamadı."));
                }
            };

            const stopMic = () => {
                try { micStreamRef.current?.getTracks?.().forEach(t => t.stop()); } catch {}
                micStreamRef.current = null;
                analyserRef.current = null;
                if (audioCtxRef.current) {
                    try { audioCtxRef.current.close(); } catch {}
                    audioCtxRef.current = null;
                }
                setAudio({ rms: 0, hiss: 0, peak: 0 });
            };

            const startMic = async () => {
                setErrMsg('');
                if (!micEnabled) return;
                if (!navigator.mediaDevices?.getUserMedia) {
                    setErrMsg("Tarayıcı mikrofon API desteklemiyor.");
                    return;
                }
                if (!isSecureCamContext()) {
                    setErrMsg("Mikrofon için HTTPS veya localhost gerekir.");
                    return;
                }
                try {
                    const ms = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
                    micStreamRef.current = ms;
                    const AC = window.AudioContext || window.webkitAudioContext;
                    if (!AC) { setErrMsg("AudioContext desteklenmiyor."); return; }
                    const ctx = new AC();
                    audioCtxRef.current = ctx;

                    const src = ctx.createMediaStreamSource(ms);
                    const analyser = ctx.createAnalyser();
                    analyser.fftSize = 2048;
                    analyser.smoothingTimeConstant = 0.85;
                    src.connect(analyser);
                    analyserRef.current = analyser;
                } catch (e) {
                    const name = e?.name || '';
                    setErrMsg(name === 'NotAllowedError' ? "Mikrofon izni verilmedi." : (e?.message || "Mikrofon açılamadı."));
                }
            };

            // Auto start/stop camera based on enabled
            useEffect(() => {
                if (!enabled) { stopCamera(); return; }
                startCamera();
                return () => { stopCamera(); };
            }, [enabled]);

            // Auto start/stop mic based on micEnabled
            useEffect(() => {
                if (!micEnabled) { stopMic(); return; }
                startMic();
                return () => { stopMic(); };
            }, [micEnabled]);

            // Vision sampling loop (FaceDetector if available) + trust proxy
            useEffect(() => {
                if (!enabled || status !== 'on') return;

                if (!canvasRef.current) {
                    const c = document.createElement('canvas');
                    c.width = 320; c.height = 180;
                    canvasRef.current = c;
                }
                const canvas = canvasRef.current;
                const ctx2d = canvas.getContext('2d', { willReadFrequently: true });

                const hasFD = typeof window.FaceDetector !== 'undefined';
                const detector = hasFD ? new window.FaceDetector({ fastMode: true, maxDetectedFaces: 1 }) : null;

                let mounted = true;
                const tick = async () => {
                    if (!mounted) return;
                    const v = videoRef?.current;
                    if (!v || v.readyState < 2) {
                        setTrust(prev => Math.max(20, Math.round(prev * 0.98)));
                        rafRef.current = setTimeout(tick, sampleMs);
                        return;
                    }
                    // draw frame
                    try { ctx2d.drawImage(v, 0, 0, canvas.width, canvas.height); } catch {}
                    // brightness-based trust (rough)
                    try {
                        const img = ctx2d.getImageData(0, 0, canvas.width, canvas.height).data;
                        let sum = 0;
                        for (let i=0;i<img.length;i+=16) { // sample
                            const r=img[i], g=img[i+1], b=img[i+2];
                            sum += (0.2126*r + 0.7152*g + 0.0722*b);
                        }
                        const lum = sum / (img.length/16);
                        const light = Math.max(0, Math.min(1, (lum - 25) / 140)); // 0..1
                        const tScore = Math.round(35 + light * 55);
                        setTrust(prev => Math.round(prev * 0.75 + tScore * 0.25));
                    } catch {}

                    if (detector) {
                        try {
                            const faces = await detector.detect(canvas);
                            setFacePresent(faces?.length ? true : false);
                        } catch {
                            setFacePresent(null);
                        }
                    } else {
                        setFacePresent(null);
                    }

                    // Vision Attention Score (proxy): if face known, map presence+trust
                    setVas(prev => {
                        const base = facePresent === false ? 35 : 70;
                        const vScore = Math.round(base * 0.55 + (trust || 55) * 0.45);
                        return Math.max(0, Math.min(100, Math.round(prev * 0.7 + vScore * 0.3)));
                    });

                    rafRef.current = setTimeout(tick, sampleMs);
                };

                tick();
                return () => {
                    mounted = false;
                    if (rafRef.current) clearTimeout(rafRef.current);
                };
            }, [enabled, status, sampleMs, videoRef]);

            // Audio sampling loop
            useEffect(() => {
                if (!micEnabled || !analyserRef.current) return;
                let mounted = true;
                const analyser = analyserRef.current;
                const buf = new Uint8Array(analyser.frequencyBinCount);
                const tick = () => {
                    if (!mounted) return;
                    analyser.getByteFrequencyData(buf);

                    // rms proxy (0..1)
                    let sum = 0;
                    for (let i=0;i<buf.length;i++) sum += buf[i]*buf[i];
                    const rms = Math.sqrt(sum / buf.length) / 255;

                    // hiss proxy: high freq energy ratio (approx last 25%)
                    const start = Math.floor(buf.length * 0.75);
                    let hf = 0, all = 0;
                    for (let i=0;i<buf.length;i++) {
                        all += buf[i];
                        if (i>=start) hf += buf[i];
                    }
                    const hiss = all > 0 ? hf / all : 0;

                    setAudio(prev => {
                        const peak = Math.max(prev.peak * 0.92, rms);
                        return { rms: Number(rms.toFixed(3)), hiss: Number(hiss.toFixed(3)), peak: Number(peak.toFixed(3)) };
                    });

                    requestAnimationFrame(tick);
                };
                requestAnimationFrame(tick);
                return () => { mounted = false; };
            }, [micEnabled]);

            return {
                status,
                errMsg,
                facePresent,
                trustScore: trust,
                visionAttentionScore: vas,
                audio,
                startCamera,
                stopCamera,
                startMic,
                stopMic
            };
        };
const App = () => {
            // --- CORE STATE ---
            const [mode, setMode] = useState('focus');
            const [activeTab, setActiveTab] = useState('timer');
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const [pauseCount, setPauseCount] = useState(0);
            const [zenMode, setZenMode] = useState(false);
            const [breathMode, setBreathMode] = useState(false);
            
            // --- DATA STATE ---
            const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('pomo_tasks') || '[]'));
            const [newTask, setNewTask] = useState('');
            const [exams, setExams] = useState(() => JSON.parse(localStorage.getItem('pomo_exams') || '[]')); 
            const [newExamTitle, setNewExamTitle] = useState('');
            const [newExamDate, setNewExamDate] = useState('');
            const [notes, setNotes] = useState(() => localStorage.getItem('pomo_notes') || '');
            const [stats, setStats] = useState(() => JSON.parse(localStorage.getItem('pomo_history') || '[]'));

            // --- TEKNOFEST AI CORE STATE ---
            const [focusEnabled, setFocusEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_focus_enabled') || 'true', true));
            const [aiGovernorEnabled, setAiGovernorEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_ai_governor') || 'true', true));
            const [autoPilotEnabled, setAutoPilotEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_autopilot') || 'false', false));
            const [autoPilotMode, setAutoPilotMode] = useState(() => safeJsonParse(localStorage.getItem('pomo_autopilot_mode') || '"adaptive"', "adaptive")); // adaptive | aggressive
            const [autoPilotLast, setAutoPilotLast] = useState(() => safeJsonParse(localStorage.getItem('pomo_autopilot_last') || 'null', null));
            const autoPilotLockRef = useRef(false);
            const [aiLastRecommendation, setAiLastRecommendation] = useState(() => safeJsonParse(localStorage.getItem('pomo_ai_reco') || 'null', null));
            const { focusScore, focusLabel, signals } = useFocusEngine({ enabled: focusEnabled, samplingMs: 5000 });
            const focusSamplesRef = useRef([]);
            const tabAlarmIntervalRef = useRef(null);
            const tabLeavesStartRef = useRef(0);

            // Alarm when leaving the tab (stops when returning)
            useEffect(() => {
                const onVis = () => {
                    if (!tabAlarmEnabled) return;
                    // Only enforce during an active focus session
                    if (document.hidden && isActive && mode === 'focus') {
                        if (tabAlarmIntervalRef.current) return;
                        // fire immediately + keep reminding while hidden
                        playAlarm('triple');
                        tabAlarmIntervalRef.current = setInterval(() => {
                            try { playAlarm('triple'); } catch (e) {}
                        }, 4500);
                    } else {
                        if (tabAlarmIntervalRef.current) {
                            clearInterval(tabAlarmIntervalRef.current);
                            tabAlarmIntervalRef.current = null;
                        }
                    }
                };
                document.addEventListener('visibilitychange', onVis);
                return () => {
                    document.removeEventListener('visibilitychange', onVis);
                    if (tabAlarmIntervalRef.current) { clearInterval(tabAlarmIntervalRef.current); tabAlarmIntervalRef.current = null; }
                };
            }, [tabAlarmEnabled, isActive, mode, alarmEnabled, alarmLoud]);

            // Capture tab leave baseline at the start of each focus run (for Distraction Radar session deltas)
            useEffect(() => {
                if (!isActive) return;
                if (mode !== 'focus') return;
                tabLeavesStartRef.current = signals?.tabLeaves || 0;
            }, [isActive, mode]);


            const [sessions, setSessions] = useState(() => JSON.parse(localStorage.getItem('pomo_sessions') || '[]'));
            const [tabUse, setTabUse] = useState(() => JSON.parse(localStorage.getItem('pomo_tabuse') || '{}'));
            const [impactByTopic, setImpactByTopic] = useState(() => JSON.parse(localStorage.getItem('pomo_impact') || '{}'));

            const [activeStudyTopic, setActiveStudyTopic] = useState(() => localStorage.getItem('pomo_active_topic') || '');
            const [aiCoreTopic, setAiCoreTopic] = useState('');

            const [preTest, setPreTest] = useState(null);
            const [postTest, setPostTest] = useState(null);
            const [preAnswers, setPreAnswers] = useState({});
            const [postAnswers, setPostAnswers] = useState({});
            const [preResult, setPreResult] = useState(null);  // {acc, correct, total}
            const [postResult, setPostResult] = useState(null);
            const [isGeneratingTest, setIsGeneratingTest] = useState(false);

            // --- AUDIO & MEDIA STATE ---
            const [activeSounds, setActiveSounds] = useState({});
            const [masterVolume, setMasterVolume] = useState(1);
            const [activeEmbed, setActiveEmbed] = useState(null);

            // --- MUSIC ENGINE v2 (FREE CATALOG: Audius + Jamendo + YouTube URL) ---
            const [musicProvider, setMusicProvider] = useState(() => localStorage.getItem('pomo_music_provider') || 'audius'); // audius | jamendo | youtube
            const [musicQuery, setMusicQuery] = useState('');
            const [musicResults, setMusicResults] = useState([]);
            const [musicQueue, setMusicQueue] = useState(() => safeJsonParse(localStorage.getItem('pomo_music_queue') || '[]', []));
            const [musicFavs, setMusicFavs] = useState(() => safeJsonParse(localStorage.getItem('pomo_music_favs') || '[]', []));
            const [nowPlaying, setNowPlaying] = useState(() => safeJsonParse(localStorage.getItem('pomo_music_now') || 'null', null));
            const [musicIsPlaying, setMusicIsPlaying] = useState(false);
            const [musicVolume, setMusicVolume] = useState(() => {
                const v = parseFloat(localStorage.getItem('pomo_music_vol') || '0.85');
                return isNaN(v) ? 0.85 : clamp(v, 0, 1);
            });
            const [musicRepeat, setMusicRepeat] = useState(() => safeJsonParse(localStorage.getItem('pomo_music_repeat') || 'false', false));
            const [musicShuffle, setMusicShuffle] = useState(() => safeJsonParse(localStorage.getItem('pomo_music_shuffle') || 'false', false));
            const [musicStatus, setMusicStatus] = useState({ loading: false, error: '' });
            const audioPlayerRef = useRef(null);
            const [ytUrl, setYtUrl] = useState('');
            const [ytEmbedId, setYtEmbedId] = useState(null);
            const [jamendoClientId, setJamendoClientId] = useState(() => localStorage.getItem('pomo_jamendo_client_id') || '');
            const [jamendoConsent, setJamendoConsent] = useState(() => safeJsonParse(localStorage.getItem('pomo_jamendo_consent') || 'false', false));

            // --- MINI PLAYER (persistent, bottom-right) ---
            const [miniPlayerOpen, setMiniPlayerOpen] = useState(() => safeJsonParse(localStorage.getItem('pomo_mini_player_open') || 'true', true));
            const [miniPlayerCollapsed, setMiniPlayerCollapsed] = useState(() => safeJsonParse(localStorage.getItem('pomo_mini_player_collapsed') || 'false', false));


 

            // --- SEASON & BACKGROUND STATE ---
            const [currentSeason, setCurrentSeason] = useState('autumn');
            const [bgIndex, setBgIndex] = useState(0);

            // --- AI & ADVANCED FEATURES STATE ---
            const [studyProfile, setStudyProfile] = useState(() => JSON.parse(localStorage.getItem('pomo_profile') || '{"grade":"","weakSubjects":"","hoursPerDay":4}'));
            const [studyPlan, setStudyPlan] = useState(() => JSON.parse(localStorage.getItem('pomo_plan') || 'null'));
            const [isGeneratingPlan, setIsGeneratingPlan] = useState(false);
            const [isBreakingTask, setIsBreakingTask] = useState(false);
            
            // --- INFOGRAPHIC GENERATOR STATE ---
            const [aiTopic, setAiTopic] = useState('');
            const [infographicData, setInfographicData] = useState(null);
            const [aiImage, setAiImage] = useState(null);
            const [isAiWorking, setIsAiWorking] = useState(false);

            // --- SOCRATIC TUTOR STATE ---
            const [tutorMessages, setTutorMessages] = useState([]);
            const [tutorTopic, setTutorTopic] = useState('');
            const [isTutorThinking, setIsTutorThinking] = useState(false);

            // --- FLASHCARDS ---
            const [flashcards, setFlashcards] = useState(() => JSON.parse(localStorage.getItem('pomo_flashcards') || '[]'));
            const [flashcardTopic, setFlashcardTopic] = useState('');
            const [currentCardIndex, setCurrentCardIndex] = useState(0);
            const [isCardFlipped, setIsCardFlipped] = useState(false);
            const [isGeneratingCards, setIsGeneratingCards] = useState(false);
            
            // --- SYSTEM CONFIG ---
            const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [showSettings, setShowSettings] = useState(false);
            const settingsScrollRef = useRef(null);

            const [durations, setDurations] = useState({ focus: 25, shortBreak: 5, longBreak: 15 });
            useEffect(() => {
                if (!showSettings) return;
                // Each time settings opens, reset scroll to top for consistent UX
                setTimeout(() => {
                    try { settingsScrollRef.current?.scrollTo({ top: 0, left: 0, behavior: 'auto' }); } catch (e) {}
                }, 0);
            }, [showSettings]);


            // --- TIMER BEHAVIOR (RELIABILITY PATCH) ---
            const [autoAdvance, setAutoAdvance] = useState(() => safeJsonParse(localStorage.getItem('pomo_auto_advance') || 'true', true));
            const [autoStartNext, setAutoStartNext] = useState(() => safeJsonParse(localStorage.getItem('pomo_auto_start_next') || 'true', true));
            const [alarmEnabled, setAlarmEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_alarm_enabled') || 'true', true));
            const [alarmLoud, setAlarmLoud] = useState(() => safeJsonParse(localStorage.getItem('pomo_alarm_loud') || 'true', true));
            const [tabAlarmEnabled, setTabAlarmEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_tab_alarm_enabled') || 'true', true));
            const [adaptiveEnabled, setAdaptiveEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_adaptive_enabled') || 'true', true));
            const [lfiEnabled, setLfiEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_lfi_enabled') || 'true', true));

            
            // --- ACCESSIBILITY / PRIVACY / PROFILES (TEKNOFEST PACK) ---
            const [highContrast, setHighContrast] = useState(() => safeJsonParse(localStorage.getItem('pomo_high_contrast') || 'false', false));
            const [dyslexicFont, setDyslexicFont] = useState(() => safeJsonParse(localStorage.getItem('pomo_dyslexic_font') || 'false', false));
            const [uiLanguage, setUiLanguage] = useState(() => localStorage.getItem('pomo_lang') || 'tr');
            const [privacyConsent, setPrivacyConsent] = useState(() => safeJsonParse(localStorage.getItem('pomo_privacy_consent') || 'false', false));
            const [privacyMode, setPrivacyMode] = useState(() => localStorage.getItem('pomo_privacy_mode') || 'local'); // local | hybrid
            const [demoMode, setDemoMode] = useState(false);

            // Multi-profile (local, KVKK-friendly)
            const [profiles, setProfiles] = useState(() => safeJsonParse(localStorage.getItem('pomo_profiles') || '[]', []));
            const [activeProfileId, setActiveProfileId] = useState(() => localStorage.getItem('pomo_active_profile') || 'default');
const [focusStreak, setFocusStreak] = useState(() => safeJsonParse(localStorage.getItem('pomo_focus_streak') || '0', 0));
            const [aiDebriefs, setAiDebriefs] = useState(() => safeJsonParse(localStorage.getItem('pomo_ai_debriefs') || '[]', []));

// --- TEKNOFEST ULTRA CORE STATE ---
const [ultraEnabled, setUltraEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_ultra_enabled') || 'true', true));
const [ultraInsights, setUltraInsights] = useState(() => safeJsonParse(localStorage.getItem('pomo_ultra_insights') || '[]', [])); // last 20
const [ultraPending, setUltraPending] = useState(false);
const [ultraGoal, setUltraGoal] = useState(() => safeJsonParse(localStorage.getItem('pomo_ultra_goal') || 'null', null));
const [autoTuneEnabled, setAutoTuneEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_ultra_autotune') || 'false', false));
const [missionModeEnabled, setMissionModeEnabled] = useState(() => safeJsonParse(localStorage.getItem('pomo_mission_mode') || 'false', false));
const [missionPriority, setMissionPriority] = useState(() => localStorage.getItem('pomo_mission_priority') || 'balanced');
const [aiTacticalState, setAiTacticalState] = useState(() => safeJsonParse(localStorage.getItem('pomo_ai_tactical_state') || 'null', null));
            
            // --- CHAT & VOICE (GLOBAL) ---
            const [isCoachOpen, setIsCoachOpen] = useState(false);
            const [chatMessages, setChatMessages] = useState([{role: 'system', text: "Sistem hazır. Mikrofonu açıp komut verebilirsin."}]);
            const [chatInput, setChatInput] = useState('');
            const [isAiProcessing, setIsAiProcessing] = useState(false);
            
            // --- GLOBAL VOICE STATE ---
            const [isGlobalVoiceActive, setIsGlobalVoiceActive] = useState(false);
            const [voiceFeedback, setVoiceFeedback] = useState(''); 
            const [voiceEnabled, setVoiceEnabled] = useState(true);
            const [queueLength, setQueueLength] = useState(0); 

            // --- REFS ---
            const timerRef = useRef(null);
            const audioCtxRef = useRef(null);
            const audioNodesRef = useRef({}); 
            const chatEndRef = useRef(null);
            const tutorEndRef = useRef(null);
            const recognitionRef = useRef(null);
            const isSystemSpeakingRef = useRef(false);
            
            // --- QUEUE SYSTEM REFS ---
            const requestQueue = useRef([]);
            const isProcessingQueue = useRef(false);

            // --- FIXED QUEUE PROCESSOR ---
            const processQueue = async () => {
                if (isProcessingQueue.current || requestQueue.current.length === 0) return;
                
                isProcessingQueue.current = true;
                setQueueLength(requestQueue.current.length);

                const currentItem = requestQueue.current[0];
                const { prompt, systemInstruction, resolve, reject, retryCount } = currentItem;

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 60000); 

                    const payload = {
                        contents: [{ parts: [{ text: prompt }] }],
                        system_instruction: systemInstruction ? { parts: [{ text: systemInstruction }] } : undefined
                    };

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);

                    if (!response.ok) {
                        const errorText = await response.text();
                        if (response.status === 429 || response.status === 503 || errorText.includes('Quota')) {
                            throw new Error("429");
                        }
                        throw new Error(`API Hatası: ${response.status}`);
                    }

                    const data = await response.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Hata: Boş yanıt.";

                    requestQueue.current.shift();
                    setQueueLength(requestQueue.current.length);
                    resolve(text);
                    
                    setTimeout(() => {
                        isProcessingQueue.current = false;
                        processQueue();
                    }, 2000);

                } catch (e) {
                    if (e.message === "429" && retryCount < 3) {
                        const waitTime = (retryCount + 1) * 10000;
                        setVoiceFeedback(`⏳ Kota sınırı... ${waitTime/1000}s bekleniyor`);
                        requestQueue.current[0].retryCount += 1;
                        setTimeout(() => {
                            isProcessingQueue.current = false;
                            processQueue();
                        }, waitTime);
                    } else {
                        requestQueue.current.shift();
                        setQueueLength(requestQueue.current.length);
                        if (e.message === "429") {
                            reject(new Error("Çok fazla istek. Lütfen biraz bekle."));
                        } else {
                            reject(e);
                        }
                        isProcessingQueue.current = false;
                        processQueue();
                    }
                }
            };

            const addToQueue = (prompt, systemInstruction) => {
                return new Promise((resolve, reject) => {
                    requestQueue.current.push({ prompt, systemInstruction, resolve, reject, retryCount: 0 });
                    setQueueLength(requestQueue.current.length);
                    processQueue();
                });
            };

            const callGemini = (prompt, systemInstruction = "") => {
                if (!apiKey) throw new Error("API Anahtarı eksik.");
                return addToQueue(prompt, systemInstruction);
            };

            // --- SOUND ENGINE ---
            const createNoiseBuffer = (ctx, type) => {
                const bufferSize = ctx.sampleRate * 2;
                const buffer = ctx.createBuffer(1, bufferSize, ctx.sampleRate);
                const data = buffer.getChannelData(0);
                if (type === 'white') {
                    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
                } else if (type === 'pink') {
                    let b0=0,b1=0,b2=0,b3=0,b4=0,b5=0,b6=0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        b0 = 0.99886 * b0 + white * 0.0555179;
                        b1 = 0.99332 * b1 + white * 0.0750759;
                        b2 = 0.96900 * b2 + white * 0.1538520;
                        b3 = 0.86650 * b3 + white * 0.3104856;
                        b4 = 0.55000 * b4 + white * 0.5329522;
                        b5 = -0.7616 * b5 - white * 0.0168980;
                        data[i] = (b0 + b1 + b2 + b3 + b4 + b5 + b6 + white * 0.5362) * 0.11;
                        b6 = white * 0.115926;
                    }
                } else if (type === 'brown') {
                    let lastOut = 0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        data[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = data[i];
                        data[i] *= 3.5;
                    }
                }
                return buffer;
            };

// --- MUSIC ENGINE v2 helpers ---
            const fmtTime = (sec) => {
                const s = Math.max(0, Math.floor(sec || 0));
                const m = Math.floor(s / 60);
                const r = String(s % 60).padStart(2, '0');
                return `${m}:${r}`;
            };

            const parseYouTubeId = (url) => {
                try {
                    const u = new URL(url);
                    if (u.hostname.includes('youtu.be')) return u.pathname.replace('/', '') || null;
                    if (u.searchParams.get('v')) return u.searchParams.get('v');
                    // shorts
                    const p = u.pathname.split('/').filter(Boolean);
                    const si = p.indexOf('shorts');
                    if (si >= 0 && p[si+1]) return p[si+1];
                    return null;
                } catch {
                    // fallback regex
                    const m = String(url || '').match(/(?:v=|\/)([0-9A-Za-z_-]{11})/);
                    return m ? m[1] : null;
                }
            };

            const getYouTubeEmbedUrl = (id) => {
                const safeId = String(id || '').trim();
                if (!safeId) return '';
                const params = new URLSearchParams({
                    autoplay: '1',
                    rel: '0',
                    modestbranding: '1',
                    playsinline: '1'
                });
                try {
                    const origin = window?.location?.origin;
                    if (origin && origin !== 'null' && !origin.startsWith('file')) {
                        params.set('origin', origin);
                    }
                } catch (e) {}
                return `https://www.youtube-nocookie.com/embed/${safeId}?${params.toString()}`;
            };

            const normalizeTrack = (t) => t;

            const musicStop = () => {
                try { audioPlayerRef.current?.pause(); } catch(e) {}
                try { if (audioPlayerRef.current) audioPlayerRef.current.currentTime = 0; } catch(e) {}
                try { if (audioPlayerRef.current) audioPlayerRef.current.src = ''; } catch(e) {}
                setMusicIsPlaying(false);
                setYtEmbedId(null);
            };

            const musicPlayTrack = async (track, { enqueue = false } = {}) => {
                if (!track) return;
                if (enqueue) setMusicQueue(prev => [...prev, track]);
                setNowPlaying(track);

                if (track.source === 'youtube') {
                    try { audioPlayerRef.current?.pause(); } catch(e) {}
                    try { if (audioPlayerRef.current) audioPlayerRef.current.src = ''; } catch(e) {}
                    setYtEmbedId(track.youtubeId || null);
                    setMusicIsPlaying(Boolean(track.youtubeId));
                    return;
                }

                // Audius / Jamendo -> HTMLAudioElement
                setYtEmbedId(null);
                setMusicIsPlaying(true);
                setTimeout(() => {
                    try {
                        const a = audioPlayerRef.current;
                        if (!a) return;
                        a.src = track.streamUrl;
                        a.volume = musicVolume;
                        a.play().catch(() => {});
                    } catch(e) {}
                }, 0);
            };

            const musicTogglePlay = () => {
                const t = nowPlaying;
                if (!t) return;
                if (t.source === 'youtube') {
                    if (!t.youtubeId) return;
                    if (musicIsPlaying) {
                        setYtEmbedId(null);
                        setMusicIsPlaying(false);
                    } else {
                        setYtEmbedId(t.youtubeId);
                        setMusicIsPlaying(true);
                    }
                    return;
                }
                const a = audioPlayerRef.current;
                if (!a) return;
                if (a.paused) { a.play().catch(()=>{}); setMusicIsPlaying(true); }
                else { a.pause(); setMusicIsPlaying(false); }
            };

            const musicPlayIndex = (idx) => {
                const q = musicQueue || [];
                if (idx < 0 || idx >= q.length) return;
                musicPlayTrack(q[idx]);
            };

            const musicNext = () => {
                if (nowPlaying?.source === 'youtube') return;
                const q = musicQueue || [];
                if (!q.length) return;
                const curId = nowPlaying?.id;
                let i = q.findIndex(x => x.id === curId);
                if (i < 0) i = 0;

                let nextIdx;
                if (musicShuffle) nextIdx = Math.floor(Math.random() * q.length);
                else nextIdx = i + 1;

                if (nextIdx >= q.length) {
                    if (musicRepeat) nextIdx = 0;
                    else { musicStop(); return; }
                }
                musicPlayIndex(nextIdx);
            };

            const musicPrev = () => {
                if (nowPlaying?.source === 'youtube') return;
                const q = musicQueue || [];
                if (!q.length) return;
                const curId = nowPlaying?.id;
                let i = q.findIndex(x => x.id === curId);
                if (i < 0) i = 0;
                const prevIdx = Math.max(0, i - 1);
                musicPlayIndex(prevIdx);
            };

            const musicAddToQueue = (track) => {
                if (!track) return;
                setMusicQueue(prev => [...prev, track]);
            };

            const musicRemoveFromQueue = (id) => {
                setMusicQueue(prev => (prev || []).filter(x => x.id !== id));
            };

            const musicClearQueue = () => {
                setMusicQueue([]);
            };

            const musicToggleFav = (track) => {
                if (!track) return;
                setMusicFavs(prev => {
                    const arr = prev || [];
                    const exists = arr.some(x => x.id === track.id);
                    if (exists) return arr.filter(x => x.id !== track.id);
                    return [track, ...arr].slice(0, 200);
                });
            };

            const isFav = (id) => (musicFavs || []).some(x => x.id === id);

            const audiusSearch = async (q) => {
                const base = "https://discoveryprovider.audius.co/v1";
                const url = `${base}/tracks/search?query=${encodeURIComponent(q)}&limit=24&app_name=PomodoroOS`;
                const r = await fetch(url);
                if (!r.ok) throw new Error('Audius arama hatası');
                const j = await r.json();
                const data = j?.data || [];
                return data.map(x => ({
                    id: `audius:${x.id}`,
                    rawId: x.id,
                    title: x.title || 'Unknown',
                    artist: x.user?.name || 'Unknown',
                    artworkUrl: x.artwork?.['480x480'] || x.artwork?.['150x150'] || '',
                    durationSec: x.duration || 0,
                    source: 'audius',
                    streamUrl: `${base}/tracks/${x.id}/stream?app_name=PomodoroOS`,
                    webUrl: x.permalink || '',
                    license: 'Audius'
                }));
            };

            const jamendoSearch = async (q) => {
                if (!jamendoClientId || !jamendoConsent) return [];
                const url = `https://api.jamendo.com/v3.0/tracks/?client_id=${encodeURIComponent(jamendoClientId)}&format=json&limit=24&namesearch=${encodeURIComponent(q)}&audioformat=mp32&include=musicinfo+licenses`;
                const r = await fetch(url);
                if (!r.ok) throw new Error('Jamendo arama hatası');
                const j = await r.json();
                const data = j?.results || [];
                return data.map(x => ({
                    id: `jamendo:${x.id}`,
                    rawId: x.id,
                    title: x.name || 'Unknown',
                    artist: x.artist_name || 'Unknown',
                    artworkUrl: x.image || '',
                    durationSec: x.duration || 0,
                    source: 'jamendo',
                    streamUrl: x.audio || '',
                    webUrl: x.shareurl || '',
                    license: x.license_ccurl || x.license || 'Creative Commons'
                }));
            };

            const musicSearch = async () => {
                const q = (musicQuery || '').trim();
                if (!q) return;
                setMusicStatus({ loading: true, error: '' });
                setMusicResults([]);

                try {
                    let res = [];
                    if (musicProvider === 'audius') res = await audiusSearch(q);
                    else if (musicProvider === 'jamendo') res = await jamendoSearch(q);
                    else res = []; // youtube: only URL-based in single-file mode

                    setMusicResults(res);
                    if (!res.length && musicProvider === 'jamendo' && (!jamendoClientId || !jamendoConsent)) {
                        setMusicStatus({ loading: false, error: "Jamendo için client_id + izin gerekli. Ayarlardan ekle." });
                    } else {
                        setMusicStatus({ loading: false, error: res.length ? '' : 'Sonuç bulunamadı.' });
                    }
                } catch (e) {
                    setMusicStatus({ loading: false, error: e?.message || 'Arama hatası' });
                }
            };

            const musicPlayYouTubeUrl = () => {
                const id = parseYouTubeId(ytUrl);
                if (!id) { setMusicStatus({ loading: false, error: 'Geçerli YouTube linki bulunamadı.' }); return; }
                const track = {
                    id: `youtube:${id}`,
                    rawId: id,
                    title: 'YouTube',
                    artist: 'Video',
                    artworkUrl: `https://i.ytimg.com/vi/${id}/hqdefault.jpg`,
                    durationSec: 0,
                    source: 'youtube',
                    youtubeId: id,
                    streamUrl: '',
                    webUrl: ytUrl,
                    license: 'YouTube'
                };
                musicPlayTrack(track, { enqueue: false });
            };

            // Keep audio volume in sync
            useEffect(() => {
                try { if (audioPlayerRef.current) audioPlayerRef.current.volume = musicVolume; } catch(e) {}
            }, [musicVolume]);

            // Auto-next on end
            useEffect(() => {
                const a = audioPlayerRef.current;
                if (!a) return;
                const onEnded = () => {
                    if (musicRepeat && (!musicQueue || musicQueue.length === 0) && nowPlaying) {
                        // repeat single
                        try { a.currentTime = 0; a.play().catch(()=>{}); } catch(e) {}
                        return;
                    }
                    musicNext();
                };
                a.addEventListener('ended', onEnded);
                return () => a.removeEventListener('ended', onEnded);
            }, [musicRepeat, musicShuffle, musicQueue, nowPlaying]);


            const toggleInternalSound = (soundId, type) => {
                if (!audioCtxRef.current) audioCtxRef.current = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtxRef.current.state === 'suspended') audioCtxRef.current.resume();
                const ctx = audioCtxRef.current;

                if (activeSounds[soundId]) {
                    const node = audioNodesRef.current[soundId];
                    if (node) { try{node.stop(); node.disconnect();}catch(e){} delete audioNodesRef.current[soundId]; }
                    setActiveSounds(prev => { const n={...prev}; delete n[soundId]; return n; });
                } else {
                    const buffer = createNoiseBuffer(ctx, type);
                    const source = ctx.createBufferSource();
                    source.buffer = buffer;
                    source.loop = true;
                    const gainNode = ctx.createGain();
                    gainNode.gain.value = 0.5 * masterVolume;
                    source.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    source.start();
                    audioNodesRef.current[soundId] = source;
                    source._gainNode = gainNode;
                    setActiveSounds(prev => ({...prev, [soundId]: 0.5}));
                }
            };

            

const updateInternalVolume = (soundId, vol) => {
                const newVol = parseFloat(vol);
                setActiveSounds(prev => ({...prev, [soundId]: newVol}));
                const source = audioNodesRef.current[soundId];
                if (source && source._gainNode) source._gainNode.gain.value = newVol * masterVolume;
            };

            const stopAllSounds = () => {
                Object.keys(audioNodesRef.current).forEach(id => { try{audioNodesRef.current[id].stop(); audioNodesRef.current[id].disconnect();}catch(e){} });
                audioNodesRef.current = {};
                setActiveSounds({});
                setActiveEmbed(null);
            };

            useEffect(() => {
                Object.keys(audioNodesRef.current).forEach(id => {
                    const source = audioNodesRef.current[id];
                    const indVol = activeSounds[id] || 0.5;
                    if(source && source._gainNode) source._gainNode.gain.value = indVol * masterVolume;
                });
            }, [masterVolume]);

            const playAlarm = (pattern = 'triple') => {
                if (!alarmEnabled) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                if (!AudioContext) return;

                // Reuse existing context when possible (more reliable in browsers)
                if (!audioCtxRef.current) audioCtxRef.current = new AudioContext();
                const ctx = audioCtxRef.current;
                if (ctx.state === 'suspended') ctx.resume();

                const master = ctx.createGain();
                master.gain.value = alarmLoud ? 0.9 : 0.45;
                master.connect(ctx.destination);

                const now = ctx.currentTime;
                const beep = (t, f1, f2, dur) => {
                    const osc = ctx.createOscillator();
                    const g = ctx.createGain();
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(f1, t);
                    osc.frequency.exponentialRampToValueAtTime(f2, t + dur);
                    g.gain.setValueAtTime(0.0001, t);
                    g.gain.exponentialRampToValueAtTime(1.0, t + 0.01);
                    g.gain.exponentialRampToValueAtTime(0.0001, t + dur);
                    osc.connect(g);
                    g.connect(master);
                    osc.start(t);
                    osc.stop(t + dur + 0.02);
                };

                if (pattern === 'single') {
                    beep(now, 880, 440, 0.55);
                } else {
                    // triple alarm
                    beep(now + 0.00, 880, 440, 0.55);
                    beep(now + 0.70, 980, 440, 0.55);
                    beep(now + 1.40, 1040, 440, 0.55);
                }
            };

            // Backward compatible name used elsewhere
            const playBeep = () => playAlarm('single');

            // --- PERSISTENCE ---
            useEffect(() => { localStorage.setItem('pomo_tasks', JSON.stringify(tasks)); }, [tasks]);
            useEffect(() => { localStorage.setItem('pomo_exams', JSON.stringify(exams)); }, [exams]);
            useEffect(() => { localStorage.setItem('pomo_notes', notes); }, [notes]);
            useEffect(() => { localStorage.setItem('gemini_api_key', apiKey); }, [apiKey]);
            useEffect(() => { localStorage.setItem('pomo_profile', JSON.stringify(studyProfile)); }, [studyProfile]);
            useEffect(() => { localStorage.setItem('pomo_plan', JSON.stringify(studyPlan)); }, [studyPlan]);
            useEffect(() => { localStorage.setItem('pomo_history', JSON.stringify(stats)); }, [stats]);

            
            useEffect(() => { localStorage.setItem('pomo_focus_enabled', JSON.stringify(focusEnabled)); }, [focusEnabled]);
            useEffect(() => { localStorage.setItem('pomo_ai_governor', JSON.stringify(aiGovernorEnabled)); }, [aiGovernorEnabled]);
            useEffect(() => { localStorage.setItem('pomo_autopilot', JSON.stringify(autoPilotEnabled)); }, [autoPilotEnabled]);
            useEffect(() => { localStorage.setItem('pomo_autopilot_mode', JSON.stringify(autoPilotMode)); }, [autoPilotMode]);
            useEffect(() => { localStorage.setItem('pomo_autopilot_last', JSON.stringify(autoPilotLast)); }, [autoPilotLast]);
            useEffect(() => { localStorage.setItem('pomo_ai_reco', JSON.stringify(aiLastRecommendation)); }, [aiLastRecommendation]);
            useEffect(() => { localStorage.setItem('pomo_sessions', JSON.stringify(sessions)); }, [sessions]);
            useEffect(() => { localStorage.setItem('pomo_tabuse', JSON.stringify(tabUse)); }, [tabUse]);
            useEffect(() => { localStorage.setItem('pomo_impact', JSON.stringify(impactByTopic)); }, [impactByTopic]);
            useEffect(() => { localStorage.setItem('pomo_active_topic', activeStudyTopic || ''); }, [activeStudyTopic]);

            useEffect(() => { localStorage.setItem('pomo_auto_advance', JSON.stringify(autoAdvance)); }, [autoAdvance]);
            useEffect(() => { localStorage.setItem('pomo_auto_start_next', JSON.stringify(autoStartNext)); }, [autoStartNext]);
            useEffect(() => { localStorage.setItem('pomo_alarm_enabled', JSON.stringify(alarmEnabled)); }, [alarmEnabled]);
            useEffect(() => { localStorage.setItem('pomo_alarm_loud', JSON.stringify(alarmLoud)); }, [alarmLoud]);
            useEffect(() => { localStorage.setItem('pomo_tab_alarm_enabled', JSON.stringify(tabAlarmEnabled)); }, [tabAlarmEnabled]);
            useEffect(() => { localStorage.setItem('pomo_adaptive_enabled', JSON.stringify(adaptiveEnabled)); }, [adaptiveEnabled]);
            useEffect(() => { localStorage.setItem('pomo_lfi_enabled', JSON.stringify(lfiEnabled)); }, [lfiEnabled]);

            useEffect(() => { localStorage.setItem('pomo_focus_streak', JSON.stringify(focusStreak)); }, [focusStreak]);
            useEffect(() => { localStorage.setItem('pomo_ai_debriefs', JSON.stringify(aiDebriefs)); }, [aiDebriefs]);

useEffect(() => { localStorage.setItem('pomo_ultra_enabled', JSON.stringify(ultraEnabled)); }, [ultraEnabled]);
useEffect(() => { localStorage.setItem('pomo_ultra_insights', JSON.stringify(ultraInsights)); }, [ultraInsights]);
useEffect(() => { localStorage.setItem('pomo_ultra_goal', JSON.stringify(ultraGoal)); }, [ultraGoal]);
useEffect(() => { localStorage.setItem('pomo_ultra_autotune', JSON.stringify(autoTuneEnabled)); }, [autoTuneEnabled]);
useEffect(() => { localStorage.setItem('pomo_mission_mode', JSON.stringify(missionModeEnabled)); }, [missionModeEnabled]);
useEffect(() => { localStorage.setItem('pomo_mission_priority', missionPriority); }, [missionPriority]);
useEffect(() => { localStorage.setItem('pomo_ai_tactical_state', JSON.stringify(aiTacticalState)); }, [aiTacticalState]);

            useEffect(() => { localStorage.setItem('pomo_high_contrast', JSON.stringify(highContrast)); }, [highContrast]);
            useEffect(() => { localStorage.setItem('pomo_dyslexic_font', JSON.stringify(dyslexicFont)); }, [dyslexicFont]);
            useEffect(() => { localStorage.setItem('pomo_lang', uiLanguage); }, [uiLanguage]);
            useEffect(() => { localStorage.setItem('pomo_privacy_consent', JSON.stringify(privacyConsent)); }, [privacyConsent]);
            useEffect(() => { localStorage.setItem('pomo_privacy_mode', privacyMode); }, [privacyMode]);
            useEffect(() => { localStorage.setItem('pomo_profiles', JSON.stringify(profiles)); }, [profiles]);
            useEffect(() => { localStorage.setItem('pomo_active_profile', activeProfileId); }, [activeProfileId]);

            // --- MUSIC ENGINE v2 persistence ---
            useEffect(() => { localStorage.setItem('pomo_music_provider', musicProvider); }, [musicProvider]);
            useEffect(() => { localStorage.setItem('pomo_music_queue', JSON.stringify(musicQueue)); }, [musicQueue]);
            useEffect(() => { localStorage.setItem('pomo_music_favs', JSON.stringify(musicFavs)); }, [musicFavs]);
            useEffect(() => { localStorage.setItem('pomo_music_now', JSON.stringify(nowPlaying)); }, [nowPlaying]);
            useEffect(() => { localStorage.setItem('pomo_music_vol', String(musicVolume)); }, [musicVolume]);
            useEffect(() => { localStorage.setItem('pomo_music_repeat', JSON.stringify(musicRepeat)); }, [musicRepeat]);
            useEffect(() => { localStorage.setItem('pomo_music_shuffle', JSON.stringify(musicShuffle)); }, [musicShuffle]);
            useEffect(() => { localStorage.setItem('pomo_jamendo_client_id', jamendoClientId); }, [jamendoClientId]);
            useEffect(() => { localStorage.setItem('pomo_jamendo_consent', JSON.stringify(jamendoConsent)); }, [jamendoConsent]);
            useEffect(() => { localStorage.setItem('pomo_mini_player_open', JSON.stringify(miniPlayerOpen)); }, [miniPlayerOpen]);
            useEffect(() => { localStorage.setItem('pomo_mini_player_collapsed', JSON.stringify(miniPlayerCollapsed)); }, [miniPlayerCollapsed]);




// --- TIMER LOGIC ---
            const completionLockRef = useRef(false);

            const runAiSessionDebrief = async ({ endedMode, focusAvg, topic, nextMode, streak }) => {
                if (!apiKey || !aiGovernorEnabled) return null;

                const openTasks = tasks.filter(t => !t.completed).slice(0, 6).map(t => t.title);
                const payload = {
                    endedMode,
                    focusAvg,
                    topic: topic || '',
                    streak,
                    signals,
                    dna,
                    durations,
                    openTasks,
                    lastRecommendation: aiLastRecommendation || null
                };


const runUltraCore = async (source = "manual") => {
    if (!ultraEnabled) return;
    if (!apiKey) { alert("Ayarlar > Gemini API anahtarını gir."); setShowSettings(true); return; }
    setUltraPending(true);
    try {
        const payload = {
            source,
            ts: new Date().toISOString(),
            focusScore,
            focusLabel,
            signals,
            liveDNA,
            durations,
            focusStreak,
            lastReco: aiLastRecommendation || null,
            lastDebrief: (aiDebriefs || []).slice(-1)[0] || null,
            recentSessions: (sessions || []).slice(-12),
            openTasks: (tasks || []).filter(t => !t.completed).slice(0, 8).map(t => t.title),
            activeTopic: (activeStudyTopic || '').trim()
        };
        const insight = await geminiUltraAnalyze({ payload, apiKey, callGeminiFn: callGemini });
        setUltraInsights(prev => [...prev, insight].slice(-20));
        if (insight?.goal) setUltraGoal(insight.goal);

        // auto tune durations ONLY if enabled and values are valid
        if (autoTuneEnabled && insight?.timer_tuning) {
            const t = insight.timer_tuning;
            const nf = clamp(parseInt(t.focus || 0), 0, 50);
            const ns = clamp(parseInt(t.shortBreak || 0), 0, 15);
            const nl = clamp(parseInt(t.longBreak || 0), 0, 30);
            if (nf >= 15 && nf <= 50) setDurations(prev => ({...prev, focus: nf}));
            if (ns >= 4 && ns <= 10) setDurations(prev => ({...prev, shortBreak: ns}));
            if (nl >= 10 && nl <= 25) setDurations(prev => ({...prev, longBreak: nl}));
        }

        // show explainable feedback
        const diag = (insight?.diagnosis || []).slice(0, 3).map(x => `• ${x}`).join("\n");
        const msg = `🧬 ULTRA DNA: ${insight.headline || 'Analiz'}\n${diag ? diag : ''}`.trim();
        setChatMessages(prev => [...prev, { role: 'system', text: msg }]);
        setVoiceFeedback(insight.headline || "Ultra analiz hazır.");
        speakText(insight.headline || "Ultra analiz hazır.");
    } catch (e) {
        console.error(e);
        setChatMessages(prev => [...prev, { role: 'system', text: `⚠️ ULTRA hata: ${e.message || e}` }]);
    } finally {
        setUltraPending(false);
    }
};

                const systemInstruction = `
Sen Pomodoro Student OS içindeki "Teknofest AI Analiz Motoru"sun.
Sadece JSON döndür.
Şema:
{
  "brief": "1-2 cümle Türkçe özet",
  "next_step": "Tek bir net öneri",
  "warning": "Varsa kısa uyarı, yoksa boş string",
  "suggested_next_mode": "focus|shortBreak|longBreak",
  "suggested_timer_minutes": 0,
  "commands": [{"action":"OPEN_TAB","payload":"timer"}]
}
Kurallar:
- suggested_timer_minutes 3..50 arası olsun.
- Açıklamalar kısa ve uygulanabilir olsun.
- Eğer konu boşsa kullanıcıdan 1 soru soracak şekilde brief yaz.
`.trim();

                try {
                    const raw = await callGemini(
                        `Oturum verisi (JSON):\n${JSON.stringify(payload)}\n\nÇıkışı şemaya göre üret.`,
                        systemInstruction
                    );
                    const clean = raw.replace(/```json/g, '').replace(/```/g, '').trim();
                    const j = JSON.parse(clean);

                    const brief = (j.brief || '').toString().slice(0, 220);
                    const next_step = (j.next_step || '').toString().slice(0, 180);
                    const warning = (j.warning || '').toString().slice(0, 160);
                    const suggested_next_mode = ['focus', 'shortBreak', 'longBreak'].includes(j.suggested_next_mode) ? j.suggested_next_mode : nextMode;
                    const suggested_timer_minutes = clamp(parseInt(j.suggested_timer_minutes || 0), 3, 50);
                    const commands = Array.isArray(j.commands) ? j.commands : [];

                    const out = {
                        ts: new Date().toISOString(),
                        brief,
                        next_step,
                        warning,
                        suggested_next_mode,
                        suggested_timer_minutes,
                        commands
                    };

                    setAiDebriefs(prev => [...prev, out].slice(-30));
                    setChatMessages(prev => [...prev, { role: 'system', text: `🧠 AI Analiz: ${brief}\n➡️ ${next_step}${warning ? `\n⚠️ ${warning}` : ''}` }]);
                    setVoiceFeedback(brief);
                    speakText(brief);

                    // Optional: let AI tune the next timer (non-destructive)
                    if (suggested_timer_minutes && suggested_next_mode === nextMode) {
                        // Only auto-adjust the duration for the selected mode (keeps user control)
                        setDurations(prev => ({ ...prev, [suggested_next_mode]: suggested_timer_minutes }));
                    }

                    commands.forEach(cmd => executeCommand(cmd));
                    return out;
                } catch (e) {
                    return null;
                }
            };

            const handleTimerComplete = async () => {
                // Prevent double firing (some browsers can trigger multiple renders at 0)
                if (completionLockRef.current) return;
                completionLockRef.current = true;

                clearInterval(timerRef.current);
                setIsActive(false);
                setPauseCount(0);

                // Always alarm at completion
                playAlarm('triple');

                // Decide next mode
                let nextMode = 'focus';
                let nextStreak = focusStreak;

                if (mode === 'focus') {
                    nextStreak = focusStreak + 1;
                    const isLong = (nextStreak % 4 === 0);
                    nextMode = isLong ? 'longBreak' : 'shortBreak';

                    const today = new Date().toISOString().split('T')[0];
                    setStats(prev => [...prev, { date: today, duration: durations.focus }]);

                    // --- TEKNOFEST AI CORE: session log (focusAvg + topic) ---
                    const focusArr = focusSamplesRef.current || [];
                    const focusAvg = focusArr.length ? Math.round(focusArr.reduce((a, b) => a + b, 0) / focusArr.length) : focusScore;
                    const topic = (activeStudyTopic || '').trim();

                    const tabNow = signals?.tabLeaves || 0;
                    const tabDelta = Math.max(0, tabNow - (tabLeavesStartRef.current || 0));
                    const disScore = computeDistractionScore();
                    const lfiNow = (typeof liveFocusIndex === 'number' ? liveFocusIndex : focusAvg);

                    setSessions(prev => [...prev, {
                        ts: new Date().toISOString(),
                        blockMins: durations.focus,
                        focusAvg,
                        lfi: lfiNow,
                        distraction: disScore,
                        tabDelta,
                        idleEndSec: signals?.idleSec || 0,
                        topic
                    }]);

                    // --- Adaptive Duration AI (local heuristic) ---
                    if (adaptiveEnabled && !aiGovernorEnabled) {
                        const nextHist = [...(sessions || []), { ts: new Date().toISOString(), blockMins: durations.focus, focusAvg, lfi: lfiNow, distraction: disScore, tabDelta, idleEndSec: signals?.idleSec || 0, topic }];
                        const reco = computeAdaptiveRecommendation(nextHist, durations);
                        if (reco) {
                            setDurations(prev => ({ ...prev, focus: reco.focus, shortBreak: reco.shortBreak, longBreak: reco.longBreak }));
                            setAiLastRecommendation(`Adaptive AI: ${reco.focus}/${reco.shortBreak}/${reco.longBreak} (LFI≈${reco.avgLfi}, Dis≈${reco.avgDis})`);
                        }
                    }

                    focusSamplesRef.current = [];
                    setFocusStreak(nextStreak);

                    // Lightweight DNA tuning (kept)
                    if (aiGovernorEnabled) {
                        aiComputeDNATuning().then(reco => {
                            if (reco) {
                                setDurations(prev => ({ ...prev, focus: reco.focus, shortBreak: reco.shortBreak, longBreak: reco.longBreak }));
                                setVoiceFeedback(`AI: Bir sonraki odak süresi ${reco.focus}dk. ${reco.why || ''}`);
                                setTimeout(() => setVoiceFeedback(''), 5000);
                            }
                        });
                    }

                    // Full debrief
                    runAiSessionDebrief({ endedMode: 'focus', focusAvg, topic, nextMode, streak: nextStreak });
                    // ULTRA CORE: auto analysis after focus session
                    runUltraCore('session_end');
                    if (autoPilotEnabled) { autoPilotTuneNow('session_end', { silent: true, apply: true }); }

                } else {
                    // Break finished -> back to focus
                    nextMode = 'focus';
                    // Brief debrief on breaks too (optional, cheap)
                    runAiSessionDebrief({ endedMode: mode, focusAvg: null, topic: (activeStudyTopic || '').trim(), nextMode, streak: focusStreak });
                }

                // Auto advance logic
                if (autoAdvance) {
                    setMode(nextMode);
                    const nextSeconds = (durations[nextMode] || 5) * 60;
                    setTimeLeft(nextSeconds);
                    if (autoStartNext) {
                        // slight delay to let state settle + UI update
                        setTimeout(() => setIsActive(true), 120);
                    }
                }

                // release lock after a short time
                setTimeout(() => { completionLockRef.current = false; }, 800);
            };

            // Interval runner (robust)
            useEffect(() => {
                if (!isActive) return;

                // Reset completion lock when timer starts
                completionLockRef.current = false;

                clearInterval(timerRef.current);
                timerRef.current = setInterval(() => {
                    setTimeLeft(p => (p <= 1 ? 0 : p - 1));
                }, 1000);

                return () => clearInterval(timerRef.current);
            }, [isActive]);

            // Completion watcher
            useEffect(() => {
                if (timeLeft !== 0) return;
                if (!isActive && completionLockRef.current) return; // already handled
                handleTimerComplete();
            }, [timeLeft, mode, isActive]);
            
            // --- TEKNOFEST AI CORE: tab usage + focus sampling ---
            useEffect(() => {
                setTabUse(prev => ({ ...prev, [activeTab]: (prev[activeTab] || 0) + 1 }));
            }, [activeTab]);

            useEffect(() => {
                if (!focusEnabled) return;
                if (isActive && mode === 'focus') {
                    focusSamplesRef.current.push(focusScore);
                    if (focusSamplesRef.current.length > 120) focusSamplesRef.current.shift(); // ~10 dk @5s
                }
            }, [focusScore, focusEnabled, isActive, mode]);
useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [chatMessages, isAiProcessing]);
            useEffect(() => { tutorEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [tutorMessages]);

            // --- VOICE & SPEECH HELPERS ---
            const speakText = (text) => {
                if (!voiceEnabled || !window.speechSynthesis) return;
                
                if (recognitionRef.current) {
                    try { recognitionRef.current.stop(); } catch(e){}
                }
                isSystemSpeakingRef.current = true; 

                window.speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'tr-TR';
                utterance.rate = 1.0;
                
                utterance.onend = () => {
                    isSystemSpeakingRef.current = false; 
                    if (isGlobalVoiceActive && recognitionRef.current) {
                        try { recognitionRef.current.start(); } catch(e){}
                    }
                };

                window.speechSynthesis.speak(utterance);
            };

            // --- CONTINUOUS VOICE RECOGNITION EFFECT ---
            useEffect(() => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return;
                
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!recognitionRef.current) {
                    const recognition = new SpeechRecognition();
                    recognition.lang = 'tr-TR';
                    recognition.continuous = true; 
                    recognition.interimResults = false;

                    recognition.onresult = (event) => {
                        if (isSystemSpeakingRef.current) return;

                        const transcript = event.results[event.results.length - 1][0].transcript.trim();
                        if(!transcript) return;

                        console.log("Duyulan:", transcript);
                        setVoiceFeedback(transcript);
                        setTimeout(() => setVoiceFeedback(''), 3000);
                        
                        handleChatSend(transcript, true); 
                    };

                    recognition.onend = () => {
                        if (isGlobalVoiceActive && !isSystemSpeakingRef.current) {
                            try { recognition.start(); } catch(e) {}
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error("Speech error", event.error);
                        if (event.error === 'not-allowed') setIsGlobalVoiceActive(false);
                    };

                    recognitionRef.current = recognition;
                }

                const recognition = recognitionRef.current;
                if (isGlobalVoiceActive) {
                    try { recognition.start(); } catch(e) {}
                } else {
                    try { recognition.stop(); } catch(e) {}
                }

                return () => {
                    try { recognition.stop(); } catch(e) {}
                };
            }, [isGlobalVoiceActive]); 

            const toggleGlobalVoice = () => {
                if (!apiKey) {
                    alert("Lütfen önce ayarlardan Gemini API anahtarını girin.");
                    setShowSettings(true);
                    return;
                }
                setIsGlobalVoiceActive(!isGlobalVoiceActive);
            };

            // --- MASTER COMMAND CENTER (AI LOGIC) ---
            const normalizeTr = (v = '') => {
                const lowered = (v || '').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
                return lowered.split('').map(ch => (ch.charCodeAt(0) === 305 ? 'i' : ch)).join('').trim();
            };

            const buildTacticalSnapshot = () => {
                const recent = (sessions || []).slice(-10);
                const avgLfi = recent.length ? (recent.reduce((a, x) => a + (x.lfi || x.focusAvg || 0), 0) / recent.length) : (focusScore || 0);
                const avgDis = recent.length ? (recent.reduce((a, x) => a + ((typeof x.distraction === 'number' ? x.distraction : 0)), 0) / recent.length) : 0;
                const openTasks = (tasks || []).filter(t => !t.completed).length;
                return {
                    ts: new Date().toISOString(),
                    focusScore,
                    focusLabel,
                    avgLfi: Math.round(avgLfi),
                    avgDis: Number(avgDis.toFixed(2)),
                    tabLeaves: signals?.tabLeaves || 0,
                    idleSec: signals?.idleSec || 0,
                    openTasks,
                    mode,
                    durations,
                    missionModeEnabled,
                    missionPriority,
                    activeTopic: (activeStudyTopic || '').trim()
                };
            };

            const deriveRiskLevel = (snapshot) => {
                const s = snapshot || buildTacticalSnapshot();
                let risk = 0;
                risk += clamp((65 - (s.focusScore || 0)) / 65, 0, 1) * 0.50;
                risk += clamp((s.idleSec || 0) / 30, 0, 1) * 0.25;
                risk += clamp((s.tabLeaves || 0) / 5, 0, 1) * 0.15;
                risk += clamp((s.openTasks || 0) / 12, 0, 1) * 0.10;
                if (risk >= 0.62) return 'high';
                if (risk >= 0.33) return 'medium';
                return 'low';
            };

            const toNumberOrNull = (v) => {
                const n = Number(v);
                return Number.isFinite(n) ? n : null;
            };

            const parseAiJson = (raw) => {
                try {
                    const cleanJson = (raw || '').replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleanJson);
                } catch {
                    return { response_text: (raw || '').toString(), commands: [] };
                }
            };

            const applyTacticalState = (partial = {}) => {
                const snap = buildTacticalSnapshot();
                const riskLevel = partial.risk_level || deriveRiskLevel(snap);
                const confidence = clamp(toNumberOrNull(partial.confidence) ?? (riskLevel === 'high' ? 0.62 : riskLevel === 'medium' ? 0.76 : 0.88), 0.4, 0.99);
                const next = {
                    ts: new Date().toISOString(),
                    confidence: Number(confidence.toFixed(2)),
                    risk_level: riskLevel,
                    mission_update: (partial.mission_update || '').toString().slice(0, 180),
                    source: (partial.source || 'chat').toString().slice(0, 32),
                    snapshot: snap
                };
                setAiTacticalState(next);
                return next;
            };

            const tryLocalTacticalCommand = async ({ normalizedCmd, isSilent }) => {
                const cmd = normalizeTr(normalizedCmd);

                if (cmd === 'otomatik ayarla' || cmd === '/auto' || cmd === 'auto ayarla' || cmd === 'autopilot') {
                    await autoPilotTuneNow('chat_command', { silent: false, apply: true });
                    applyTacticalState({ source: 'local', mission_update: 'AutoPilot local command executed.' });
                    return true;
                }

                if (cmd === '/ultra' || cmd === 'ultra analiz' || cmd === 'dna analiz' || cmd === 'teknofest analiz') {
                    await runUltraCore('chat_command');
                    applyTacticalState({ source: 'local', mission_update: 'Ultra analysis started.' });
                    return true;
                }

                if (cmd.includes('gorev modu ac') || cmd.includes('mission mode on')) {
                    setMissionModeEnabled(true);
                    if (!isSilent) setChatMessages(prev => [...prev, { role: 'system', text: 'Mission mode enabled. AI will prioritize target-oriented actions.' }]);
                    applyTacticalState({ source: 'local', mission_update: 'Mission mode enabled.' });
                    return true;
                }

                if (cmd.includes('gorev modu kapat') || cmd.includes('mission mode off')) {
                    setMissionModeEnabled(false);
                    if (!isSilent) setChatMessages(prev => [...prev, { role: 'system', text: 'Mission mode disabled. Back to standard AI behavior.' }]);
                    applyTacticalState({ source: 'local', mission_update: 'Mission mode disabled.' });
                    return true;
                }

                if (cmd === '/durum' || cmd.includes('durum raporu') || cmd.includes('risk analizi')) {
                    const snap = buildTacticalSnapshot();
                    const risk = deriveRiskLevel(snap);
                    const msg = `Tactical status: Risk ${risk.toUpperCase()} | Focus ${snap.focusScore}/100 | LFI~${snap.avgLfi} | Idle ${snap.idleSec}s | Tasks ${snap.openTasks}`;
                    if (!isSilent) setChatMessages(prev => [...prev, { role: 'system', text: msg }]);
                    setVoiceFeedback(msg);
                    applyTacticalState({ source: 'local', risk_level: risk, mission_update: 'Tactical report generated.' });
                    return true;
                }

                if (cmd.includes('oncelik sprint')) { setMissionPriority('sprint'); return true; }
                if (cmd.includes('oncelik precision') || cmd.includes('oncelik hassas')) { setMissionPriority('precision'); return true; }
                if (cmd.includes('oncelik dengeli') || cmd.includes('oncelik balanced')) { setMissionPriority('balanced'); return true; }

                return false;
            };

            const sanitizeAiCommands = (arr) => {
                const allowed = new Set([
                    'SET_TIMER', 'START_TIMER', 'PAUSE_TIMER', 'SET_MODE', 'ADD_TASK', 'ADD_NOTE',
                    'PLAY_SOUND', 'STOP_SOUNDS', 'SET_THEME', 'OPEN_TAB', 'GENERATE_PLAN',
                    'ENABLE_BREATH', 'TOGGLE_ZEN', 'CLEAR_TASKS', 'RUN_ULTRA_ANALYSIS',
                    'APPLY_AUTOPILOT', 'SET_TOPIC', 'START_TOPIC_FOCUS', 'MISSION_MODE', 'SET_AUTOPILOT_MODE', 'OPEN_SETTINGS'
                ]);
                return (Array.isArray(arr) ? arr : [])
                    .filter(x => x && allowed.has((x.action || '').toString()))
                    .slice(0, 6)
                    .map(x => ({ action: x.action, payload: x.payload }));
            };

            const handleChatSend = async (overrideText = null, isSilent = false) => {
                const textToSend = overrideText || chatInput;
                if (!textToSend.trim()) return;

                const normalizedCmd = normalizeTr(textToSend);
                if (!isSilent) setChatMessages(prev => [...prev, { role: 'user', text: textToSend }]);
                setChatInput('');

                if (await tryLocalTacticalCommand({ normalizedCmd, isSilent })) return;

                if (!apiKey) {
                    const msg = "Please set API key in Settings.";
                    setChatMessages(prev => [...prev, { role: 'system', text: msg }]);
                    applyTacticalState({ source: 'fallback', risk_level: deriveRiskLevel(), mission_update: 'No API key. Local mode only.' });
                    return;
                }

                setIsAiProcessing(true);
                const watchdog = setTimeout(() => {
                    setIsAiProcessing(false);
                    if (isGlobalVoiceActive) setVoiceFeedback('Timeout');
                }, 60000);

                const tacticalSnapshot = buildTacticalSnapshot();
                const riskHint = deriveRiskLevel(tacticalSnapshot);
                const systemPrompt = `
You are the Teknofest Mission AI inside Pomodoro Student OS.
Return JSON only.
Schema:
{
  "response_text": "short response",
  "confidence": 0.0,
  "risk_level": "low|medium|high",
  "mission_update": "single sentence",
  "commands": [{"action": "...", "payload": "..."}]
}
Rules:
- Keep response short and actionable.
- Never output unsafe commands.
- Max 4 commands.
- If risk is high, prioritize focus recovery.
Actions:
SET_TIMER, START_TIMER, PAUSE_TIMER, SET_MODE, ADD_TASK, ADD_NOTE, PLAY_SOUND, STOP_SOUNDS, SET_THEME, OPEN_TAB, GENERATE_PLAN, ENABLE_BREATH, TOGGLE_ZEN, CLEAR_TASKS, RUN_ULTRA_ANALYSIS, APPLY_AUTOPILOT, SET_TOPIC, START_TOPIC_FOCUS, MISSION_MODE, SET_AUTOPILOT_MODE, OPEN_SETTINGS
                `.trim();

                const userPayload = {
                    user_message: textToSend,
                    tactical_snapshot: tacticalSnapshot,
                    live_dna: liveDNA,
                    auto_pilot_last: autoPilotLast || null,
                    mission_mode: missionModeEnabled,
                    mission_priority: missionPriority,
                    risk_hint: riskHint,
                    queue_length: queueLength
                };

                try {
                    const rawResponse = await callGemini(JSON.stringify(userPayload), systemPrompt);
                    const parsed = parseAiJson(rawResponse);
                    const responseText = (parsed.response_text || 'Command processed.').toString().slice(0, 320);
                    const commands = sanitizeAiCommands(parsed.commands);
                    const tactical = applyTacticalState({
                        source: 'gemini',
                        confidence: parsed.confidence,
                        risk_level: parsed.risk_level,
                        mission_update: parsed.mission_update
                    });

                    const missionLine = tactical?.mission_update ? `
Mission: ${tactical.mission_update}` : '';
                    const riskLine = `
Risk: ${(tactical?.risk_level || 'medium').toUpperCase()} | Confidence: ${Math.round((tactical?.confidence || 0.75) * 100)}%`;
                    const finalText = `${responseText}${missionLine}${riskLine}`;

                    if (!isSilent) setChatMessages(prev => [...prev, { role: 'system', text: finalText }]);
                    if (isGlobalVoiceActive) setVoiceFeedback(responseText);
                    speakText(responseText);

                    commands.forEach(cmd => executeCommand(cmd));

                    if (commands.length) {
                        const tacticalInsight = {
                            ts: new Date().toISOString(),
                            headline: `Tactical Command | ${(tactical?.risk_level || 'medium').toUpperCase()}`,
                            diagnosis: [
                                `Confidence ${Math.round((tactical?.confidence || 0.75) * 100)}%`,
                                `Command count ${commands.length}`,
                                `Priority ${missionPriority}`
                            ]
                        };
                        setUltraInsights(prev => [...prev, tacticalInsight].slice(-20));
                    }
                } catch (error) {
                    console.error(error);
                    setChatMessages(prev => [...prev, { role: 'system', text: `Error: ${error.message || 'Unknown error'}` }]);
                } finally {
                    clearTimeout(watchdog);
                    setIsAiProcessing(false);
                    setTimeout(() => setVoiceFeedback(''), 5000);
                }
            };

            const executeCommand = (cmd) => {
                switch (cmd.action) {
                    case 'SET_TIMER': {
                        const mins = parseInt(cmd.payload, 10);
                        if (!isNaN(mins)) { setIsActive(false); setTimeLeft(clamp(mins, 1, 90) * 60); }
                        break;
                    }
                    case 'START_TIMER': setIsActive(true); break;
                    case 'PAUSE_TIMER': if (isActive && mode === 'focus') setPauseCount(c => c + 1); setIsActive(false); break;
                    case 'SET_MODE':
                        if (durations[cmd.payload]) { setMode(cmd.payload); setTimeLeft(durations[cmd.payload] * 60); setIsActive(false); setPauseCount(0); }
                        break;
                    case 'ADD_TASK':
                        if ((cmd.payload || '').toString().trim()) setTasks(prev => [...prev, { id: Date.now(), title: String(cmd.payload), completed: false }]);
                        break;
                    case 'ADD_NOTE':
                        if ((cmd.payload || '').toString().trim()) setNotes(prev => prev + "\n- " + cmd.payload);
                        break;
                    case 'PLAY_SOUND': {
                        const soundPayload = (cmd.payload || '').toString();
                        if (soundPayload.startsWith('spotify')) {
                            const preset = MEDIA_PRESETS.find(p => p.id === soundPayload);
                            if (preset) setActiveEmbed(preset);
                        } else if (soundPayload) {
                            toggleInternalSound(soundPayload, soundPayload === 'rain' ? 'pink' : soundPayload === 'wind' ? 'brown' : 'white');
                        }
                        break;
                    }
                    case 'STOP_SOUNDS': stopAllSounds(); break;
                    case 'SET_THEME': if (BACKGROUNDS[cmd.payload]) setCurrentSeason(cmd.payload); break;
                    case 'OPEN_TAB': if ((cmd.payload || '').toString()) setActiveTab(cmd.payload); break;
                    case 'GENERATE_PLAN': generateStudyPlan(); setActiveTab('planner'); break;
                    case 'ENABLE_BREATH': setBreathMode(true); break;
                    case 'TOGGLE_ZEN': setZenMode(cmd.payload === 'on' || !zenMode); break;
                    case 'CLEAR_TASKS': setTasks([]); break;
                    case 'RUN_ULTRA_ANALYSIS': runUltraCore('ai_command'); break;
                    case 'APPLY_AUTOPILOT': autoPilotTuneNow('ai_command', { silent: false, apply: true }); break;
                    case 'SET_TOPIC':
                        if ((cmd.payload || '').toString().trim()) setActiveStudyTopic((cmd.payload || '').toString().trim());
                        break;
                    case 'START_TOPIC_FOCUS':
                        startTopicFocus((cmd.payload || activeStudyTopic || '').toString());
                        break;
                    case 'MISSION_MODE':
                        setMissionModeEnabled(cmd.payload === 'on' || cmd.payload === true || cmd.payload === 'true');
                        break;
                    case 'SET_AUTOPILOT_MODE':
                        if (cmd.payload === 'adaptive' || cmd.payload === 'aggressive') setAutoPilotMode(cmd.payload);
                        break;
                    case 'OPEN_SETTINGS':
                        setShowSettings(true);
                        break;
                    default: break;
                }
            };

            
// --- AI INFOGRAPHIC GENERATOR ---
            const generateAiInfographic = async () => {
                if(!aiTopic.trim()) return;
                setIsAiWorking(true);
                setInfographicData(null); setAiImage(null);
                
                // Enhanced Prompt for structured "Infographic" data
                const prompt = `
                    Konu: "${aiTopic}".
                    Bu konuyu 5 yaşındaki bir çocuğa anlatır gibi ama aynı zamanda bir lise öğrencisinin işine yarayacak kadar bilgi içeren, renkli, eğlenceli ve görsel bir anlatım istiyorum.
                    
                    Bana şu JSON formatında cevap ver:
                    {
                        "title": "Konu Başlığı",
                        "simple_explanation": "Konuyu en basit, hikayeleştirilmiş haliyle anlat (EL5).",
                        "key_points": ["Önemli madde 1 (emojili)", "Önemli madde 2 (emojili)", "Önemli madde 3 (emojili)"],
                        "fun_fact": "Konuyla ilgili şaşırtıcı bir 'Biliyor muydunuz?' bilgisi.",
                        "analogy": "Konuyu gerçek hayattan bir şeye benzet (Metafor/Analoji). Örn: Hücre bir fabrikadır...",
                        "image_prompt": "Vector illustration of ${aiTopic}, educational, colorful, infographic style, minimal background, bright colors"
                    }
                `;

                try {
                    const res = await callGemini(prompt);
                    const data = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                    setInfographicData(data);
                    
                    if(data.image_prompt) {
                        // Using pollinations.ai with optimized prompt for infographic feel
                        const encodedPrompt = encodeURIComponent(data.image_prompt + " vector art, flat design, vibrant");
                        setAiImage(`https://image.pollinations.ai/prompt/${encodedPrompt}?width=800&height=600&nologo=true&seed=${Math.random()}`);
                    }
                } catch(e) {
                    alert("İnfografik oluşturulamadı: " + e.message);
                } finally {
                    setIsAiWorking(false);
                }
            };

            
            // --- TEKNOFEST AI CORE: Micro-Tests + Impact + DNA ---
            const generateMicroTest = async (topic, kind = 'pre') => {
                if (!apiKey) { alert("API Anahtarı eksik."); setShowSettings(true); return; }
                if (!topic?.trim()) { alert("Konu gir."); return; }
                setIsGeneratingTest(true);
                try {
                    const prompt = `
Konu: "${topic}".
Amaç: 3 soruluk mikro test.
Format: JSON döndür.
Zorluk: Lise seviyesi, net ve ölçülebilir.
Şema:
{
  "topic": "${topic}",
  "questions": [
    { "q": "Soru", "choices": ["A","B","C","D"], "correct": 0, "explain": "Kısa gerekçe" }
  ]
}
Kurallar:
- 3 soru olsun.
- choices 4 şık olsun.
- correct 0-3 arası index olsun.
- explain 1-2 cümle olsun.
`;
                    const res = await callGemini(prompt);
                    const clean = res.replace(/```json/g,'').replace(/```/g,'').trim();
                    const test = JSON.parse(clean);

                    if (kind === 'pre') {
                        setPreTest(test); setPreAnswers({}); setPreResult(null);
                    } else {
                        setPostTest(test); setPostAnswers({}); setPostResult(null);
                    }
                } catch (e) {
                    alert("Test üretilemedi: " + (e.message || e));
                } finally {
                    setIsGeneratingTest(false);
                }
            };

            const submitMicroTest = (kind = 'pre') => {
                const test = kind === 'pre' ? preTest : postTest;
                const answers = kind === 'pre' ? preAnswers : postAnswers;
                const r = scoreTest(test, answers);
                const out = { ...r, acc: r.acc };
                if (kind === 'pre') setPreResult(out);
                else setPostResult(out);
            };

            const finalizeImpactForTopic = (topic) => {
                const t = (topic || '').trim();
                if (!t) return;
                if (!preResult || !postResult) { alert("Ön test ve son test tamamlanmalı."); return; }

                // Sessions for topic in last 7 days
                const weekAgo = Date.now() - 7*24*60*60*1000;
                const topicSessions = sessions.filter(s => (s.topic||'').trim().toLowerCase() === t.toLowerCase() && new Date(s.ts).getTime() >= weekAgo);
                const focusedMinutes = topicSessions.reduce((a,s)=>a+(s.blockMins||0),0);
                const focusAvg = topicSessions.length ? Math.round(topicSessions.reduce((a,s)=>a+(s.focusAvg||0),0)/topicSessions.length) : focusScore;

                const prior = impactByTopic[t]?.repeats || 0;
                const repeats = topicSessions.length;

                const score = computeImpactScore({
                    preAcc: preResult.acc,
                    postAcc: postResult.acc,
                    focusAvg,
                    focusedMinutes,
                    repeats,
                    priorRepeats: Math.max(prior, repeats)
                });

                setImpactByTopic(prev => ({
                    ...prev,
                    [t]: {
                        topic: t,
                        lastUpdated: new Date().toISOString(),
                        pre: preResult,
                        post: postResult,
                        focusAvg,
                        focusedMinutes,
                        repeats,
                        impactScore: score
                    }
                }));
            };

            const dna = useMemo(() => buildDNA({ sessions, tabUse }), [sessions, tabUse]);

const liveDNA = useMemo(() => buildLiveDNAv2({ sessions, tabUse }), [sessions, tabUse]);

            const clamp01 = (x) => clamp(x, 0, 1);

            const computeTaskCompletion = () => {
                const all = Array.isArray(tasks) ? tasks : [];
                if (!all.length) return 0.55; // neutral default
                const done = all.filter(t => t?.done).length;
                return done / all.length;
            };

            const computeDistractionScore = () => {
                // 0 (clean) -> 1 (very distracted)
                const idle = clamp01((signals?.idleSec || 0) / 25);
                // tab delta since focus start
                const tabNow = signals?.tabLeaves || 0;
                const tabDelta = Math.max(0, tabNow - (tabLeavesStartRef.current || 0));
                const tab = clamp01(tabDelta / 3);
                return clamp01(idle * 0.55 + tab * 0.45);
            };

            const liveFocusIndex = useMemo(() => {
                if (!lfiEnabled) return null;
                const focus = clamp01((focusScore || 0) / 100);
                const completion = computeTaskCompletion(); // 0..1
                const distraction = computeDistractionScore(); // 0..1
                // Consistency proxy: fewer pauses + stable activity => better
                const pausePenalty = clamp01((pauseCount || 0) / 6);
                const consistency = clamp01(1 - pausePenalty);

                const lfi = clamp01(
                    focus * 0.52 +
                    completion * 0.22 +
                    consistency * 0.18 -
                    distraction * 0.20
                );
                return Math.round(lfi * 100);
            }, [lfiEnabled, focusScore, signals, tasks, pauseCount, isActive, mode]);

            const computeAdaptiveRecommendation = (histSessions, currentDurations) => {
                const recent = (histSessions || []).slice(-12);
                if (recent.length < 4) return null;

                const avgFocus = recent.reduce((a, s) => a + (s.focusAvg || 0), 0) / recent.length;
                const avgLfi = recent.reduce((a, s) => a + (s.lfi || s.focusAvg || 0), 0) / recent.length;
                const avgDis = recent.reduce((a, s) => a + (s.distraction || 0), 0) / recent.length;

                // Heuristic: reward sustained high quality, punish distractions
                let focusM = currentDurations.focus;
                if (avgLfi >= 80 && avgDis <= 0.25) focusM += 2;
                else if (avgLfi <= 58 || avgDis >= 0.55) focusM -= 2;
                else if (avgLfi <= 68 && avgDis >= 0.40) focusM -= 1;

                focusM = clamp(focusM, 15, 50);

                // Breaks scale lightly with focus minutes
                let shortB = currentDurations.shortBreak;
                let longB = currentDurations.longBreak;
                shortB = clamp(Math.round(focusM >= 35 ? 7 : focusM >= 28 ? 6 : 5), 4, 10);
                longB = clamp(Math.round(focusM >= 40 ? 18 : focusM >= 32 ? 15 : 13), 10, 25);

                return { focus: focusM, shortBreak: shortB, longBreak: longB, avgLfi: Math.round(avgLfi), avgDis: Number(avgDis.toFixed(2)) };
            };

            const computeWeeklyGrowth = (histSessions) => {
                const now = Date.now();
                const dayMs = 24 * 60 * 60 * 1000;
                const within = (s, from, to) => {
                    const t = Date.parse(s.ts || '') || 0;
                    return t >= from && t < to;
                };
                const w1Start = now - 7 * dayMs;
                const w0Start = now - 14 * dayMs;

                const w1 = (histSessions || []).filter(s => within(s, w1Start, now));
                const w0 = (histSessions || []).filter(s => within(s, w0Start, w1Start));

                const agg = (arr) => {
                    const blocks = arr.length;
                    const mins = arr.reduce((a, s) => a + (s.blockMins || 0), 0);
                    const lfi = arr.length ? arr.reduce((a, s) => a + (s.lfi || s.focusAvg || 0), 0) / arr.length : 0;
                    const dis = arr.length ? arr.reduce((a, s) => a + (s.distraction || 0), 0) / arr.length : 0;
                    return { blocks, mins, lfi: Math.round(lfi), dis: Number(dis.toFixed(2)) };
                };
                const A = agg(w0), B = agg(w1);
                const pct = (b, a) => (a ? Math.round(((b - a) / a) * 100) : (b ? 100 : 0));
                return {
                    prev: A,
                    current: B,
                    delta: {
                        minsPct: pct(B.mins, A.mins),
                        lfiPct: pct(B.lfi, A.lfi),
                        disPct: pct(A.dis - B.dis, A.dis) // reduction is good
                    }
                };
            };

            const weekly = useMemo(() => computeWeeklyGrowth(sessions), [sessions]);


            async function aiComputeDNATuning() {
                if (!aiGovernorEnabled) return null;
                if (!apiKey) return null;

                // Compact, explainable context for Gemini (avoid heavy payload)
                const recent = (sessions || []).slice(-30).map(s => ({
                    ts: s.ts,
                    blockMins: s.blockMins,
                    focusAvg: s.focusAvg,
                    topic: s.topic || ''
                }));

                const impactTop = Object.entries(impactByTopic || {}).slice(0, 12).map(([k, v]) => ({
                    topic: k,
                    impact: v?.impactScore || v?.score || v?.impact || v?.value || 0,
                    repeats: v?.repeats || 0
                }));

                const prompt = `
Sen "Pomodoro Student OS" içindeki Teknofest AI Çekirdeğisin.
Görev: Kullanıcı için OPTİMUM süreleri hesapla. Sadece JSON dön.
Kısıtlar:
- focus (dk) 15..50
- shortBreak (dk) 3..12
- longBreak (dk) 10..30
- Toplam program güvenli olsun, uç değer verme.
- Eğer veri azsa bile tahmin yap (sadece 25 demek yok). Kullanıcının odak puanı ve davranışına göre öner.
Girdi (son 30 oturum):
${JSON.stringify(recent)}
Girdi (impact özet):
${JSON.stringify(impactTop)}
Kullanıcı profili:
${JSON.stringify(studyProfile || {})}

ÇIKTI JSON:
{
  "focus": 0,
  "shortBreak": 0,
  "longBreak": 0,
  "why": "1 cümle"
}
`.trim();

                try {
                    const raw = await callGemini(prompt);
                    const clean = raw.replace(/```json/g,'').replace(/```/g,'').trim();
                    const j = JSON.parse(clean);
                    const focus = clamp(parseInt(j.focus), 15, 50);
                    const shortBreak = clamp(parseInt(j.shortBreak), 3, 12);
                    const longBreak = clamp(parseInt(j.longBreak), 10, 30);
                    const why = (j.why || '').toString().slice(0, 180);

                    const reco = { focus, shortBreak, longBreak, why, ts: new Date().toISOString() };
                    setAiLastRecommendation(reco);
                    return reco;
                } catch (e) {
                    return null;
                }
            };

            const applyDNATuning = async () => {
                // Gemini varsa onun önerisini kullan, yoksa DNA heuristiğine düş
                let best = dna?.bestFocusMins || 25;
                let sb = durations.shortBreak;
                let lb = durations.longBreak;
                let why = '';

                const reco = await aiComputeDNATuning();
                if (reco) {
                    best = reco.focus;
                    sb = reco.shortBreak;
                    lb = reco.longBreak;
                    why = reco.why || '';
                }

                setIsActive(false);
                setDurations(prev => ({ ...prev, focus: best, shortBreak: sb, longBreak: lb }));
                setMode('focus');
                setTimeLeft(best * 60);

                if (aiGovernorEnabled && why) {
                    setVoiceFeedback(`AI: ${best}dk önerildi. ${why}`);
                    setTimeout(() => setVoiceFeedback(''), 5000);
                }
            };

            
            const autoPilotTuneNow = async (reason = 'manual', opts = {}) => {
                const { silent = false, apply = true } = opts || {};
                // Prevent overlapping calls
                if (autoPilotLockRef.current) return null;
                autoPilotLockRef.current = true;

                try {
                    // 1) Local baseline (always available)
                    const hist = (sessions || []).slice(-40);
                    const localReco = computeAdaptiveRecommendation(hist, durations) || null;

                    // 2) Gemini tuning (if available)
                    let gemReco = null;
                    if (apiKey) {
                        // Prefer the dedicated tuner (compact + stable)
                        gemReco = await aiComputeDNATuning();
                    }

                    // 3) Select best recommendation with safety rails
                    const pick = (gemReco || localReco);
                    if (!pick) {
                        if (!silent) {
                            setChatMessages(prev => [...prev, { role: 'system', text: '⚠️ Otomatik ayar için yeterli veri yok. 1-2 oturum daha yap.' }]);
                        }
                        return null;
                    }

                    // Mode-specific aggressiveness
                    let focus = clamp(parseInt(pick.focus), 15, autoPilotMode === 'aggressive' ? 55 : 50);
                    let shortBreak = clamp(parseInt(pick.shortBreak), 3, autoPilotMode === 'aggressive' ? 14 : 12);
                    let longBreak = clamp(parseInt(pick.longBreak), 10, autoPilotMode === 'aggressive' ? 35 : 30);

                    // If focus is very low recently, shorten blocks slightly; if high, lengthen.
                    const recentFocus = (hist || []).slice(-10).map(s => s.focusAvg).filter(x => typeof x === 'number');
                    const avgFocus = recentFocus.length ? (recentFocus.reduce((a,b)=>a+b,0)/recentFocus.length) : null;
                    if (avgFocus !== null) {
                        if (avgFocus < 55) focus = clamp(focus - 2, 15, 55);
                        if (avgFocus > 78) focus = clamp(focus + 2, 15, 55);
                    }

                    const out = {
                        focus, shortBreak, longBreak,
                        avgLfi: pick.avgLfi ?? null,
                        avgDis: pick.avgDis ?? null,
                        why: pick.why || (gemReco ? 'Gemini: kişiselleştirilmiş süre ayarı.' : 'Yerel adaptif model: süre ayarı.'),
                        reason,
                        ts: new Date().toISOString()
                    };

                    setAutoPilotLast(out);

                    if (apply) {
                        // Apply safely: do not interrupt an active focus block.
                        setDurations(prev => ({ ...prev, focus, shortBreak, longBreak }));

                        // If timer is not running, align timeLeft immediately.
                        if (!isActive) {
                            if (mode === 'focus') setTimeLeft(focus * 60);
                            if (mode === 'shortBreak') setTimeLeft(shortBreak * 60);
                            if (mode === 'longBreak') setTimeLeft(longBreak * 60);
                        }
                    }

                    if (!silent) {
                        const msg = `🤖 Otomatik ayar uygulandı: Odak ${focus}dk • Kısa mola ${shortBreak}dk • Uzun mola ${longBreak}dk. ${out.why ? '— ' + out.why : ''}`;
                        setChatMessages(prev => [...prev, { role: 'system', text: msg }]);
                        setVoiceFeedback(`AI: ${focus}dk odak. ${shortBreak}dk mola.`);
                        setTimeout(() => setVoiceFeedback(''), 4000);
                    }

                    return out;
                } finally {
                    autoPilotLockRef.current = false;
                }
            };

const startTopicFocus = (topic) => {
                const t = (topic || '').trim();
                if (!t) { alert("Konu gir."); return; }
                setActiveStudyTopic(t);
                setMode('focus');
                setTimeLeft(durations.focus * 60);
                setIsActive(false);
                setActiveTab('timer');
            };
// --- OTHER AI FUNCTIONS ---
            const generateStudyPlan = async () => {
                if (!apiKey) { alert("API Anahtarı eksik."); return; }
                setIsGeneratingPlan(true);
                const taskList = tasks.filter(t=>!t.completed).map(t=>t.title).join(", ");
                const prompt = `
                    Öğrenci Profili: ${studyProfile.grade}. sınıf, Zayıf: ${studyProfile.weakSubjects}, Süre: ${studyProfile.hoursPerDay} saat.
                    Mevcut Bekleyen Görevler: ${taskList}.
                    4 bloklu plan (JSON): [{"subject": "...", "topic": "...", "duration": "...", "tip": "..."}]
                `;
                try {
                    const res = await callGemini(prompt);
                    const cleanRes = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    setStudyPlan(JSON.parse(cleanRes));
                } catch (e) { 
                    alert("Plan oluşturulamadı: " + e.message); 
                } finally {
                    setIsGeneratingPlan(false);
                }
            };

            const installPlanToTasks = () => {
                if(!studyPlan) return;
                const newTasks = studyPlan.map(item => ({
                    id: Date.now() + Math.random(),
                    title: `${item.subject}: ${item.topic} (${item.duration}dk)`,
                    completed: false
                }));
                setTasks(prev => [...prev, ...newTasks]);
                handleChatSend("Planı görev listeme ekledim.", true); 
            };

            const breakDownTask = async (taskTitle) => {
                if(!apiKey) { alert("API Anahtarı gerekli"); return; }
                setIsBreakingTask(true);
                try {
                    const res = await callGemini(`"${taskTitle}" görevini 3 parçaya böl. JSON array: ["1", "2", "3"]`);
                    const subTasks = JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim());
                    subTasks.forEach(st => setTasks(prev => [...prev, {id: Date.now() + Math.random(), title: st, completed: false}]));
                } catch(e) {} finally {
                    setIsBreakingTask(false);
                }
            };

            const handleGenerateFlashcards = async () => {
                if(!flashcardTopic.trim()) return;
                setIsGeneratingCards(true);
                try {
                    const res = await callGemini(`Konu: "${flashcardTopic}". 5 soru-cevap. JSON: [{"q": "...", "a": "..."}]`);
                    setFlashcards(JSON.parse(res.replace(/```json/g, '').replace(/```/g, '').trim()));
                    setCurrentCardIndex(0); setIsCardFlipped(false);
                } catch(e) {
                    alert("Kart hatası: " + e.message);
                } finally {
                    setIsGeneratingCards(false);
                }
            };
            
            // --- SOCRATIC TUTOR (AI HOCA) ---
            const startTutorSession = async () => {
                if(!tutorTopic) return;
                setIsTutorThinking(true);
                setTutorMessages([{role: 'system', text: `Sıraya alındı: ${tutorTopic} dersi.`}]);
                
                const prompt = `Konu: "${tutorTopic}". Sokratik hoca ol. Tek bir başlangıç sorusu sor.`;
                try {
                    const res = await callGemini(prompt);
                    setTutorMessages(prev => [...prev, {role: 'ai', text: res}]);
                } catch(e) { 
                    setTutorMessages(prev => [...prev, {role: 'system', text: "Hata oluştu: " + e.message}]);
                } finally {
                    setIsTutorThinking(false);
                }
            };

            const sendTutorReply = async (reply) => {
                setTutorMessages(prev => [...prev, {role: 'user', text: reply}]);
                setIsTutorThinking(true);
                
                const history = tutorMessages.map(m => `${m.role === 'user' ? 'Student' : 'Teacher'}: ${m.text}`).join("\n");
                const prompt = `Geçmiş:\n${history}\nCevap: "${reply}". Değerlendir ve yeni soru sor.`;
                
                try {
                    const res = await callGemini(prompt);
                    setTutorMessages(prev => [...prev, {role: 'ai', text: res}]);
                } catch(e) {
                    setTutorMessages(prev => [...prev, {role: 'system', text: "Bağlantı hatası."}]);
                } finally {
                    setIsTutorThinking(false);
                }
            };

            // --- HELPERS ---
            const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
            const themeColor = SEASONS_CONFIG[currentSeason].color;
            const MODE_COLOR_MAP = { focus: themeColor, shortBreak: 'emerald', longBreak: 'violet' };
            const activeModeColor = MODE_COLOR_MAP[mode] || themeColor;
            const currentBg = BACKGROUNDS[currentSeason][bgIndex % BACKGROUNDS[currentSeason].length];
            
            // PDF PRINT FUNCTION
            const handlePrint = () => {
                window.print();
            };


            // --- TEKNOFEST PACK: DATA EXPORT + JURY PDF ---
            const downloadText = (filename, text, mime='text/plain') => {
                const blob = new Blob([text], { type: mime });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1500);
            };

            const buildKpiSnapshot = () => {
                const now = new Date();
                const focusSessions = (sessions || []).filter(s => s && s.blockMins);
                const totalFocusMins = focusSessions.reduce((a, s) => a + (Number(s.blockMins)||0), 0);
                const avgFocusScore = focusSessions.length ? Math.round(focusSessions.reduce((a,s)=>a+(Number(s.focusAvg)||0),0)/focusSessions.length) : (focusScore||0);
                const distractionScore = focusSessions.length ? (focusSessions.reduce((a,s)=>a+(Number(s.distraction)||0),0)/focusSessions.length) : computeDistractionScore();
                const completionRate = tasks.length ? Math.round(((tasks.filter(t=>(t.done||t.completed)).length) / tasks.length) * 100) : 0;
                const liveFocusIndexSnap = (typeof liveFocusIndex === 'number' ? liveFocusIndex : avgFocusScore);

                return {
                    profile: activeProfileId,
                    generatedAt: now.toISOString(),
                    kpis: {
                        totalFocusMins,
                        focusSessions: focusSessions.length,
                        avgFocusScore,
                        distractionScore,
                        liveFocusIndex: liveFocusIndexSnap,
                        completionRate,
                        focusStreak
                    },
                    currentStatus: {
                        mode,
                        timeLeft,
                        isActive,
                        pomodoroCount,
                        focusScore: (focusScore||0),
                        focusStreak,
                        lastFocusAvg: focusSessions.length ? (focusSessions[focusSessions.length-1].focusAvg||null) : null
                    },
                    durations,
                    activeTopic: (activeStudyTopic||'').trim(),
                    recentSessions: focusSessions.slice(-30),
                    taskSummary: {
                        total: tasks.length,
                        completed: tasks.filter(t=>t.completed).length,
                        pending: tasks.filter(t=>!t.completed).length
                    },
                    impactByTopic,
                    recentDebrief: aiDebriefs?.slice(-1)?.[0] || null
                };
            };

            const exportJson = () => {
                const payload = {
                    ...buildKpiSnapshot(),
                    tasks,
                    notes,
                    sessions,
                    tabUse,
                    aiDebriefs
                };
                downloadText(`pomodoro_os_export_${activeProfileId}_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2), 'application/json');
            };

            const exportCsv = () => {
                const rows = (sessions || []).map(s => ({
                    ts: s.ts,
                    blockMins: s.blockMins,
                    focusAvg: s.focusAvg,
                    topic: s.topic || ''
                }));
                const csv = (window.Papa && window.Papa.unparse) ? window.Papa.unparse(rows) : rows.map(r=>`${r.ts},${r.blockMins},${r.focusAvg},"${String(r.topic).replace(/"/g,'""')}"`).join('\n');
                downloadText(`pomodoro_sessions_${activeProfileId}.csv`, csv, 'text/csv');
            };

            const generateJuryPdf = async () => {
                const snap = buildKpiSnapshot();
                const jsPDF = window.jspdf?.jsPDF;
                if (!jsPDF) { alert('PDF motoru yüklenemedi. İnternet bağlantısı gerekli (jsPDF CDN).'); return; }

                // --- AI Motivational Report (privacy-first) ---
                let aiText = '';
                const allowAi = Boolean(apiKey && String(apiKey).trim()) && (typeof privacyConsent === 'undefined' ? true : Boolean(privacyConsent));
                if (allowAi) {
                    try {
                        const prompt = `Sen Pomodoro OS'un AI koçusun. Aşağıdaki SNAPSHOT'a göre TÜRKÇE, çok motive edici ve net bir PDF raporu yaz.

Kurallar:
- 4 bölüm üret: 1) Özet 2) Güçlü Yönler 3) Riskler / Dikkat Dağıtıcılar 4) 3 Adımlık Plan (bugün uygulanabilir)
- 1 kısa slogan + 1 kısa “hemen şimdi” çağrısı ekle.
- Somut sayılar kullan (odak dk, oturum, tamamlanma, streak, odak skoru).
- Maks 1200 karakter.

SNAPSHOT(JSON):
${JSON.stringify(snap)}`;
                        const out = await callGemini(prompt);
                        aiText = (out?.text || out || '').toString().trim();
                        if (aiText.length > 1400) aiText = aiText.slice(0, 1400) + '…';
                    } catch (e) {
                        aiText = '';
                    }
                }

                const doc = new jsPDF({ unit: 'pt', format: 'a4' });
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                const margin = 48;

                const ensureSpace = (need=0) => {
                    if (y + need > pageH - margin) { doc.addPage(); y = margin; }
                };

                let y = margin;

                const h1 = (txt) => {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(20);
                    ensureSpace(34);
                    doc.text(txt, margin, y);
                    y += 30;
                };

                const h2 = (txt) => {
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(13);
                    ensureSpace(22);
                    doc.text(txt, margin, y);
                    y += 18;
                };

                const p = (txt, size=11, gap=16) => {
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(size);
                    const lines = doc.splitTextToSize(String(txt || ''), pageW - margin*2);
                    ensureSpace(gap * (lines.length+1));
                    doc.text(lines, margin, y);
                    y += gap * lines.length;
                };

                const pill = (label, value) => {
                    const text = `${label}: ${value}`;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(10);
                    const w = doc.getTextWidth(text) + 18;
                    const h = 18;
                    ensureSpace(h + 10);
                    doc.setFillColor(20,20,20);
                    doc.setDrawColor(255,255,255);
                    doc.setLineWidth(0.5);
                    doc.roundedRect(margin, y-12, w, h, 9, 9, 'FD');
                    doc.setTextColor(255,255,255);
                    doc.text(text, margin+9, y);
                    doc.setTextColor(255,255,255);
                    y += 22;
                };

                const bar = (label, pct) => {
                    const w = pageW - margin*2;
                    const h = 10;
                    const clamped = Math.max(0, Math.min(100, Number(pct)||0));
                    ensureSpace(38);
                    doc.setFont('helvetica', 'normal');
                    doc.setFontSize(10);
                    doc.setTextColor(255,255,255);
                    doc.text(`${label} (${clamped}%)`, margin, y);
                    y += 12;
                    doc.setDrawColor(255,255,255);
                    doc.setFillColor(30,30,30);
                    doc.roundedRect(margin, y, w, h, 5, 5, 'FD');
                    doc.setFillColor(255,255,255);
                    doc.roundedRect(margin, y, w*(clamped/100), h, 5, 5, 'F');
                    y += 20;
                    doc.setTextColor(255,255,255);
                };

                // --- COVER ---
                doc.setFillColor(10,10,10);
                doc.rect(0,0,pageW,pageH,'F');
                doc.setTextColor(255,255,255);

                h1('Pomodoro OS – Motivasyon & Performans Raporu');
                p(`Profil: ${snap.profile}   •   Tarih: ${new Date(snap.generatedAt).toLocaleString()}`, 11, 16);

                const k = snap.kpis || {};
                pill('Toplam Odak', `${k.totalFocusMins || 0} dk`);
                pill('Oturum', `${k.focusSessions || 0}`);
                pill('Ortalama Odak', `${k.avgFocusScore ?? '—'}`);
                pill('Tamamlama', `%${k.completionRate ?? 0}`);
                pill('Streak', `${k.focusStreak ?? 0}`);

                // Current status snapshot
                const cs = snap.currentStatus || {};
                h2('Şu Anki Durum');
                p(`Mod: ${cs.mode || '—'}   •   Kalan: ${typeof cs.timeLeft==='number' ? formatTime(cs.timeLeft) : '—'}   •   Çalışıyor: ${cs.isActive ? 'Evet' : 'Hayır'}
Pomodoro Sayacı: ${cs.pomodoroCount ?? 0}   •   Anlık Odak Skoru: ${cs.focusScore ?? '—'}`, 11, 16);

                // Bars
                h2('Hızlı Göstergeler');
                const completion = Number(k.completionRate||0);
                bar('Görev Tamamlama', completion);
                const focusScorePct = Math.max(0, Math.min(100, Number(k.avgFocusScore||0)));
                bar('Odak Skoru', focusScorePct);
                const lfiPct = Math.max(0, Math.min(100, Number((k.liveFocusIndex!=null?snap.liveFocusIndex:snap.avgFocusScore)||0)));
                bar('Live Focus Index (LFI)', lfiPct);
                const disInv = Math.max(0, Math.min(100, Math.round((1 - Number(k.distractionScore||0)) * 100)));
                bar('Distraction Control', disInv);

                const streakPct = Math.max(0, Math.min(100, Number(k.focusStreak||0)));
                bar('Streak Gücü', streakPct);

                // AI debrief + motivation
                h2('Haftalık Gelişim (Weekly AI Growth)');
                const w = weekly || null;
                if (w) {
                    p(`Son 7 gün: ${w.current.mins} dk, ${w.current.blocks} oturum • Ortalama LFI: ${w.current.lfi} • Distraction: ${w.current.dis}`);
                    p(`Önceki 7 gün: ${w.prev.mins} dk, ${w.prev.blocks} oturum • Ortalama LFI: ${w.prev.lfi} • Distraction: ${w.prev.dis}`);
                    p(`Değişim: Odak dk ${w.delta.minsPct}% • LFI ${w.delta.lfiPct}% • Dikkat kontrolü ${w.delta.disPct}%`, 11, 18);
                } else {
                    p('Haftalık rapor için henüz yeterli oturum yok.');
                }

                h2('Focus DNA');
                if (dna) {
                    p(`Profil: ${dna.label || '—'}  •  Açıklama: ${dna.desc || dna.description || '—'}`);
                    if (dna.metrics) {
                        const m = dna.metrics;
                        p(`Metrix: FocusAvg ${m.focusAvg ?? '—'} • Repeat ${m.repeats ?? '—'} • Etki ${m.impactScore ?? '—'}`);
                    }
                } else {
                    p('Focus DNA henüz oluşmadı.');
                }

                h2('AI Koç Raporu');
                if (aiText) {
                    p(aiText, 11, 16);
                } else if (snap.recentDebrief?.text) {
                    p(String(snap.recentDebrief.text).slice(0, 1400), 11, 16);
                } else {
                    p('AI raporu için Gemini API anahtarı ve izin gerekir. (Ayarlar > AI)', 11, 16);
                }

                // Evidence: last sessions
                ensureSpace(24);
                h2('Kanıt / Kayıt Özeti');
                const recent = (snap.recentSessions || []).slice(-8).reverse();
                if (!recent.length) {
                    p('Henüz kayıt yok. 1-2 odak oturumu yaptıktan sonra burada otomatik oluşur.', 11, 16);
                } else {
                    doc.setFont('helvetica','bold'); doc.setFontSize(10);
                    ensureSpace(18);
                    doc.text('Tarih', margin, y);
                    doc.text('Süre(dk)', margin+170, y);
                    doc.text('Odak', margin+250, y);
                    doc.text('Konu', margin+310, y);
                    y += 12;
                    doc.setFont('helvetica','normal'); doc.setFontSize(10);
                    for (const s of recent) {
                        ensureSpace(16);
                        const dt = new Date(s.ts || s.time || Date.now()).toLocaleString();
                        doc.text(String(dt).slice(0, 18), margin, y);
                        doc.text(String(s.blockMins ?? s.mins ?? '—'), margin+170, y);
                        doc.text(String(s.focusAvg ?? '—'), margin+250, y);
                        doc.text(String((s.topic||'—')).slice(0, 28), margin+310, y);
                        y += 14;
                    }
                }

                // Footer
                ensureSpace(30);
                doc.setFont('helvetica','italic'); doc.setFontSize(10);
                p('Not: Bu rapor cihaz üzerinde üretilir. Ham verini Export JSON/CSV ile dışa aktarabilir, jüri sunumuna ekleyebilirsin.', 10, 14);

                const fileName = `pomodoro_motivation_report_${snap.profile}_${new Date().toISOString().slice(0,10)}.pdf`;
                doc.save(fileName);
            };

            // --- TEKNOFEST PACK: DEMO MODE (2 min guided tour) ---
            const runDemo = async () => {
                setDemoMode(true);
                const steps = [
                    { tab: 'timer', msg: 'Demo: Timer – otomatik geçiş, alarm, ayrı renkler (odak/kısa/uzun).' },
                    { tab: 'planner', msg: 'Demo: Planner – görevler, tamamlanma oranı, KPI bağlantısı.' },
                    { tab: 'ai_study', msg: 'Demo: AI Study – konuya göre öğrenme ve koçluk.' },
                    { tab: 'stats', msg: 'Demo: İstatistik – KPI, trend, export ve Jury Pack.' },
                ];
                for (const s of steps) {
                    setActiveTab(s.tab);
                    setVoiceFeedback(s.msg);
                    speakText(s.msg);
                    await new Promise(r => setTimeout(r, 9000));
                }
                setVoiceFeedback('Demo bitti.');
                setDemoMode(false);
            };


            return (
                <React.Fragment>
                <div className={`min-h-screen w-full relative text-white font-sans selection:bg-${themeColor}-500 selection:text-white overflow-y-auto custom-scrollbar ${highContrast ? 'hc' : ''} ${dyslexicFont ? 'dys' : ''}`}>
                    
                    
                    {/* --- PRIVACY CONSENT (KVKK / TEKNOFEST) --- */}
                    {!privacyConsent && (
                        <div className="fixed inset-0 z-[120] flex items-center justify-center p-4 bg-black/80 backdrop-blur-md">
                            <div className="glass-panel w-full max-w-lg rounded-3xl p-6 border border-white/15 bg-[#0b0b0b]">
                                <div className="text-2xl font-extrabold mb-2">Gizlilik & KVKK Onayı</div>
                                <p className="text-white/60 text-sm leading-relaxed">
                                    Bu uygulama öncelikle <b>cihaz üzerinde</b> çalışır. AI (Gemini) analizleri için yalnızca senin gönderdiğin metinler ve seçtiğin özet metrikler kullanılır.
                                    İstediğin an Ayarlar’dan verileri silebilir veya export alabilirsin.
                                </p>
                                <div className="mt-4 space-y-3">
                                    <label className="flex items-center justify-between gap-3 bg-white/5 border border-white/10 rounded-2xl p-4">
                                        <span className="text-sm font-bold">Çalışma Modu</span>
                                        <select value={privacyMode} onChange={e=>setPrivacyMode(e.target.value)} className="bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none">
                                            <option value="local">Local (önerilen)</option>
                                            <option value="hybrid">Hybrid (AI önerileri daha güçlü)</option>
                                        </select>
                                    </label>
                                    <label className="flex items-center gap-3 text-sm text-white/70">
                                        <input type="checkbox" className="accent-purple-500" checked={true} readOnly />
                                        Veriler cihazda tutulur (LocalStorage). Export/temizleme kullanıcı kontrolündedir.
                                    </label>
                                </div>
                                <div className="mt-5 flex gap-3">
                                    <button onClick={() => { setPrivacyConsent(true); }} className="flex-1 bg-white text-black font-extrabold py-3 rounded-2xl hover:bg-gray-200">Kabul Et</button>
                                    <button onClick={() => { setPrivacyConsent(true); setAiGovernorEnabled(false); setIsGlobalVoiceActive(false); }} className="flex-1 bg-white/10 border border-white/10 font-bold py-3 rounded-2xl hover:bg-white/15">Sadece Local Kullan</button>
                                </div>
                                <p className="text-[11px] text-white/40 mt-3">
                                    Not: API anahtarı girmeden AI çalışmaz. Kamera kaydı yapılmaz; odak metrikleri anonim tutulur.
                                </p>
                            </div>
                        </div>
                    )}

                    {/* BACKGROUND LAYER */}
                    <div className="fixed inset-0 z-0 no-print">
                        <div className="absolute inset-0 bg-cover bg-center transition-all duration-1000 transform scale-105" style={{ backgroundImage: `url(${currentBg})` }} />
                        <div className={`absolute inset-0 bg-black/40 backdrop-blur-[2px]`}></div>
                        <div className={`absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/90`}></div>
                    </div>

                    {/* --- DYNAMIC ISLAND TOP BAR --- */}
                    <div className={`fixed top-0 left-0 right-0 z-[100] flex justify-center pt-4 transition-transform duration-500 no-print ${zenMode ? '-translate-y-32' : 'translate-y-0'}`}>
                        <div className={`dynamic-island h-14 rounded-full px-2 flex items-center gap-4 animate-slide-down max-w-3xl w-full mx-4 justify-between pointer-events-auto ${isGlobalVoiceActive ? 'shadow-[0_0_20px_rgba(239,68,68,0.5)] border-red-500/50' : ''}`}>
                             <div className="flex items-center gap-3 pl-2">
                                 {/* VOICE CONTROL TOGGLE */}
                                 <button 
                                    onClick={toggleGlobalVoice} 
                                    className={`w-10 h-10 rounded-full flex items-center justify-center transition-all ${isGlobalVoiceActive ? 'bg-red-600 animate-listening' : 'bg-white/10 hover:bg-white/20'}`}
                                    title={isGlobalVoiceActive ? "Sesli Kontrolü Kapat" : "Sesli Kontrolü Başlat"}
                                 >
                                      {isGlobalVoiceActive ? <Mic size={20} className="text-white"/> : <MicOff size={20} className="text-white/50"/>}
                                 </button>

                                            <button
                                                onClick={() => setAiGovernorEnabled(v => !v)}
                                                className={`px-4 py-2 rounded-xl text-sm font-bold border transition-all ${aiGovernorEnabled ? 'bg-purple-500/20 border-purple-500/30 text-purple-200' : 'bg-white/5 border-white/10 text-white/60 hover:bg-white/10'}`}
                                                title="Gemini AI otomatik yönetimi aç/kapat"
                                            >
                                                {aiGovernorEnabled ? 'AI ON' : 'AI OFF'}
                                            </button>

                                 
                                 {/* STATUS TEXT ON ISLAND */}
                                 {isAiProcessing || isProcessingQueue.current ? (
                                     <div className="flex items-center gap-2 text-purple-300 animate-pulse text-sm font-bold">
                                         {queueLength > 0 ? <Activity size={14}/> : <Sparkles size={14}/>} 
                                         {queueLength > 0 ? `Sırada: ${queueLength}` : "Düşünüyor..."}
                                     </div>
                                 ) : voiceFeedback ? (
                                     <div className="text-sm font-medium text-white/90 line-clamp-1 animate-fade-in px-2">
                                         "{voiceFeedback}"
                                     </div>
                                 ) : (
                                     <div className="flex items-center gap-1 overflow-hidden max-w-[200px]">
                                        <div className={`w-8 h-8 rounded-full bg-${activeModeColor}-600 flex items-center justify-center font-bold text-xs shadow-lg shadow-${themeColor}-500/20 mr-2`}>
                                            {SEASONS_CONFIG[currentSeason].icon && React.createElement(SEASONS_CONFIG[currentSeason].icon, {size:16})}
                                        </div>
                                         {Object.keys(activeSounds).length > 0 ? (
                                             Object.keys(activeSounds).map(id => {
                                                 const s = INTERNAL_SOUNDS.find(sl => sl.id === id);
                                                 return s ? <s.icon key={id} size={14} className="text-white/70 mx-1"/> : null;
                                             })
                                         ) : <span className="text-xs text-white/30 hidden sm:block">Sessiz Mod</span>}
                                         {activeEmbed && <div className="flex items-center gap-1 ml-2 text-green-400 text-xs animate-pulse"><Music size={12}/> Spotify</div>}
                                     </div>
                                 )}
                             </div>

                             <div className="flex items-center gap-2 pr-1">
                                 <button onClick={() => setBgIndex(p => p + 1)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors hidden sm:block" title="Arka Planı Değiştir"><ImageIcon size={18}/></button>
                                 <button onClick={() => setBreathMode(true)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors hidden sm:block" title="Nefes Egzersizi"><Wind size={18}/></button>

                                 {focusEnabled && (
                                   <div className="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-mono text-white/70" title="Anlık Odak Skoru">
                                     <Gauge size={14} className="text-white/60"/>
                                     <span>Odak:</span>
                                     <span className="font-black text-white">{focusScore}</span>
                                   </div>
                                 )}

                                 <div className="w-[1px] h-6 bg-white/10 mx-1 hidden sm:block"></div>
                                 <button onClick={() => setZenMode(true)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors" title="Zen Modu"><Maximize2 size={18}/></button>
                                 <button onClick={() => setShowSettings(true)} className="p-2 rounded-full hover:bg-white/10 text-white/70 transition-colors"><Settings size={18}/></button>
                             </div>
                        </div>
                    </div>

                    {/* --- MAIN CONTENT AREA --- */}
                    <div className={`relative z-10 w-full pt-24 pb-32 px-8 flex justify-center transition-opacity duration-700 ${zenMode ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                        
                        {/* --- TIMER TAB --- */}
                        {activeTab === 'timer' && (
                            <div className="w-full grid grid-cols-1 lg:grid-cols-12 gap-6 h-full max-w-[1600px]">
                                {/* LEFT: Tasks */}
                                <div className="lg:col-span-3 flex flex-col gap-6 animate-slide-up">
                                    <div className="glass-panel rounded-[2rem] p-6 flex flex-col relative overflow-hidden min-h-[400px]">
                                        <div className="flex justify-between items-center mb-4">
                                            <h3 className="font-bold flex items-center gap-2 text-lg"><LayoutGrid className={`text-${themeColor}-400`}/> Görevler</h3>
                                            <span className="bg-white/10 px-2 py-0.5 rounded text-xs font-mono">{tasks.filter(t=>!t.completed).length} Aktif</span>
                                        </div>
                                        <form onSubmit={(e)=>{e.preventDefault(); if(newTask) { setTasks([...tasks, {id:Date.now(), title:newTask, completed:false}]); setNewTask(''); }}} className="relative mb-4">
                                            <input value={newTask} onChange={e=>setNewTask(e.target.value)} placeholder="Yeni görev..." className="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-white/30 transition-all text-sm placeholder:text-white/20" />
                                            <button type="submit" className={`absolute right-2 top-2 p-1.5 rounded-lg bg-${themeColor}-500 text-white hover:scale-105 transition-transform`}><Plus size={16}/></button>
                                        </form>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1">
                                            {tasks.map(task => (
                                                <div key={task.id} className="group/item flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/5 transition-all cursor-pointer">
                                                    <button onClick={() => setTasks(tasks.map(t=>t.id===task.id?{...t, completed:!t.completed}:t))} className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all ${task.completed ? 'bg-green-500 border-green-500' : 'border-white/20 hover:border-white/50'}`}>
                                                        {task.completed && <Check size={12} />}
                                                    </button>
                                                    <span className={`flex-1 text-sm ${task.completed ? 'line-through text-white/30' : 'text-white/90'}`}>{task.title}</span>
                                                    {!task.completed && (
                                                        <button onClick={() => breakDownTask(task.title)} disabled={isBreakingTask} className="text-purple-400 hover:text-purple-300 p-1 opacity-50 hover:opacity-100" title="AI ile Parçala">
                                                            {isBreakingTask ? <Loader2 size={14} className="animate-spin"/> : <Split size={14}/>}
                                                        </button>
                                                    )}
                                                    <button onClick={() => setTasks(tasks.filter(t=>t.id!==task.id))} className="opacity-0 group-hover/item:opacity-100 text-red-400 hover:text-red-300 p-1"><Trash2 size={14}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="glass-panel min-h-[200px] rounded-[2rem] p-6 flex flex-col relative group">
                                        <div className="absolute top-4 right-4 text-white/20 group-hover:text-white/50 transition-colors"><StickyNote size={20}/></div>
                                        <h3 className="font-bold text-lg mb-2">Hızlı Notlar</h3>
                                        <textarea value={notes} onChange={(e) => setNotes(e.target.value)} className="flex-1 bg-transparent border-none outline-none resize-none text-sm text-white/80 placeholder:text-white/20 leading-relaxed custom-scrollbar min-h-[150px] font-hand text-lg" placeholder="Buraya not al..."></textarea>
                                    </div>
                                </div>

                                {/* CENTER: Timer */}
                                <div className="lg:col-span-6 flex flex-col items-center justify-start pt-10 relative animate-slide-up min-h-[600px]">
                                    <div className="relative w-[450px] h-[450px] flex items-center justify-center group">
                                        <div className={`absolute inset-0 rounded-full bg-${themeColor}-500/10 blur-[80px] group-hover:bg-${themeColor}-500/20 transition-all duration-1000 animate-pulse`}></div>
                                        <svg className="w-full h-full transform -rotate-90 drop-shadow-2xl">
                                            <circle cx="50%" cy="50%" r="180" stroke="rgba(255,255,255,0.05)" strokeWidth="12" fill="none" />
                                            <circle cx="50%" cy="50%" r="180" stroke="currentColor" strokeWidth="12" fill="none" strokeDasharray={2 * Math.PI * 180} strokeDashoffset={2 * Math.PI * 180 * (1 - timeLeft / (durations[mode] * 60))} strokeLinecap="round" className={`text-${themeColor}-500 transition-all duration-1000 ease-linear`} />
                                        </svg>
                                        <div className="absolute inset-0 flex flex-col items-center justify-center z-10">
                                            <div className="flex gap-2 mb-6">
                                                {['focus', 'shortBreak', 'longBreak'].map(m => (
                                                    <button key={m} onClick={() => { setMode(m); setIsActive(false); setTimeLeft(durations[m]*60); setPauseCount(0); }} className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all ${mode === m ? `bg-${MODE_COLOR_MAP[m]}-500 text-white shadow-lg shadow-${MODE_COLOR_MAP[m]}-500/30` : 'bg-black/20 text-white/50 hover:bg-white/10 hover:text-white'}`}>{m === 'focus' ? 'Odak' : m === 'shortBreak' ? 'Kısa' : 'Uzun'}</button>
                                                ))}
                                            </div>
                                            <div className={`text-9xl font-bold font-mono tracking-tighter tabular-nums text-white drop-shadow-2xl select-none ${isActive ? 'animate-float' : ''}`}>{formatTime(timeLeft)}</div>
                                            <p className={`mt-4 text-sm font-medium tracking-[0.3em] uppercase text-${activeModeColor}-300 opacity-80`}>{isActive ? 'Akıştasınız' : 'Hazır mısınız?'}</p>
                                        </div>
                                        <div className="absolute -bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                                            <button onClick={() => { setIsActive(false); setTimeLeft(durations[mode]*60); setPauseCount(0); }} className="p-4 rounded-2xl glass-panel hover:bg-white/10 active:scale-95 transition-all"><RotateCcw size={24}/></button>
                                            <button onClick={() => {
                                                if(isActive){ if(mode==='focus') setPauseCount(c=>c+1); setIsActive(false);} else { setIsActive(true);} 
                                            }} className={`h-20 w-24 rounded-3xl bg-${themeColor}-600 flex items-center justify-center shadow-xl shadow-${activeModeColor}-600/30 hover:scale-105 active:scale-95 transition-all border border-white/10`}>{isActive ? <Pause size={36} fill="white"/> : <Play size={36} fill="white" className="ml-1"/>}</button>
                                            <button onClick={() => setIsCoachOpen(true)} className="p-4 rounded-2xl glass-panel hover:bg-purple-500/20 text-purple-300 active:scale-95 transition-all shadow-purple-500/20 shadow-lg border-purple-500/30"><MessageCircle size={24}/></button>
                                        </div>
                                    </div>
                                </div>

                                {/* RIGHT: Widgets */}
                                <div className="lg:col-span-3 flex flex-col gap-6 animate-slide-up">
                                    <div className="glass-panel p-5 rounded-[2rem] min-h-[180px] relative overflow-hidden group">
                                         <div className="absolute top-0 right-0 p-3 opacity-20"><Target size={40}/></div>
                                         <h3 className="font-bold text-lg mb-3">AI Planı</h3>
                                         {studyPlan ? (
                                             <div className="space-y-3">
                                                 {studyPlan.slice(0, 2).map((item, i) => (
                                                     <div key={i} className="bg-white/5 rounded-xl p-3 border border-white/5">
                                                         <div className="flex justify-between items-start">
                                                             <span className="font-bold text-sm text-purple-300">{item.subject}</span>
                                                             <span className="text-xs bg-white/10 px-1.5 rounded">{item.duration}dk</span>
                                                         </div>
                                                         <p className="text-xs text-white/60 mt-1 line-clamp-1">{item.topic}</p>
                                                     </div>
                                                 ))}
                                                 <button onClick={() => setActiveTab('planner')} className="w-full py-2 text-xs text-white/50 hover:text-white hover:bg-white/5 rounded-lg transition-colors">Detaylar →</button>
                                             </div>
                                         ) : (
                                             <div className="text-center py-4">
                                                 <p className="text-sm text-white/50 mb-3">Günlük planın hazır değil.</p>
                                                 <button onClick={() => setActiveTab('planner')} className="bg-purple-600/80 hover:bg-purple-600 px-4 py-2 rounded-xl text-sm font-bold w-full transition-colors">Oluştur</button>
                                             </div>
                                         )}
                                    </div>
                                    <div className="glass-panel flex-1 rounded-[2rem] p-6 flex flex-col min-h-[300px]">
                                        <h3 className="font-bold flex items-center gap-2 text-lg mb-4"><GraduationCap className={`text-${themeColor}-400`}/> Sınavlar</h3>
                                        <div className="flex gap-2 mb-4">
                                            <input value={newExamTitle} onChange={e=>setNewExamTitle(e.target.value)} placeholder="Sınav Adı" className="flex-1 bg-white/5 rounded-lg px-3 py-2 text-xs outline-none focus:bg-white/10"/>
                                            <input type="date" value={newExamDate} onChange={e=>setNewExamDate(e.target.value)} className="w-24 bg-white/5 rounded-lg px-2 py-2 text-xs outline-none focus:bg-white/10 text-white/70"/>
                                            <button onClick={()=>{if(newExamTitle&&newExamDate){setExams([...exams, {id:Date.now(), title:newExamTitle, date:newExamDate}]); setNewExamTitle('');}}} className={`p-2 rounded-lg bg-${themeColor}-500/50 hover:bg-${themeColor}-500`}><Plus size={14}/></button>
                                        </div>
                                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                            {exams.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(exam => {
                                                const diff = Math.ceil((new Date(exam.date) - new Date()) / (1000 * 60 * 60 * 24));
                                                const isUrgent = diff <= 3 && diff >= 0;
                                                return (
                                                    <div key={exam.id} className={`flex items-center justify-between p-3 rounded-xl border ${isUrgent ? 'bg-red-500/20 border-red-500/30' : 'bg-white/5 border-white/5'} hover:border-white/20`}>
                                                        <div><div className="font-medium text-sm">{exam.title}</div><div className={`text-[10px] ${isUrgent?'text-red-300':'text-white/40'}`}>{new Date(exam.date).toLocaleDateString('tr-TR')}</div></div>
                                                        <div className="flex items-center gap-2"><span className={`text-xs font-bold px-2 py-1 rounded ${isUrgent ? 'bg-red-500 text-white' : 'bg-white/10 text-white/70'}`}>{diff < 0 ? 'Geçti' : diff === 0 ? 'Bugün' : `${diff} Gün`}</span><button onClick={() => setExams(exams.filter(e=>e.id!==exam.id))} className="text-white/20 hover:text-white"><X size={12}/></button></div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- AI VISUAL LEARNER TAB (UPDATED) --- */}
                        {activeTab === 'ai_study' && (
                            <div className="w-full max-w-6xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] flex flex-col min-h-[600px] no-print">
                                    <h2 className="text-3xl font-bold flex items-center gap-3 mb-6"><Brain className="text-pink-400"/> AI Görsel Öğrenme İstasyonu</h2>
                                    <div className="flex gap-4 mb-8">
                                        <input value={aiTopic} onChange={e=>setAiTopic(e.target.value)} placeholder="Hangi konuda poster hazırlayayım? (Örn: Fotosentez)" className="flex-1 bg-white/5 border border-white/10 rounded-xl px-6 py-4 text-lg outline-none focus:border-pink-500 transition-colors"/>
                                        <button onClick={generateAiInfographic} disabled={isAiWorking} className="bg-pink-600 hover:bg-pink-500 px-8 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50 text-lg transition-transform hover:scale-105">
                                            {isAiWorking ? <Loader2 className="animate-spin"/> : <Sparkles/>} Posteri Hazırla
                                        </button>
                                    </div>
                                </div>

                                {/* THE INFOGRAPHIC PRINT AREA */}
                                {infographicData && (
                                    <div id="printable-area" className="w-full bg-white text-black p-8 rounded-[2rem] shadow-2xl animate-pop border-8 border-white">
                                        <div className="grid grid-cols-1 md:grid-cols-12 gap-6">
                                            {/* Header */}
                                            <div className="md:col-span-12 flex justify-between items-center border-b-4 border-black pb-4 mb-4">
                                                <div>
                                                    <h1 className="text-5xl font-black uppercase tracking-tighter text-black">{infographicData.title}</h1>
                                                    <p className="text-xl font-medium text-gray-600 mt-2 font-hand">Pomodoro OS ile Hazırlandı</p>
                                                </div>
                                                <div className="hidden md:block">
                                                    <div className="bg-black text-white px-6 py-2 rounded-full font-bold text-xl transform -rotate-2">
                                                        AI DERS NOTU
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Left Column: Image & Explanation */}
                                            <div className="md:col-span-7 space-y-6">
                                                {/* Hero Image */}
                                                <div className="w-full h-80 bg-gray-100 rounded-3xl border-4 border-black overflow-hidden relative shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    {aiImage ? (
                                                        <img src={aiImage} alt="Topic Visual" className="w-full h-full object-cover"/>
                                                    ) : (
                                                        <div className="w-full h-full flex items-center justify-center bg-yellow-100 text-yellow-800">
                                                            <ImageIcon size={64}/>
                                                            <span className="ml-2 font-bold">Görsel Hazırlanıyor...</span>
                                                        </div>
                                                    )}
                                                </div>

                                                {/* Simple Explanation (EL5) */}
                                                <div className="bg-blue-100 p-6 rounded-3xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    <h3 className="font-black text-2xl mb-3 flex items-center gap-2"><User size={28}/> 5 Yaşındaki Halime Anlat</h3>
                                                    <p className="text-xl leading-relaxed font-medium text-gray-800">{infographicData.simple_explanation}</p>
                                                </div>

                                                {/* Analogy */}
                                                <div className="bg-yellow-100 p-6 rounded-3xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    <h3 className="font-black text-2xl mb-3 flex items-center gap-2"><Lightbulb size={28}/> Akılda Tutma Kancası (Analoji)</h3>
                                                    <p className="text-xl italic font-serif text-gray-800 border-l-4 border-yellow-500 pl-4">
                                                        "{infographicData.analogy}"
                                                    </p>
                                                </div>
                                            </div>

                                            {/* Right Column: Key Points & Fun Fact */}
                                            <div className="md:col-span-5 space-y-6">
                                                {/* Key Points */}
                                                <div className="bg-green-100 p-6 rounded-3xl border-4 border-black h-auto shadow-[8px_8px_0px_0px_rgba(0,0,0,1)]">
                                                    <h3 className="font-black text-2xl mb-4 flex items-center gap-2"><Check size={28}/> Anahtar Bilgiler</h3>
                                                    <ul className="space-y-4">
                                                        {infographicData.key_points.map((point, i) => (
                                                            <li key={i} className="flex items-start gap-3 text-lg font-bold text-gray-800">
                                                                <span className="bg-black text-white w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 text-sm">{i+1}</span>
                                                                {point}
                                                            </li>
                                                        ))}
                                                    </ul>
                                                </div>

                                                {/* Fun Fact */}
                                                <div className="bg-pink-100 p-6 rounded-3xl border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] transform rotate-1">
                                                    <h3 className="font-black text-2xl mb-3 flex items-center gap-2"><Sparkles size={28}/> Biliyor Muydun?</h3>
                                                    <p className="text-lg font-hand font-bold text-pink-900">
                                                        {infographicData.fun_fact}
                                                    </p>
                                                </div>
                                                
                                                {/* QR / Footer */}
                                                <div className="mt-auto pt-4 text-center opacity-50 text-sm font-mono">
                                                    Generated by Pomodoro OS AI<br/>
                                                    {new Date().toLocaleDateString()}
                                                </div>
                                            </div>
                                        </div>

                                        {/* ACTION BUTTONS (Hidden when printing) */}
                                        <div className="no-print mt-8 flex justify-center gap-4">
                                            <button onClick={handlePrint} className="bg-white text-black px-8 py-3 rounded-xl font-bold text-lg flex items-center gap-2 hover:bg-gray-200 transition-colors shadow-lg">
                                                <Printer/> PDF / Yazdır
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {/* --- AI PLANNER TAB --- */}
                        {activeTab === 'planner' && (
                            <div className="w-full max-w-4xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] flex flex-col min-h-[600px]">
                                    <h2 className="text-3xl font-bold flex items-center gap-3 mb-6"><Target className="text-purple-400"/> AI Çalışma Planlayıcısı</h2>
                                    {!studyPlan ? (
                                        <div className="flex-1 flex flex-col items-center justify-center max-w-lg mx-auto w-full space-y-4">
                                            <p className="text-white/60 text-center mb-4">Gemini AI ile kişiselleştirilmiş program oluştur.</p>
                                            <input value={studyProfile.grade} onChange={e=>setStudyProfile({...studyProfile, grade:e.target.value})} placeholder="Kaçıncı sınıfsın? (Örn: 12)" className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-purple-500 transition-colors"/>
                                            <input value={studyProfile.weakSubjects} onChange={e=>setStudyProfile({...studyProfile, weakSubjects:e.target.value})} placeholder="Zayıf olduğun dersler?" className="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-purple-500 transition-colors"/>
                                            <div className="w-full">
                                                <label className="text-xs text-white/40 ml-1">Günlük Çalışma Saati: {studyProfile.hoursPerDay}</label>
                                                <input type="range" min="1" max="10" value={studyProfile.hoursPerDay} onChange={e=>setStudyProfile({...studyProfile, hoursPerDay:e.target.value})} className="w-full mt-2"/>
                                            </div>
                                            <button onClick={generateStudyPlan} disabled={isGeneratingPlan} className="w-full bg-purple-600 hover:bg-purple-500 py-3 rounded-xl font-bold flex items-center justify-center gap-2 mt-4 disabled:opacity-50 transition-all">
                                                {isGeneratingPlan ? <Loader2 className="animate-spin"/> : <Sparkles/>} Programı Oluştur
                                            </button>
                                        </div>
                                    ) : (
                                        <div className="flex-1 overflow-y-auto custom-scrollbar">
                                            <div className="flex justify-between items-center mb-4">
                                                <h3 className="text-xl font-semibold">Bugünün Programı</h3>
                                                <div className="flex gap-2">
                                                    <button onClick={installPlanToTasks} className="bg-green-600 hover:bg-green-500 px-4 py-1.5 rounded-lg text-sm font-medium flex items-center gap-2"><Check size={14}/> Görevlere Ekle</button>
                                                    <button onClick={()=>setStudyPlan(null)} className="text-xs text-white/40 hover:text-white border border-white/10 px-3 py-1 rounded-full">Yeniden Oluştur</button>
                                                </div>
                                            </div>
                                            <div className="grid gap-4">
                                                {studyPlan.map((item, i) => (
                                                    <div key={i} className="glass-panel bg-white/5 p-4 rounded-xl flex items-center gap-4 hover:bg-white/10 transition-colors">
                                                        <div className="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-300 font-bold">{i+1}</div>
                                                        <div className="flex-1">
                                                            <div className="flex justify-between">
                                                                <h4 className="font-bold text-lg">{item.subject}</h4>
                                                                <span className="text-xs bg-white/20 px-2 py-1 rounded">{item.duration} dk</span>
                                                            </div>
                                                            <p className="text-white/70 text-sm">{item.topic}</p>
                                                            <p className="text-white/40 text-xs mt-1 italic">💡 {item.tip}</p>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        
                        {/* --- SOCRATIC TUTOR TAB --- */}
                        {activeTab === 'tutor' && (
                            <div className="w-full max-w-4xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-0 rounded-[2rem] flex flex-col h-[600px] overflow-hidden">
                                    <div className="p-6 bg-gradient-to-r from-blue-900/30 to-purple-900/30 border-b border-white/10 flex justify-between items-center">
                                        <h2 className="text-2xl font-bold flex items-center gap-3"><Brain className="text-blue-400"/> Sokratik AI Hoca</h2>
                                        {tutorMessages.length > 0 && <button onClick={()=>{setTutorMessages([]); setTutorTopic('');}} className="text-xs bg-white/10 hover:bg-white/20 px-3 py-1 rounded-full">Dersi Bitir</button>}
                                    </div>
                                    
                                    {tutorMessages.length === 0 ? (
                                        <div className="flex-1 flex flex-col items-center justify-center p-8 space-y-4">
                                            <div className="w-20 h-20 rounded-full bg-blue-500/20 flex items-center justify-center mb-2"><GraduationCap size={40} className="text-blue-300"/></div>
                                            <h3 className="text-xl font-bold">Özel Ders Başlasın</h3>
                                            <p className="text-white/50 text-center max-w-md">Konuyu yaz, AI seni sınasın, eksiklerini bulsun ve öğretsin.</p>
                                            <div className="flex w-full max-w-md gap-2">
                                                <input value={tutorTopic} onChange={e=>setTutorTopic(e.target.value)} placeholder="Örn: Limit ve Türev" className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none"/>
                                                <button onClick={startTutorSession} disabled={!tutorTopic || isTutorThinking} className="bg-blue-600 hover:bg-blue-500 px-6 rounded-xl font-bold">Başla</button>
                                            </div>
                                        </div>
                                    ) : (
                                        <React.Fragment>
                                            <div className="flex-1 overflow-y-auto p-6 space-y-4 custom-scrollbar bg-black/20">
                                                {tutorMessages.map((msg, i) => (
                                                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                                        <div className={`max-w-[80%] p-4 rounded-2xl text-sm leading-relaxed ${msg.role === 'user' ? 'bg-blue-600 text-white rounded-br-none' : 'bg-white/10 border border-white/5 text-gray-200 rounded-bl-none'}`}>
                                                            {msg.role === 'system' ? <span className="italic opacity-70">{msg.text}</span> : msg.text}
                                                        </div>
                                                    </div>
                                                ))}
                                                {isTutorThinking && <div className="flex justify-start"><div className="bg-white/10 p-4 rounded-2xl rounded-bl-none"><Loader2 className="animate-spin" size={16}/></div></div>}
                                                <div ref={tutorEndRef}></div>
                                            </div>
                                            <div className="p-4 bg-black/40 border-t border-white/10">
                                                <form onSubmit={(e)=>{e.preventDefault(); const val=e.target.elements.reply.value; if(val){sendTutorReply(val); e.target.elements.reply.value='';}}} className="flex gap-2">
                                                    <input name="reply" placeholder="Cevabını yaz..." className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-blue-500 transition-colors" autoComplete="off"/>
                                                    <button type="submit" disabled={isTutorThinking} className="p-3 bg-blue-600 rounded-xl hover:bg-blue-500 disabled:opacity-50"><Send size={20}/></button>
                                                </form>
                                            </div>
                                        </React.Fragment>
                                    )}
                                </div>
                            </div>
                        )}

                        {/* --- MIXER TAB --- */}
                        
                        {/* --- MIXER TAB (MUSIC ENGINE v2) --- */}
                        {activeTab === 'mixer' && (
                            <div className="w-full max-w-6xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="grid grid-cols-1 lg:grid-cols-12 gap-6">

                                    {/* Left: Search + Sources */}
                                    <div className="lg:col-span-5 glass-panel p-6 rounded-[2rem] flex flex-col min-h-[520px]">
                                        <div className="flex items-center justify-between gap-3 mb-4">
                                            <h3 className="font-bold flex items-center gap-2 text-xl">
                                                <Headphones className={`text-${themeColor}-400`}/> Büyük Müzik Havuzu
                                            </h3>
                                            <button
                                                onClick={() => { musicStop(); stopAllSounds(); }}
                                                className="text-xs bg-red-500/20 hover:bg-red-500 text-red-200 px-3 py-1 rounded-full transition-colors"
                                            >
                                                Durdur
                                            </button>
                                        </div>

                                        {/* Source Selector */}
                                        <div className="flex flex-wrap gap-2 mb-4">
                                            <button
                                                onClick={() => setMusicProvider('audius')}
                                                className={`px-3 py-2 rounded-xl text-sm border transition-all ${musicProvider==='audius' ? 'bg-white/10 border-white/30' : 'bg-transparent border-white/10 hover:bg-white/5'}`}
                                            >
                                                Audius (Ücretsiz)
                                            </button>
                                            <button
                                                onClick={() => setMusicProvider('jamendo')}
                                                className={`px-3 py-2 rounded-xl text-sm border transition-all ${musicProvider==='jamendo' ? 'bg-white/10 border-white/30' : 'bg-transparent border-white/10 hover:bg-white/5'}`}
                                            >
                                                Jamendo (CC)
                                            </button>
                                            <button
                                                onClick={() => setMusicProvider('youtube')}
                                                className={`px-3 py-2 rounded-xl text-sm border transition-all ${musicProvider==='youtube' ? 'bg-white/10 border-white/30' : 'bg-transparent border-white/10 hover:bg-white/5'}`}
                                            >
                                                YouTube (Link)
                                            </button>
                                        </div>

                                        {/* Jamendo settings inline */}
                                        {musicProvider === 'jamendo' && (
                                            <div className="p-3 rounded-2xl border border-white/10 bg-white/5 mb-4">
                                                <p className="text-xs text-white/60 leading-relaxed">
                                                    Jamendo için ücretsiz <span className="text-white/90 font-semibold">client_id</span> gerekir. Tek dosyada anahtar gizlenemez; bu yüzden kendi anahtarını giriyorsun.
                                                </p>
                                                <div className="grid grid-cols-1 gap-2 mt-3">
                                                    <input
                                                        value={jamendoClientId}
                                                        onChange={(e) => setJamendoClientId(e.target.value)}
                                                        placeholder="Jamendo client_id"
                                                        className="w-full bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none focus:border-white/30"
                                                    />
                                                    <label className="flex items-center gap-2 text-xs text-white/70">
                                                        <input type="checkbox" checked={jamendoConsent} onChange={(e) => setJamendoConsent(e.target.checked)} />
                                                        API çağrıları için izin veriyorum (KVKK/şeffaflık)
                                                    </label>
                                                </div>
                                            </div>
                                        )}

                                        {/* Search / YouTube URL */}
                                        {musicProvider !== 'youtube' ? (
                                            <div className="flex items-center gap-2 mb-4">
                                                <input
                                                    value={musicQuery}
                                                    onChange={(e) => setMusicQuery(e.target.value)}
                                                    onKeyDown={(e) => { if (e.key === 'Enter') musicSearch(); }}
                                                    placeholder="Şarkı / sanatçı / tür ara (ör: lofi, piano, rain, sagopa...)"
                                                    className="flex-1 bg-black/40 border border-white/10 rounded-2xl px-4 py-3 text-sm outline-none focus:border-white/30"
                                                />
                                                <button
                                                    onClick={musicSearch}
                                                    className={`px-4 py-3 rounded-2xl text-sm font-semibold border border-white/10 hover:bg-white/10 transition-all ${musicStatus.loading ? 'opacity-60 cursor-not-allowed' : ''}`}
                                                    disabled={musicStatus.loading}
                                                >
                                                    {musicStatus.loading ? 'Aranıyor…' : 'Ara'}
                                                </button>
                                            </div>
                                        ) : (
                                            <div className="flex items-center gap-2 mb-4">
                                                <input
                                                    value={ytUrl}
                                                    onChange={(e) => setYtUrl(e.target.value)}
                                                    onKeyDown={(e) => { if (e.key === 'Enter') musicPlayYouTubeUrl(); }}
                                                    placeholder="YouTube linki yapıştır (youtu.be/... veya ?v=...)"
                                                    className="flex-1 bg-black/40 border border-white/10 rounded-2xl px-4 py-3 text-sm outline-none focus:border-white/30"
                                                />
                                                <button
                                                    onClick={musicPlayYouTubeUrl}
                                                    className="px-4 py-3 rounded-2xl text-sm font-semibold border border-white/10 hover:bg-white/10 transition-all"
                                                >
                                                    Aç
                                                </button>
                                            </div>
                                        )}

                                        {musicStatus.error && (
                                            <div className="text-xs text-red-200 bg-red-500/10 border border-red-500/20 rounded-2xl px-3 py-2 mb-3">
                                                {musicStatus.error}
                                            </div>
                                        )}

                                        {/* Results */}
                                        <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pb-2">
                                            {(musicProvider === 'youtube') ? (
                                                <div className="p-4 rounded-2xl border border-white/10 bg-white/5">
                                                    <p className="text-sm font-semibold text-white/90">YouTube Dahili Oynatici</p>
                                                    <p className="text-xs text-white/60 mt-1 leading-relaxed">
                                                        YouTube arama yerine link yapistirip uygulama icinde oynatabilirsin. Bazi videolarda icerik sahibi embed oynatimi kisitlayabilir.
                                                    </p>
                                                </div>
                                            ) : (
                                                musicResults.map(track => (
                                                    <div key={track.id} className="p-3 rounded-2xl border border-white/10 bg-white/0 hover:bg-white/5 transition-all">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-12 h-12 rounded-xl overflow-hidden bg-white/5 border border-white/10 flex-shrink-0">
                                                                {track.artworkUrl ? (
                                                                    <img src={track.artworkUrl} alt="" className="w-full h-full object-cover" />
                                                                ) : (
                                                                    <div className="w-full h-full flex items-center justify-center text-white/30">
                                                                        <Music size={18} />
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <div className="min-w-0 flex-1">
                                                                <div className="flex items-center gap-2">
                                                                    <p className="text-sm font-semibold truncate">{track.title}</p>
                                                                    <span className="text-[10px] px-2 py-0.5 rounded-full bg-white/10 border border-white/10 text-white/70">
                                                                        {track.source === 'audius' ? 'Audius' : 'Jamendo'}
                                                                    </span>
                                                                </div>
                                                                <p className="text-xs text-white/60 truncate">{track.artist}</p>
                                                                <div className="flex items-center justify-between mt-1">
                                                                    <p className="text-[11px] text-white/40 truncate">{track.license || ''}</p>
                                                                    <p className="text-[11px] text-white/40">{track.durationSec ? fmtTime(track.durationSec) : ''}</p>
                                                                </div>
                                                            </div>

                                                            <div className="flex items-center gap-2">
                                                                <button
                                                                    onClick={() => musicPlayTrack(track)}
                                                                    className="px-3 py-2 rounded-xl text-xs font-semibold border border-white/10 hover:bg-white/10 transition-all"
                                                                >
                                                                    Oynat
                                                                </button>
                                                                <button
                                                                    onClick={() => musicAddToQueue(track)}
                                                                    className="px-3 py-2 rounded-xl text-xs border border-white/10 hover:bg-white/10 transition-all"
                                                                    title="Kuyruğa ekle"
                                                                >
                                                                    <Plus size={16} />
                                                                </button>
                                                                <button
                                                                    onClick={() => musicToggleFav(track)}
                                                                    className={`px-3 py-2 rounded-xl text-xs border transition-all ${isFav(track.id) ? 'border-yellow-400/40 bg-yellow-400/10 text-yellow-200' : 'border-white/10 hover:bg-white/10'}`}
                                                                    title="Favori"
                                                                >
                                                                    <Star size={16} />
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>

                                    {/* Right: Player + Queue + Favs */}
                                    <div className="lg:col-span-7 flex flex-col gap-6">
                                        <div className="glass-panel p-6 rounded-[2rem]">
                                            <div className="flex items-start justify-between gap-4">
                                                <div className="flex items-center gap-4 min-w-0">
                                                    <div className="w-16 h-16 rounded-2xl overflow-hidden bg-white/5 border border-white/10 flex-shrink-0">
                                                        {nowPlaying?.artworkUrl ? (
                                                            <img src={nowPlaying.artworkUrl} alt="" className="w-full h-full object-cover" />
                                                        ) : (
                                                            <div className="w-full h-full flex items-center justify-center text-white/30">
                                                                <Headphones size={20} />
                                                            </div>
                                                        )}
                                                    </div>
                                                    <div className="min-w-0">
                                                        <p className="text-lg font-bold truncate">{nowPlaying?.title || 'Şu an çalan yok'}</p>
                                                        <p className="text-sm text-white/60 truncate">{nowPlaying ? `${nowPlaying.artist} • ${nowPlaying.source === 'audius' ? 'Audius' : nowPlaying.source === 'jamendo' ? 'Jamendo' : 'YouTube'}` : 'Arama yapıp oynatabilirsin'}</p>
                                                        {nowPlaying?.license && (
                                                            <p className="text-xs text-white/40 truncate mt-1">{nowPlaying.license}</p>
                                                        )}
                                                    </div>
                                                </div>

                                                {nowPlaying && (
                                                    <button
                                                        onClick={() => musicToggleFav(nowPlaying)}
                                                        className={`px-3 py-2 rounded-xl text-xs border transition-all ${isFav(nowPlaying.id) ? 'border-yellow-400/40 bg-yellow-400/10 text-yellow-200' : 'border-white/10 hover:bg-white/10'}`}
                                                        title="Favori"
                                                    >
                                                        <Star size={16} />
                                                    </button>
                                                )}
                                            </div>

                                            {/* Controls */}
                                            <div className="flex items-center justify-between gap-3 mt-6">
                                                <div className="flex items-center gap-2">
                                                    <button onClick={musicPrev} className="p-3 rounded-2xl border border-white/10 hover:bg-white/10 transition-all" title="Önceki">
                                                        <ChevronLeft size={18}/>
                                                    </button>
                                                    <button onClick={musicTogglePlay} className="p-3 rounded-2xl border border-white/10 hover:bg-white/10 transition-all" title="Play/Pause">
                                                        {musicIsPlaying ? <Pause size={18}/> : <Play size={18}/>}
                                                    </button>
                                                    <button onClick={musicNext} className="p-3 rounded-2xl border border-white/10 hover:bg-white/10 transition-all" title="Sonraki">
                                                        <ChevronRight size={18}/>
                                                    </button>
                                                </div>

                                                <div className="flex items-center gap-2">
                                                    <button
                                                        onClick={() => setMusicShuffle(v => !v)}
                                                        className={`px-3 py-2 rounded-2xl text-xs border transition-all ${musicShuffle ? 'bg-white/10 border-white/30' : 'border-white/10 hover:bg-white/10'}`}
                                                        title="Shuffle"
                                                    >
                                                        Shuffle
                                                    </button>
                                                    <button
                                                        onClick={() => setMusicRepeat(v => !v)}
                                                        className={`px-3 py-2 rounded-2xl text-xs border transition-all ${musicRepeat ? 'bg-white/10 border-white/30' : 'border-white/10 hover:bg-white/10'}`}
                                                        title="Repeat"
                                                    >
                                                        Repeat
                                                    </button>
                                                </div>

                                                <div className="flex items-center gap-3">
                                                    <Volume2 size={18} className="text-white/60"/>
                                                    <input
                                                        type="range"
                                                        min="0"
                                                        max="1"
                                                        step="0.01"
                                                        value={musicVolume}
                                                        onChange={(e) => setMusicVolume(parseFloat(e.target.value))}
                                                        className="w-32"
                                                    />
                                                </div>
                                            </div>

                                            {/* Players removed: global audio + YouTube external */}
                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            {/* Queue */}
                                            <div className="glass-panel p-6 rounded-[2rem]">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-bold flex items-center gap-2"><ListMusic className={`text-${themeColor}-400`}/> Kuyruk</h4>
                                                    <button onClick={musicClearQueue} className="text-xs border border-white/10 hover:bg-white/10 px-3 py-1 rounded-full transition-all">
                                                        Temizle
                                                    </button>
                                                </div>
                                                <div className="space-y-2 max-h-[260px] overflow-y-auto custom-scrollbar pr-1">
                                                    {(musicQueue || []).length ? (musicQueue || []).map((t, i) => (
                                                        <div key={`${t.id}-${i}`} className={`p-3 rounded-2xl border transition-all ${nowPlaying?.id === t.id ? 'border-white/30 bg-white/10' : 'border-white/10 hover:bg-white/5'}`}>
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-10 h-10 rounded-xl overflow-hidden bg-white/5 border border-white/10 flex-shrink-0">
                                                                    {t.artworkUrl ? <img src={t.artworkUrl} alt="" className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-white/30"><Music size={16}/></div>}
                                                                </div>
                                                                <div className="min-w-0 flex-1">
                                                                    <p className="text-sm font-semibold truncate">{t.title}</p>
                                                                    <p className="text-xs text-white/60 truncate">{t.artist}</p>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button onClick={() => musicPlayTrack(t)} className="p-2 rounded-xl border border-white/10 hover:bg-white/10 transition-all" title="Oynat">
                                                                        <Play size={14}/>
                                                                    </button>
                                                                    <button onClick={() => musicRemoveFromQueue(t.id)} className="p-2 rounded-xl border border-white/10 hover:bg-white/10 transition-all" title="Sil">
                                                                        <Trash2 size={14}/>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )) : (
                                                        <p className="text-sm text-white/50">Kuyruk boş. Aramadan “+” ile ekleyebilirsin.</p>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Favorites */}
                                            <div className="glass-panel p-6 rounded-[2rem]">
                                                <div className="flex items-center justify-between mb-4">
                                                    <h4 className="font-bold flex items-center gap-2"><Star className="text-yellow-300"/> Favoriler</h4>
                                                    <button onClick={() => setMusicFavs([])} className="text-xs border border-white/10 hover:bg-white/10 px-3 py-1 rounded-full transition-all">
                                                        Temizle
                                                    </button>
                                                </div>
                                                <div className="space-y-2 max-h-[260px] overflow-y-auto custom-scrollbar pr-1">
                                                    {(musicFavs || []).length ? (musicFavs || []).map((t, i) => (
                                                        <div key={`${t.id}-${i}`} className="p-3 rounded-2xl border border-white/10 hover:bg-white/5 transition-all">
                                                            <div className="flex items-center gap-3">
                                                                <div className="w-10 h-10 rounded-xl overflow-hidden bg-white/5 border border-white/10 flex-shrink-0">
                                                                    {t.artworkUrl ? <img src={t.artworkUrl} alt="" className="w-full h-full object-cover" /> : <div className="w-full h-full flex items-center justify-center text-white/30"><Music size={16}/></div>}
                                                                </div>
                                                                <div className="min-w-0 flex-1">
                                                                    <p className="text-sm font-semibold truncate">{t.title}</p>
                                                                    <p className="text-xs text-white/60 truncate">{t.artist}</p>
                                                                </div>
                                                                <div className="flex items-center gap-2">
                                                                    <button onClick={() => musicPlayTrack(t)} className="p-2 rounded-xl border border-white/10 hover:bg-white/10 transition-all" title="Oynat">
                                                                        <Play size={14}/>
                                                                    </button>
                                                                    <button onClick={() => musicToggleFav(t)} className="p-2 rounded-xl border border-white/10 hover:bg-white/10 transition-all" title="Favoriden çıkar">
                                                                        <X size={14}/>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    )) : (
                                                        <p className="text-sm text-white/50">Favorin yok. Sonuçlardan ⭐ ile ekleyebilirsin.</p>
                                                    )}
                                                </div>
                                            </div>
                                        </div>

                                        {/* Focus-aware hint */}
                                        <div className="glass-panel p-5 rounded-[2rem]">
                                            <div className="flex items-start gap-3">
                                                <Sparkles className={`mt-0.5 text-${themeColor}-400`} size={20}/>
                                                <div>
                                                    <p className="text-sm font-semibold">Odak Uyumu (Kamera Yok)</p>
                                                    <p className="text-xs text-white/60 mt-1 leading-relaxed">
                                                        FocusScore: <span className="text-white/90 font-semibold">{focusScore}</span> • LFI: <span className="text-white/90 font-semibold">{(typeof liveFocusIndex === 'number') ? liveFocusIndex : '—'}</span>.
                                                        Odak düşerse sözsüz/ambient aramanı öneririm: <span className="text-white/80">“ambient”, “piano”, “lofi”, “rain”</span>.
                                                    </p>
                                                </div>
                                            </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        )}


                        {activeTab === 'ai_core' && (
                            <div className="w-full max-w-5xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] border border-white/10">
                                    <div className="flex items-start justify-between gap-4">
                                        <div>
                                            <h2 className="text-3xl font-extrabold flex items-center gap-2">
                                                <Sparkles className={`text-${themeColor}-400`} /> Teknofest AI Çekirdeği
                                            </h2>
                                            <p className="text-white/50 mt-2 text-sm leading-relaxed">
                                                Bu panel, odak verilerin (FocusScore/LFI), oturum kayıtların ve çalışma hedeflerin üzerinden
                                                <b> yarışma formatına uygun</b> öneriler üretir. Kamera olmadan, tamamen davranışsal sinyallerle çalışır.
                                            </p>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <button
                                                onClick={() => { setActiveTab('stats'); }}
                                                className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-bold"
                                            >
                                                Kayıtları Aç
                                            </button>
                                            <button
                                                onClick={runDemo}
                                                className="px-4 py-2 rounded-xl bg-purple-600/80 hover:bg-purple-600 text-sm font-bold"
                                            >
                                                Demo Mode
                                            </button>
                                        </div>
                                    </div>

<div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
    <div className="glass-panel p-6 rounded-3xl border border-white/10">
        <div className="flex items-center justify-between gap-3">
            <div className="flex items-center gap-2">
                <Brain className={`text-${themeColor}-400`} />
                <h3 className="text-xl font-extrabold">Live DNA v2</h3>
            </div>
            <div className="flex items-center gap-2">
                <button onClick={() => setUltraEnabled(v=>!v)} className="px-3 py-1.5 rounded-full text-sm bg-white/10 hover:bg-white/15 border border-white/10">
                    {ultraEnabled ? 'ULTRA: Açık' : 'ULTRA: Kapalı'}
                </button>
                <button onClick={() => setAutoTuneEnabled(v=>!v)} className="px-3 py-1.5 rounded-full text-sm bg-white/10 hover:bg-white/15 border border-white/10">
                    {autoTuneEnabled ? 'Oto-Ayar: Açık' : 'Oto-Ayar: Kapalı'}
                </button>
            </div>
        </div>

        <div className="mt-4 grid grid-cols-2 gap-3 text-sm">
            <div className="p-3 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-white/60">Peak Saatler</div>
                <div className="font-bold">{(liveDNA?.peakHours || []).length ? (liveDNA.peakHours.join(':00, ') + ':00') : '—'}</div>
            </div>
            <div className="p-3 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-white/60">En İyi Odak</div>
                <div className="font-bold">{liveDNA?.bestFocusMins ? `${liveDNA.bestFocusMins} dk` : '—'}</div>
            </div>
            <div className="p-3 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-white/60">Sustain</div>
                <div className="font-bold">{typeof liveDNA?.sustain === 'number' ? `${liveDNA.sustain}/100` : '—'}</div>
            </div>
            <div className="p-3 rounded-2xl bg-white/5 border border-white/10">
                <div className="text-white/60">Recovery</div>
                <div className="font-bold">{typeof liveDNA?.recovery === 'number' ? `${liveDNA.recovery}/100` : '—'}</div>
            </div>
            <div className="p-3 rounded-2xl bg-white/5 border border-white/10 col-span-2">
                <div className="text-white/60">Modalite</div>
                <div className="font-bold">{liveDNA?.modality || '—'} • Seviye {typeof liveDNA?.level === 'number' ? liveDNA.level : '—'}</div>
                <div className="text-white/50 mt-1">Distract: tab≈{liveDNA?.avgTab ?? '—'} • idle≈{liveDNA?.avgIdle ?? '—'}s • Bugün streak≈{liveDNA?.streak ?? 0}</div>
            </div>
        </div>

        <div className="mt-4 flex items-center gap-3">
            <button
                onClick={() => runUltraCore('manual')}
                disabled={ultraPending}
                className={`px-4 py-2 rounded-2xl font-bold border border-white/10 ${ultraPending ? 'bg-white/10 opacity-70' : `bg-${themeColor}-500/20 hover:bg-${themeColor}-500/30`} transition`}
            >
                {ultraPending ? 'Analiz ediliyor…' : 'Gemini ULTRA Analiz'}
            </button>

            <div className="flex items-center gap-3 flex-wrap">
                <label className="flex items-center gap-2 px-3 py-2 rounded-2xl bg-white/5 border border-white/10">
                    <input type="checkbox" className="accent-purple-500" checked={autoPilotEnabled} onChange={e=>setAutoPilotEnabled(e.target.checked)} />
                    <span className="text-sm font-semibold">AutoPilot</span>
                </label>
                <select value={autoPilotMode} onChange={e=>setAutoPilotMode(e.target.value)} className="px-3 py-2 rounded-2xl bg-white/5 border border-white/10 text-sm">
                    <option value="adaptive">Adaptive</option>
                    <option value="aggressive">Aggressive</option>
                </select>
                <button
                    onClick={() => autoPilotTuneNow('manual_button', { silent: false, apply: true })}
                    className={`px-3 py-2 rounded-2xl font-bold border border-white/10 bg-white/10 hover:bg-white/15 transition`}
                    title="Auto-adjust durations from your study data"
                >
                    Auto Tune Now
                </button>
                <button
                    onClick={() => setMissionModeEnabled(v => !v)}
                    className={`px-3 py-2 rounded-2xl font-bold border border-white/10 ${missionModeEnabled ? 'bg-emerald-500/25 hover:bg-emerald-500/35' : 'bg-white/10 hover:bg-white/15'} transition`}
                    title="Toggle mission-oriented AI decision engine"
                >
                    {missionModeEnabled ? 'Mission Mode: On' : 'Mission Mode: Off'}
                </button>
                <select value={missionPriority} onChange={e=>setMissionPriority(e.target.value)} className="px-3 py-2 rounded-2xl bg-white/5 border border-white/10 text-sm">
                    <option value="balanced">Priority: Balanced</option>
                    <option value="sprint">Priority: Sprint</option>
                    <option value="precision">Priority: Precision</option>
                </select>
                <button
                    onClick={() => handleChatSend('/durum', true)}
                    className="px-3 py-2 rounded-2xl font-bold border border-white/10 bg-white/10 hover:bg-white/15 transition"
                    title="Generate instant tactical risk report"
                >
                    Tactical Report
                </button>
            </div>

            {aiTacticalState && (
                <div className="text-xs text-white/70 px-3 py-2 rounded-xl bg-white/5 border border-white/10">
                    Risk: <b>{String(aiTacticalState.risk_level || 'medium').toUpperCase()}</b> | Confidence: <b>{Math.round((aiTacticalState.confidence || 0.75) * 100)}%</b> | Priority: <b>{missionPriority}</b>
                    {aiTacticalState.mission_update ? ` | ${aiTacticalState.mission_update}` : ''}
                </div>
            )}

            {autoPilotLast && (
                <div className="text-xs text-white/60">
                    ⏱️ {autoPilotLast.focus}/{autoPilotLast.shortBreak}/{autoPilotLast.longBreak} • {String(autoPilotLast.why || '').slice(0,120)}
                </div>
            )}

            {ultraGoal && (
                <div className="text-sm text-white/70">
                    🎯 <span className="font-bold">{ultraGoal.name}</span> — {ultraGoal.target} ({ultraGoal.metric}, {ultraGoal.days}g)
                </div>
            )}
        </div>
    </div>

    <div className="glass-panel p-6 rounded-3xl border border-white/10">
        <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
                <Activity className={`text-${themeColor}-400`} />
                <h3 className="text-xl font-extrabold">Explainable AI Log</h3>
            </div>
            <button onClick={() => setUltraInsights([])} className="px-3 py-1.5 rounded-full text-sm bg-white/10 hover:bg-white/15 border border-white/10">Temizle</button>
        </div>

        <div className="mt-4 space-y-3 max-h-[320px] overflow-auto custom-scrollbar">
            {(ultraInsights || []).slice().reverse().map((it, i) => (
                <div key={i} className="p-4 rounded-2xl bg-white/5 border border-white/10">
                    <div className="flex items-center justify-between gap-2">
                        <div className="font-bold">{it.headline || 'Analiz'}</div>
                        <div className="text-xs text-white/40">{new Date(it.ts).toLocaleString('tr-TR')}</div>
                    </div>
                    {Array.isArray(it.diagnosis) && it.diagnosis.length > 0 && (
                        <ul className="mt-2 text-sm text-white/70 list-disc pl-5 space-y-1">
                            {it.diagnosis.slice(0, 4).map((d, k) => <li key={k}>{d}</li>)}
                        </ul>
                    )}
                </div>
            ))}
            {(!ultraInsights || ultraInsights.length === 0) && (
                <div className="text-sm text-white/50">Henüz ULTRA analiz yok. “Gemini ULTRA Analiz”e bas.</div>
            )}
        </div>
    </div>
</div>


                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6">
                                        <div className="bg-white/5 rounded-2xl p-5 border border-white/5">
                                            <div className="text-white/40 text-xs uppercase tracking-wider mb-1">Anlık</div>
                                            <div className="text-2xl font-black">{focusScore}</div>
                                            <div className="text-xs text-white/50 mt-1">FocusScore</div>
                                        </div>
                                        <div className="bg-white/5 rounded-2xl p-5 border border-white/5">
                                            <div className="text-white/40 text-xs uppercase tracking-wider mb-1">Canlı</div>
                                            <div className="text-2xl font-black">{(typeof liveFocusIndex === 'number') ? liveFocusIndex : '—'}</div>
                                            <div className="text-xs text-white/50 mt-1">LFI</div>
                                        </div>
                                        <div className="bg-white/5 rounded-2xl p-5 border border-white/5">
                                            <div className="text-white/40 text-xs uppercase tracking-wider mb-1">Hedef</div>
                                            <div className="text-2xl font-black">{typeof dailyGoal !== 'undefined' ? dailyGoal : (durations?.focus || 25)}</div>
                                            <div className="text-xs text-white/50 mt-1">Günlük odak dakikası</div>
                                        </div>
                                    </div>

                                    <div className="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
                                        <div className="glass-panel p-5 rounded-2xl border border-white/10">
                                            <div className="text-sm font-bold mb-2 flex items-center gap-2">
                                                <Sparkles size={18} className="text-white/70" /> Yarışma Çıktısı (Özet)
                                            </div>
                                            <ul className="text-sm text-white/60 space-y-2 list-disc pl-5">
                                                <li>KVKK/Local mod uyumlu: veri cihazda tutulur, istenirse export edilir.</li>
                                                <li>Odak motoru: FocusScore + LFI + oturum kayıtları ile adaptif öneri üretir.</li>
                                                <li>Müzik motoru: Audius/Jamendo ile ücretsiz geniş havuz + mini player ile kesintisiz.</li>
                                            </ul>
                                        </div>

                                        <div className="glass-panel p-5 rounded-2xl border border-white/10">
                                            <div className="text-sm font-bold mb-2 flex items-center gap-2">
                                                <Zap size={18} className="text-white/70" /> Hızlı Aksiyonlar
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                <button
                                                    onClick={() => { setActiveTab('timer'); setMode('focus'); setIsActive(false); setTimeLeft(durations.focus*60); }}
                                                    className={`px-4 py-2 rounded-xl bg-${themeColor}-500/30 hover:bg-${themeColor}-500/40 border border-white/10 text-sm font-bold`}
                                                >
                                                    Odak Oturumu Başlat
                                                </button>
                                                <button
                                                    onClick={() => { setActiveTab('mixer'); }}
                                                    className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-bold"
                                                >
                                                    Müzik Motoru
                                                </button>
                                                <button
                                                    onClick={() => { setActiveTab('planner'); }}
                                                    className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-bold"
                                                >
                                                    Planlayıcı
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}


{activeTab === 'stats' && (
                            <div className="w-full max-w-4xl flex flex-col gap-6 animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] flex flex-col min-h-[600px]">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-3xl font-bold flex items-center gap-2"><BarChart2 className="text-blue-400"/> Çalışma Kayıtları</h2>
                                        <button onClick={() => window.print()} className="flex items-center gap-2 bg-white text-black px-4 py-2 rounded-xl font-bold hover:bg-gray-200 transition-colors">
                                            <Printer size={18}/> Raporu Yazdır / PDF
                                        </button>
                                    </div>
                                    <div className="flex flex-wrap gap-2 mb-6">
                                        <button onClick={exportJson} className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-bold">Export JSON</button>
                                        <button onClick={exportCsv} className="px-4 py-2 rounded-xl bg-white/10 hover:bg-white/15 border border-white/10 text-sm font-bold">Export CSV</button>
                                        <button onClick={generateJuryPdf} className="px-4 py-2 rounded-xl bg-white text-black hover:bg-gray-200 text-sm font-bold">Jury Pack PDF</button>
                                        <button onClick={runDemo} className="px-4 py-2 rounded-xl bg-purple-600/80 hover:bg-purple-600 text-sm font-bold">Demo Mode</button>
                                        {!privacyConsent && (
                                            <span className="text-xs text-amber-300 self-center">⚠️ Privacy onayı yok – Ayarlar’dan etkinleştir.</span>
                                        )}
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                        <div className="bg-white/5 rounded-2xl p-6 border border-white/5">
                                            <div className="text-white/40 text-sm mb-1">Toplam Oturum</div>
                                            <div className="text-4xl font-bold">{stats.length}</div>
                                        </div>
                                        <div className="bg-white/5 rounded-2xl p-6 border border-white/5">
                                            <div className="text-white/40 text-sm mb-1">Toplam Süre</div>
                                            <div className="text-4xl font-bold text-green-400">{stats.reduce((a,b) => a + (b.duration||25), 0)} dk</div>
                                        </div>
                                        <div className="bg-white/5 rounded-2xl p-6 border border-white/5">
                                            <div className="text-white/40 text-sm mb-1">Son Çalışma</div>
                                            <div className="text-lg font-bold">{stats.length > 0 ? stats[stats.length-1].date : '-'}</div>
                                        </div>
                                    </div>
                                    <div id="printable-area" className="flex-1 bg-white/5 rounded-2xl overflow-hidden">
                                        <table className="w-full text-left border-collapse">
                                            <thead>
                                                <tr className="bg-white/10 text-white/60 text-sm uppercase">
                                                    <th className="p-4">Tarih</th>
                                                    <th className="p-4">Oturum Tipi</th>
                                                    <th className="p-4">Süre (Dk)</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-white/5">
                                                {stats.length > 0 ? [...stats].reverse().map((stat, i) => (
                                                    <tr key={i} className="hover:bg-white/5">
                                                        <td className="p-4 text-white/80">{stat.date}</td>
                                                        <td className="p-4 text-white/80">Pomodoro Focus</td>
                                                        <td className="p-4 font-mono text-green-300">{stat.duration || 25}</td>
                                                    </tr>
                                                )) : (
                                                    <tr><td colSpan="3" className="p-8 text-center text-white/30">Henüz kayıt yok.</td></tr>
                                                )}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- FLASHCARDS TAB --- */}
                        {activeTab === 'flashcards' && (
                            <div className="w-full max-w-4xl flex flex-col animate-slide-up mx-auto">
                                <div className="glass-panel p-8 rounded-[2rem] h-full flex flex-col items-center min-h-[600px]">
                                    <div className="w-full flex justify-between items-center mb-8">
                                        <h2 className="text-3xl font-bold flex items-center gap-2"><Layers className="text-purple-400"/> AI Bilgi Kartları</h2>
                                        <div className="flex gap-2">
                                            <input value={flashcardTopic} onChange={e=>setFlashcardTopic(e.target.value)} placeholder="Örn: Mitoz Bölünme" className="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none w-64"/>
                                            <button onClick={handleGenerateFlashcards} disabled={isGeneratingCards} className="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50">
                                                {isGeneratingCards ? <Loader2 className="animate-spin" size={18}/> : <Wand2 size={18}/>} Oluştur
                                            </button>
                                        </div>
                                    </div>
                                    {flashcards.length > 0 ? (
                                        <div className="flex-1 flex flex-col items-center justify-center w-full max-w-2xl">
                                            <div className="perspective-1000 w-full h-80 cursor-pointer" onClick={() => setIsCardFlipped(!isCardFlipped)}>
                                                <div className={`relative w-full h-full text-center transition-transform duration-700 transform-style-3d ${isCardFlipped ? 'rotate-y-180' : ''}`}>
                                                    <div className="absolute inset-0 backface-hidden glass-panel rounded-3xl flex items-center justify-center p-8 border-2 border-white/5 bg-[#1a1a1a]">
                                                        <div>
                                                            <div className="text-xs uppercase tracking-widest text-purple-400 mb-4">Soru {currentCardIndex + 1}/{flashcards.length}</div>
                                                            <div className="text-2xl font-bold leading-relaxed">{flashcards[currentCardIndex].q}</div>
                                                        </div>
                                                    </div>
                                                    <div className="absolute inset-0 backface-hidden glass-panel rounded-3xl flex items-center justify-center p-8 border-2 border-purple-500/30 bg-purple-900/20 rotate-y-180">
                                                        <div>
                                                            <div className="text-xs uppercase tracking-widest text-green-400 mb-4">Cevap</div>
                                                            <div className="text-xl leading-relaxed">{flashcards[currentCardIndex].a}</div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-8 mt-8">
                                                <button onClick={() => { setCurrentCardIndex(p => Math.max(0, p - 1)); setIsCardFlipped(false); }} disabled={currentCardIndex === 0} className="p-4 rounded-full glass-panel hover:bg-white/10 disabled:opacity-30"><ChevronLeft size={24}/></button>
                                                <button onClick={() => setIsCardFlipped(!isCardFlipped)} className="flex items-center gap-2 text-white/50 hover:text-white"><RefreshCw size={16}/> Çevir</button>
                                                <button onClick={() => { setCurrentCardIndex(p => Math.min(flashcards.length - 1, p + 1)); setIsCardFlipped(false); }} disabled={currentCardIndex === flashcards.length - 1} className="p-4 rounded-full glass-panel hover:bg-white/10 disabled:opacity-30"><ChevronRight size={24}/></button>
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="flex-1 flex flex-col items-center justify-center text-white/30">
                                            <Layers size={64} className="mb-4 opacity-50"/>
                                            <p>Konu yaz ve yapay zekanın senin için çalışma kartları hazırlamasını bekle.</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                    </div>

                    {/* --- GLOBAL MEDIA PLAYER --- */}
                    {activeEmbed && (
                        <div className="fixed bottom-24 right-8 w-80 h-24 shadow-2xl rounded-2xl overflow-hidden glass-panel border-t border-white/20 z-50 animate-slide-up group no-print">
                            <iframe 
                                style={{borderRadius: "0px"}} 
                                src={`https://open.spotify.com/embed/${activeEmbed.link}?utm_source=generator&theme=0`} 
                                width="100%" 
                                height="100%" 
                                frameBorder="0" 
                                allowFullScreen="" 
                                allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                                loading="lazy"
                            ></iframe>
                            <button onClick={() => setActiveEmbed(null)} className="absolute top-1 right-1 bg-black/80 hover:bg-red-500 text-white p-1 rounded-full transition-colors opacity-0 group-hover:opacity-100"><X size={12}/></button>
                        </div>
                    )}

                    {/* --- AI COACH CHAT (SESLİ KOMUT SİSTEMİ) --- */}
                    {isCoachOpen && (
                        <div className="fixed bottom-24 right-8 w-96 h-[500px] glass-panel rounded-3xl flex flex-col border border-white/10 shadow-2xl z-50 animate-slide-up bg-[#0a0a0a]/90 no-print">
                            <div className="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-purple-900/30 to-blue-900/30">
                                <h3 className="font-bold flex items-center gap-2 text-purple-300"><Sparkles size={16}/> AI Öğrenci Koçu</h3>
                                <div className="flex gap-2">
                                    <button onClick={() => setVoiceEnabled(!voiceEnabled)} className={`p-1.5 rounded-lg ${voiceEnabled ? 'bg-white/20 text-white' : 'text-white/30'}`} title="Sesli Yanıt">{voiceEnabled ? <Volume2 size={16}/> : <VolumeX size={16}/>}</button>
                                    <button onClick={() => setIsCoachOpen(false)} className="hover:bg-white/10 p-1.5 rounded-full"><X size={18}/></button>
                                </div>
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                                {chatMessages.map((msg, i) => (
                                    msg.role !== 'system' && (
                                        <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                            <div className={`max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-[#1a1a1a] border border-white/10 text-gray-200 rounded-bl-none'}`}>
                                                {msg.text}
                                            </div>
                                        </div>
                                    )
                                ))}
                                {isAiProcessing && (
                                    <div className="flex justify-start ml-2">
                                        <div className="bg-[#1a1a1a] border border-white/10 p-3 rounded-2xl rounded-bl-none flex gap-1">
                                            <div className="typing-dot"></div><div className="typing-dot"></div><div className="typing-dot"></div>
                                        </div>
                                    </div>
                                )}
                                <div ref={chatEndRef}></div>
                            </div>
                            
                            {/* Input Area */}
                            <div className="p-3 border-t border-white/10 bg-black/40">
                                <div className="flex gap-2">
                                    <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleChatSend()} placeholder="Bir şeyler sor veya komut ver..." className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 transition-colors" disabled={isAiProcessing} />
                                    <button onClick={() => handleChatSend()} disabled={isAiProcessing} className="p-2 bg-purple-600 rounded-xl hover:bg-purple-500 disabled:opacity-50"><Send size={18}/></button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* --- SETTINGS MODAL --- */}
                    {showSettings && (
                        <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4" onMouseDown={(e)=>{ if(e.target===e.currentTarget) setShowSettings(false); }}>
                            <div className="glass-panel w-full max-w-md rounded-3xl p-6 bg-[#0f0f0f] border border-white/10 shadow-2xl animate-fade-in max-h-[85vh] overflow-y-auto overscroll-contain" ref={settingsScrollRef} onMouseDown={(e)=>e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="text-white/50"/> Ayarlar</h2>
                                    <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-white/10 rounded-full"><X size={20}/></button>
                                </div>
                                <div className="space-y-6">
                                    <div>
                                        <label className="text-xs font-bold text-white/40 uppercase mb-3 block">Mevsim Modu</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <select value={currentSeason} onChange={e=>setCurrentSeason(e.target.value)} className="bg-black/40 border border-white/10 rounded-xl px-3 text-sm outline-none w-full py-2">
                                                {Object.entries(SEASONS_CONFIG).map(([k,v]) => <option key={k} value={k}>{v.label}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-white/40 uppercase mb-2 block">Pomodoro Süreleri (dk)</label>
                                        <div className="grid grid-cols-3 gap-3">
                                            {Object.entries(durations).map(([k, v]) => (
                                                <input key={k} type="number" value={v} onChange={e => setDurations({...durations, [k]: parseInt(e.target.value)||1})} className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-center outline-none focus:bg-white/10" placeholder={k} />
                                            ))}
                                        </div>
                                    </div>
                                    <div>
                                        <label className="text-xs font-bold text-purple-400 uppercase mb-2 block flex items-center gap-2"><Key size={12}/> Gemini API Anahtarı</label>
                                        <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AI_zaSy..." className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none" />
                                    
                                    <div className="pt-2 border-t border-white/10">
                                        <label className="text-xs font-bold text-white/40 uppercase mb-3 block">Timer Davranışı</label>
                                        <div className="space-y-2 text-sm">
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Otomatik Mod Geçişi</span>
                                                <input type="checkbox" className="accent-purple-500" checked={autoAdvance} onChange={e=>setAutoAdvance(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Sonraki Oturum Otomatik Başlasın</span>
                                                <input type="checkbox" className="accent-purple-500" checked={autoStartNext} onChange={e=>setAutoStartNext(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Alarm Aktif</span>
                                                <input type="checkbox" className="accent-purple-500" checked={alarmEnabled} onChange={e=>setAlarmEnabled(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Sekmeden Çıkınca Alarm</span>
                                                <input type="checkbox" className="accent-purple-500" checked={tabAlarmEnabled} onChange={e=>setTabAlarmEnabled(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Adaptive Duration AI</span>
                                                <input type="checkbox" className="accent-purple-500" checked={adaptiveEnabled} onChange={e=>setAdaptiveEnabled(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Live Focus Index (LFI)</span>
                                                <input type="checkbox" className="accent-purple-500" checked={lfiEnabled} onChange={e=>setLfiEnabled(e.target.checked)} />
                                            </label>
                                        </div>
                                    </div>

                                    <div className="pt-2 border-t border-white/10">
                                        <label className="text-xs font-bold text-white/40 uppercase mb-3 block">Erişilebilirlik</label>
                                        <div className="space-y-2 text-sm">
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Yüksek Kontrast</span>
                                                <input type="checkbox" className="accent-purple-500" checked={highContrast} onChange={e=>setHighContrast(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Okunabilir Yazı (Disleksi dostu)</span>
                                                <input type="checkbox" className="accent-purple-500" checked={dyslexicFont} onChange={e=>setDyslexicFont(e.target.checked)} />
                                            </label>
                                        </div>
                                    </div>

                                    <div className="pt-2 border-t border-white/10">
                                        <label className="text-xs font-bold text-white/40 uppercase mb-3 block">Gizlilik</label>
                                        <div className="space-y-2 text-sm">
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>KVKK Onayı</span>
                                                <input type="checkbox" className="accent-purple-500" checked={privacyConsent} onChange={e=>setPrivacyConsent(e.target.checked)} />
                                            </label>
                                            <label className="flex items-center justify-between bg-white/5 border border-white/10 rounded-xl px-4 py-3">
                                                <span>Çalışma Modu</span>
                                                <select value={privacyMode} onChange={e=>setPrivacyMode(e.target.value)} className="bg-black/40 border border-white/10 rounded-xl px-3 py-2 text-sm outline-none">
                                                    <option value="local">Local</option>
                                                    <option value="hybrid">Hybrid</option>
                                                </select>
                                            </label>
                                        </div>
                                    </div>

                                    <div className="pt-2 border-t border-white/10">
                                        <label className="text-xs font-bold text-white/40 uppercase mb-3 block">Veri & Demo</label>
                                        <div className="grid grid-cols-2 gap-2">
                                            <button onClick={exportJson} className="bg-white/10 hover:bg-white/15 border border-white/10 rounded-xl py-2 text-sm font-bold">Export JSON</button>
                                            <button onClick={exportCsv} className="bg-white/10 hover:bg-white/15 border border-white/10 rounded-xl py-2 text-sm font-bold">Export CSV</button>
                                            <button onClick={generateJuryPdf} className="bg-white text-black hover:bg-gray-200 rounded-xl py-2 text-sm font-extrabold col-span-2">Jury Pack PDF</button>
                                            <button onClick={runDemo} className="bg-purple-600/80 hover:bg-purple-600 rounded-xl py-2 text-sm font-bold col-span-2">Demo Mode Başlat</button>
                                        </div>
                                    </div>
</div>
                                </div>
                                <button onClick={() => { setTimeLeft(durations[mode]*60); setShowSettings(false); }} className="w-full mt-6 bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Kaydet</button>
                            </div>
                        </div>
                    )}

                    {/* --- DOCK NAVIGATION --- */}
                    <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-40 no-print">
                        <div className="glass-panel p-2 rounded-2xl flex items-center gap-2 shadow-2xl shadow-black/50 border border-white/20">
                            <button onClick={() => setActiveTab('mixer')} className={`p-3 rounded-xl transition-all ${activeTab === 'mixer' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Ses Mikseri"><Music size={24}/></button>
                            <button onClick={() => setActiveTab('timer')} className={`p-4 rounded-xl transition-all mx-2 ${activeTab === 'timer' ? `bg-${themeColor}-500 text-white shadow-lg shadow-${themeColor}-500/50 scale-110 -translate-y-4` : 'text-white/60 hover:bg-white/10'}`} title="Odaklan"><Clock size={28} fill={activeTab==='timer'?"currentColor":"none"} /></button>
                            <button onClick={() => setActiveTab('ai_study')} className={`p-3 rounded-xl transition-all ${activeTab === 'ai_study' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="AI Görsel Öğrenme"><ImageIcon size={24}/></button>
                            <button onClick={() => setActiveTab('planner')} className={`p-3 rounded-xl transition-all ${activeTab === 'planner' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="AI Planlayıcı"><Target size={24}/></button>
                            <button onClick={() => setActiveTab('tutor')} className={`p-3 rounded-xl transition-all ${activeTab === 'tutor' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Sokratik Hoca"><GraduationCap size={24}/></button>
                            <button onClick={() => setActiveTab('flashcards')} className={`p-3 rounded-xl transition-all ${activeTab === 'flashcards' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Kartlar"><Layers size={24}/></button>
                            <button onClick={() => setActiveTab('ai_core')} className={`p-3 rounded-xl transition-all ${activeTab === 'ai_core' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Teknofest AI"><Sparkles size={24}/></button>

                            <button onClick={() => setActiveTab('stats')} className={`p-3 rounded-xl transition-all ${activeTab === 'stats' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`} title="Kayıtlar"><BarChart2 size={24}/></button>
                        </div>
                    </div>

                    {/* ZEN MODE */}
                    {zenMode && (
                        <div className="fixed inset-0 z-[60] flex items-center justify-center">
                            <div className="text-center animate-fade-in group">
                                <div className="text-[12rem] font-bold font-mono tracking-tighter text-white drop-shadow-2xl select-none">
                                    {formatTime(timeLeft)}
                                </div>
                                <button onClick={() => setZenMode(false)} className="text-white/30 hover:text-white transition-colors flex items-center gap-2 mx-auto text-sm uppercase tracking-widest border border-white/10 px-6 py-2 rounded-full hover:bg-white/5 opacity-0 group-hover:opacity-100 duration-300">
                                    <Minimize2 size={16}/> Çıkış
                                </button>
                            </div>
                        </div>
                    )}

                    {/* BREATH MODE */}
                    {breathMode && (
                        <div className="fixed inset-0 z-[70] bg-black/90 flex items-center justify-center backdrop-blur-xl animate-fade-in" onClick={()=>setBreathMode(false)}>
                            <div className="text-center">
                                <div className="w-64 h-64 bg-blue-400/20 rounded-full flex items-center justify-center animate-breathe relative">
                                    <div className="w-48 h-48 bg-blue-400/40 rounded-full absolute animate-pulse"></div>
                                    <div className="text-2xl font-bold text-blue-200 animate-pulse-slow">Nefes Al... Ver...</div>
                                </div>
                                <p className="mt-8 text-white/50 text-sm">Ekrana tıklayarak çık</p>
                            </div>
                        </div>
                    )}
                                    {/* Global Audio Player (persists across tabs) */}
                    <audio ref={audioPlayerRef} className="hidden" />

{/* --- MINI PLAYER BAR (persists across tabs) --- */}
                {nowPlaying && miniPlayerOpen && (
                    <div className="fixed bottom-4 right-4 z-[9999] w-[360px] max-w-[92vw]">
                        <div className="glass-panel rounded-2xl p-3 shadow-2xl border border-white/10">
                            <div className="flex items-center gap-3">
                                <div className="w-12 h-12 rounded-xl overflow-hidden bg-white/5 flex-shrink-0">
                                    {nowPlaying.artworkUrl ? (
                                        <img src={nowPlaying.artworkUrl} alt="cover" className="w-full h-full object-cover" />
                                    ) : (
                                        <div className="w-full h-full flex items-center justify-center text-white/40">
                                            <Music size={18} />
                                        </div>
                                    )}
                                </div>

                                <div className="min-w-0 flex-1">
                                    <div className="text-sm font-semibold text-white truncate">{nowPlaying.title || 'Çalıyor'}</div>
                                    <div className="text-xs text-white/50 truncate">{nowPlaying.artist || nowPlaying.source || ''}</div>
                                </div>

                                <div className="flex items-center gap-1">
                                    <button onClick={() => setMiniPlayerCollapsed(v => !v)} className="p-2 rounded-xl hover:bg-white/10 text-white/70" title={miniPlayerCollapsed ? "Genişlet" : "Küçült"}>
                                        {miniPlayerCollapsed ? <Maximize2 size={18}/> : <Minimize2 size={18}/>}
                                    </button>
                                    <button onClick={() => { setMiniPlayerOpen(false); }} className="p-2 rounded-xl hover:bg-white/10 text-white/70" title="Kapat (müzik devam eder)">
                                        <X size={18}/>
                                    </button>
                                </div>
                            </div>

                            {!miniPlayerCollapsed && (
                                <div className="mt-3">
                                    <div className="flex items-center justify-between gap-2">
                                        <div className="flex items-center gap-2">
                                            <button onClick={musicPrev} className="p-2 rounded-xl hover:bg-white/10 text-white/80" title="Önceki">
                                                <ChevronLeft size={18}/>
                                            </button>
                                            <button onClick={musicTogglePlay} className="p-2 rounded-xl hover:bg-white/10 text-white" title={musicIsPlaying ? "Duraklat" : "Oynat"}>
                                                {musicIsPlaying ? <Pause size={18}/> : <Play size={18}/>}
                                            </button>
                                            <button onClick={musicNext} className="p-2 rounded-xl hover:bg-white/10 text-white/80" title="Sonraki">
                                                <ChevronRight size={18}/>
                                            </button>
                                        </div>

                                        <div className="flex items-center gap-2 w-40">
                                            <Volume2 size={16} className="text-white/60"/>
                                            <input
                                                type="range"
                                                min="0"
                                                max="1"
                                                step="0.01"
                                                value={musicVolume}
                                                onChange={(e) => setMusicVolume(parseFloat(e.target.value))}
                                                className="w-full"
                                                title="Ses"
                                            />
                                        </div>
                                    </div>

                                    {nowPlaying?.source === 'youtube' && ytEmbedId && (
                                        <div className="mt-3 rounded-xl overflow-hidden border border-white/10 bg-black/40">
                                            <iframe
                                                title="YouTube Player"
                                                src={getYouTubeEmbedUrl(ytEmbedId)}
                                                className="w-full aspect-video"
                                                allow="autoplay; encrypted-media; picture-in-picture; fullscreen"
                                                referrerPolicy="strict-origin-when-cross-origin"
                                                allowFullScreen
                                            />
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                )}

                {/* Mini player kapalıyken küçük aç butonu */}
                {nowPlaying && !miniPlayerOpen && (
                    <button
                        onClick={() => setMiniPlayerOpen(true)}
                        className="fixed bottom-4 right-4 z-[9999] glass-panel rounded-2xl px-3 py-2 flex items-center gap-2 hover:scale-[1.02] transition-all border border-white/10"
                        title="Müzik kontrolünü aç"
                    >
                        <Music size={16} className="text-white/80"/>
                        <span className="text-xs text-white/70 max-w-[160px] truncate">{nowPlaying.title || 'Müzik'}</span>
                    </button>
                )}

                </div>
                </React.Fragment>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
