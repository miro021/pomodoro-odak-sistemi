<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
  tailwind.config = {
    darkMode: 'class',
    theme: {
      extend: {
        animation: {
          'blob': 'blob 10s infinite',
          'float': 'float 6s ease-in-out infinite',
          'breathe': 'breathe 4s ease-in-out infinite',
          'slide-down': 'slideDown 0.5s ease-out',
          'flip': 'flip 0.6s cubic-bezier(0.455, 0.030, 0.515, 0.955) both',
        },
        keyframes: {
          blob: {
            '0%': { transform: 'translate(0px, 0px) scale(1)' },
            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
            '100%': { transform: 'translate(0px, 0px) scale(1)' },
          },
          float: {
            '0%, 100%': { transform: 'translateY(0)' },
            '50%': { transform: 'translateY(-10px)' },
          },
          slideDown: {
            '0%': { transform: 'translateY(-100%)', opacity: '0' },
            '100%': { transform: 'translateY(0)', opacity: '1' },
          }
        }
      }
    }
  }
</script>

<!-- React Import Map -->
<script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.263.1"
  }
}
</script>

<!-- Babel (JSX için – zorunlu) -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
        
        .glass-panel { 
            background: rgba(18, 18, 18, 0.6); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); 
        }
        
        .dynamic-island {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(24px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        }

        /* 3D Card Flip Styles */
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        body { margin: 0; overflow: hidden; font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef, useMemo } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
          Play, Pause, RotateCcw, Plus, Trash2, Check, Settings, X, 
          Volume2, VolumeX, BarChart2, Moon, Sun, Image as ImageIcon, 
          CloudRain, Waves, Coffee, Flame, Trees, Calendar, 
          User, Zap, LayoutGrid, Sparkles, Loader2, Key, MessageCircle, Send,
          Wand2, Target, Trophy, Library, Wind, Keyboard, BookOpen, Clock, Maximize2, Minimize2,
          StickyNote, GraduationCap, Layers, Radio, ChevronRight, ChevronLeft, RefreshCw
        } from 'lucide-react';

        // --- DATA ---
        const AMBIENT_SOUNDS = [
            { id: 'rain', icon: CloudRain, url: "https://actions.google.com/sounds/v1/weather/rain_heavy_loud.ogg", label: "Yağmur" },
            { id: 'waves', icon: Waves, url: "https://actions.google.com/sounds/v1/water/waves_crashing.ogg", label: "Dalga" },
            { id: 'coffee', icon: Coffee, url: "https://actions.google.com/sounds/v1/ambiences/coffee_shop.ogg", label: "Kafe" },
            { id: 'lofi', icon: Radio, url: "https://stream.zeno.fm/0r0xa792kwzuv", label: "Lofi Radyo" }, // Canlı Lofi Stream
            { id: 'white_noise', icon: Wind, url: "https://actions.google.com/sounds/v1/ambiences/wind_synthetic.ogg", label: "Rüzgar" }
        ];

        const BACKGROUNDS = [
            "https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?q=80&w=2613&auto=format&fit=crop", // City
            "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=2613&auto=format&fit=crop", // Mountains
            "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=2613&auto=format&fit=crop", // Beach
            "https://images.unsplash.com/photo-1554118811-1e0d58224f24?q=80&w=2600&auto=format&fit=crop", // Cafe
            "https://images.unsplash.com/photo-1483794344563-d27a8d18014e?q=80&w=2600&auto=format&fit=crop", // Dark Space
            "https://images.unsplash.com/photo-1516733725897-1aa73b87c8e8?q=80&w=2600&auto=format&fit=crop"  // Cyberpunk
        ];

        const App = () => {
          // --- STATES ---
          const [mode, setMode] = useState('focus');
          const [activeTab, setActiveTab] = useState('timer'); // timer, planner, stats, flashcards
          const [timeLeft, setTimeLeft] = useState(25 * 60);
          const [isActive, setIsActive] = useState(false);
          const [zenMode, setZenMode] = useState(false);
          
          const [tasks, setTasks] = useState(() => JSON.parse(localStorage.getItem('pomo_tasks') || '[]'));
          const [newTask, setNewTask] = useState('');
          
          // ÖĞRENCİ ÖZELLİKLERİ
          const [notes, setNotes] = useState(() => localStorage.getItem('pomo_notes') || '');
          const [exams, setExams] = useState(() => JSON.parse(localStorage.getItem('pomo_exams') || '[]')); 
          const [newExamTitle, setNewExamTitle] = useState('');
          const [newExamDate, setNewExamDate] = useState('');
          
          // FLASHCARDS
          const [flashcards, setFlashcards] = useState(() => JSON.parse(localStorage.getItem('pomo_flashcards') || '[]'));
          const [flashcardTopic, setFlashcardTopic] = useState('');
          const [currentCardIndex, setCurrentCardIndex] = useState(0);
          const [isCardFlipped, setIsCardFlipped] = useState(false);
          const [isGeneratingCards, setIsGeneratingCards] = useState(false);

          // ANALYTICS
          const [dailyStats, setDailyStats] = useState(() => JSON.parse(localStorage.getItem('pomo_stats') || '{}')); // { "2023-10-27": 120 } dakika

          const [bgIndex, setBgIndex] = useState(0);
          const [activeSoundId, setActiveSoundId] = useState(null);
          const [soundVolume, setSoundVolume] = useState(0.5);
          const [apiKey, setApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
          const [showSettings, setShowSettings] = useState(false);
          const [isCoachOpen, setIsCoachOpen] = useState(false);
          const [chatMessages, setChatMessages] = useState([{role: 'system', text: "Merhaba! Ben senin AI Asistanınım. Ders planı, motivasyon veya konu anlatımı için buradayım."}]);
          const [chatInput, setChatInput] = useState('');
          const [isAiProcessing, setIsAiProcessing] = useState(false);
          const [durations, setDurations] = useState({ focus: 25, shortBreak: 5, longBreak: 15 });

          const timerRef = useRef(null);
          const audioRef = useRef(null);
          const chatEndRef = useRef(null);

          // --- PERSISTENCE ---
          useEffect(() => localStorage.setItem('pomo_tasks', JSON.stringify(tasks)), [tasks]);
          useEffect(() => localStorage.setItem('pomo_notes', notes), [notes]);
          useEffect(() => localStorage.setItem('pomo_exams', JSON.stringify(exams)), [exams]);
          useEffect(() => localStorage.setItem('pomo_flashcards', JSON.stringify(flashcards)), [flashcards]);
          useEffect(() => localStorage.setItem('pomo_stats', JSON.stringify(dailyStats)), [dailyStats]);
          useEffect(() => localStorage.setItem('gemini_api_key', apiKey), [apiKey]);

          // --- TIMER LOGIC ---
          useEffect(() => {
            if (isActive && timeLeft > 0) {
                timerRef.current = setInterval(() => {
                    setTimeLeft(p => p - 1);
                    // İstatistik Güncelleme (Her dakika)
                    if (timeLeft % 60 === 0 && mode === 'focus') {
                        const today = new Date().toISOString().split('T')[0];
                        setDailyStats(prev => ({
                            ...prev,
                            [today]: (prev[today] || 0) + 1
                        }));
                    }
                }, 1000);
            } else if (timeLeft === 0) {
                clearInterval(timerRef.current);
                setIsActive(false);
                new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play();
            }
            return () => clearInterval(timerRef.current);
          }, [isActive, timeLeft, mode]);

          // --- SOUND LOGIC ---
          useEffect(() => {
            if (audioRef.current) { audioRef.current.pause(); audioRef.current = null; }
            if (activeSoundId) {
                const sound = AMBIENT_SOUNDS.find(s => s.id === activeSoundId);
                audioRef.current = new Audio(sound.url);
                audioRef.current.loop = true;
                audioRef.current.volume = soundVolume;
                audioRef.current.play().catch(e => console.log(e));
            }
          }, [activeSoundId]);
          
          useEffect(() => { if(audioRef.current) audioRef.current.volume = soundVolume; }, [soundVolume]);

          // --- AI CALL ---
          const callGemini = async (prompt) => {
            if (!apiKey) return "API Anahtarı eksik. Ayarlar'dan ekleyin.";
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Hata oluştu.";
            } catch (e) { return "Bağlantı hatası."; }
          };

          const handleChatSend = async () => {
             if(!chatInput.trim()) return;
             const msg = chatInput;
             setChatMessages(p => [...p, {role:'user', text: msg}]);
             setChatInput('');
             setIsAiProcessing(true);
             const reply = await callGemini(msg + " (Lütfen bir öğrenci koçu gibi kısa, öz ve motive edici Türkçe cevap ver.)");
             setChatMessages(p => [...p, {role:'ai', text: reply}]);
             setIsAiProcessing(false);
          };

          const handleGenerateFlashcards = async () => {
             if(!flashcardTopic.trim()) return;
             setIsGeneratingCards(true);
             const prompt = `Konu: "${flashcardTopic}". Bu konuyla ilgili öğrenmem gereken en önemli 5 kavramı soru-cevap flashcard formatında hazırla. Sadece saf JSON array döndür. Format: [{"q": "Soru?", "a": "Cevap"}]`;
             try {
                const res = await callGemini(prompt);
                const jsonStr = res.replace(/```json/g, '').replace(/```/g, '').trim();
                const newCards = JSON.parse(jsonStr);
                setFlashcards(newCards);
                setCurrentCardIndex(0);
                setIsCardFlipped(false);
             } catch(e) {
                alert("Kartlar oluşturulamadı. Lütfen API anahtarını kontrol et veya tekrar dene.");
             }
             setIsGeneratingCards(false);
          };

          // --- VIEW HELPERS ---
          const formatTime = (s) => `${Math.floor(s/60).toString().padStart(2,'0')}:${(s%60).toString().padStart(2,'0')}`;
          const getThemeColor = () => mode === 'focus' ? 'rose' : mode === 'shortBreak' ? 'cyan' : 'indigo';
          const themeColor = getThemeColor();
          
          const getDaysLeft = (dateStr) => {
              const diff = new Date(dateStr) - new Date();
              return Math.ceil(diff / (1000 * 60 * 60 * 24));
          };

          // Grafik Verisi Hazırlama (Son 7 Gün)
          const getLast7DaysStats = () => {
              const stats = [];
              const today = new Date();
              for (let i = 6; i >= 0; i--) {
                  const d = new Date(today);
                  d.setDate(d.getDate() - i);
                  const dateStr = d.toISOString().split('T')[0];
                  const dayName = d.toLocaleDateString('tr-TR', { weekday: 'short' });
                  stats.push({ day: dayName, mins: dailyStats[dateStr] || 0 });
              }
              return stats;
          };

          return (
            <div className={`h-screen w-screen overflow-hidden relative text-white font-sans selection:bg-${themeColor}-500 selection:text-white`}>
                
                {/* BACKGROUND LAYER */}
                <div className="absolute inset-0 z-0">
                    <div className="absolute inset-0 bg-cover bg-center transition-all duration-1000 transform scale-105" style={{ backgroundImage: `url(${BACKGROUNDS[bgIndex]})` }} />
                    <div className={`absolute inset-0 bg-black/50 backdrop-blur-[2px]`}></div>
                    <div className={`absolute inset-0 bg-gradient-to-b from-black/60 via-transparent to-black/80`}></div>
                </div>

                {/* --- DYNAMIC ISLAND --- */}
                <div className={`fixed top-0 left-0 right-0 z-50 flex justify-center pt-4 transition-transform duration-500 ${zenMode ? '-translate-y-32' : 'translate-y-0'}`}>
                    <div className="dynamic-island h-14 rounded-full px-2 flex items-center gap-2 animate-slide-down max-w-2xl w-full mx-4 justify-between">
                         <div className="flex items-center gap-2 pl-2">
                             <div className={`w-8 h-8 rounded-full bg-${themeColor}-500 flex items-center justify-center font-bold text-xs`}>OS</div>
                             <div className="h-6 w-[1px] bg-white/10 mx-1"></div>
                             {AMBIENT_SOUNDS.map(s => (
                                 <button key={s.id} onClick={() => setActiveSoundId(activeSoundId === s.id ? null : s.id)} className={`p-2 rounded-full transition-all hover:bg-white/10 ${activeSoundId === s.id ? `text-${themeColor}-400` : 'text-white/50'}`} title={s.label}>
                                     <s.icon size={16}/>
                                 </button>
                             ))}
                         </div>
                         {activeSoundId && (
                             <div className="flex-1 px-4 max-w-[150px]">
                                 <input type="range" min="0" max="1" step="0.1" value={soundVolume} onChange={e=>setSoundVolume(e.target.value)} className="w-full h-1 bg-white/20 rounded-lg appearance-none cursor-pointer accent-white"/>
                             </div>
                         )}
                         <div className="flex items-center gap-1 pr-1">
                             <button onClick={() => setBgIndex(i => (i+1)%BACKGROUNDS.length)} className="p-2.5 rounded-full hover:bg-white/10 text-white/70"><ImageIcon size={16}/></button>
                             <button onClick={() => setZenMode(true)} className="p-2.5 rounded-full hover:bg-white/10 text-white/70" title="Zen Modu"><Maximize2 size={16}/></button>
                             <button onClick={() => setShowSettings(true)} className="p-2.5 rounded-full hover:bg-white/10 text-white/70"><Settings size={16}/></button>
                         </div>
                    </div>
                </div>

                {/* --- MAIN LAYOUT --- */}
                <div className={`relative z-10 h-full w-full pt-24 pb-20 px-8 flex justify-center transition-opacity duration-700 ${zenMode ? 'opacity-0 pointer-events-none' : 'opacity-100'}`}>
                    
                    {/* --- TIMER TAB (DEFAULT) --- */}
                    {activeTab === 'timer' && (
                        <div className="w-full grid grid-cols-1 lg:grid-cols-12 gap-8 h-full">
                             {/* SOL: Görevler */}
                             <div className="lg:col-span-3 h-full flex flex-col gap-6 animate-slide-up">
                                <div className="glass-panel flex-1 rounded-[2rem] p-6 flex flex-col relative overflow-hidden">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="font-bold flex items-center gap-2 text-lg"><LayoutGrid className={`text-${themeColor}-400`}/> Görevler</h3>
                                        <span className="bg-white/10 px-2 py-0.5 rounded text-xs font-mono">{tasks.filter(t=>!t.completed).length} Aktif</span>
                                    </div>
                                    <form onSubmit={(e)=>{e.preventDefault(); if(newTask) { setTasks([...tasks, {id:Date.now(), title:newTask, completed:false}]); setNewTask(''); }}} className="relative mb-4">
                                        <input value={newTask} onChange={e=>setNewTask(e.target.value)} placeholder="Yeni görev..." className="w-full bg-black/20 border border-white/10 rounded-xl px-4 py-3 outline-none focus:border-white/30 transition-all text-sm placeholder:text-white/20" />
                                        <button type="submit" className={`absolute right-2 top-2 p-1.5 rounded-lg bg-${themeColor}-500 text-white hover:scale-105 transition-transform`}><Plus size={16}/></button>
                                    </form>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2 pr-1">
                                        {tasks.map(task => (
                                            <div key={task.id} className="group/item flex items-center gap-3 p-3 rounded-xl hover:bg-white/5 border border-transparent hover:border-white/5 transition-all cursor-pointer">
                                                <button onClick={() => setTasks(tasks.map(t=>t.id===task.id?{...t, completed:!t.completed}:t))} className={`w-5 h-5 rounded-full border-2 flex items-center justify-center transition-all ${task.completed ? 'bg-green-500 border-green-500' : 'border-white/20 hover:border-white/50'}`}>
                                                    {task.completed && <Check size={12} />}
                                                </button>
                                                <span className={`flex-1 text-sm ${task.completed ? 'line-through text-white/30' : 'text-white/90'}`}>{task.title}</span>
                                                <button onClick={() => setTasks(tasks.filter(t=>t.id!==task.id))} className="opacity-0 group-hover/item:opacity-100 text-red-400 hover:text-red-300 p-1"><Trash2 size={14}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                             </div>

                             {/* ORTA: Timer */}
                             <div className="lg:col-span-6 h-full flex flex-col items-center justify-center relative animate-slide-up">
                                <div className="relative w-[450px] h-[450px] flex items-center justify-center group">
                                    <div className={`absolute inset-0 rounded-full bg-${themeColor}-500/10 blur-[80px] group-hover:bg-${themeColor}-500/20 transition-all duration-1000 animate-pulse`}></div>
                                    <svg className="w-full h-full transform -rotate-90 drop-shadow-2xl">
                                        <circle cx="50%" cy="50%" r="180" stroke="rgba(255,255,255,0.05)" strokeWidth="12" fill="none" />
                                        <circle cx="50%" cy="50%" r="180" stroke="currentColor" strokeWidth="12" fill="none" strokeDasharray={2 * Math.PI * 180} strokeDashoffset={2 * Math.PI * 180 * (1 - timeLeft / (durations[mode] * 60))} strokeLinecap="round" className={`text-${themeColor}-500 transition-all duration-1000 ease-linear`} />
                                    </svg>
                                    <div className="absolute inset-0 flex flex-col items-center justify-center z-10">
                                        <div className="flex gap-2 mb-6">
                                            {['focus', 'shortBreak', 'longBreak'].map(m => (
                                                <button key={m} onClick={() => { setMode(m); setIsActive(false); setTimeLeft(durations[m]*60); }} className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all ${mode === m ? 'bg-white text-black shadow-lg shadow-white/20' : 'bg-black/20 text-white/50 hover:bg-white/10 hover:text-white'}`}>{m === 'focus' ? 'Odak' : m === 'shortBreak' ? 'Kısa' : 'Uzun'}</button>
                                            ))}
                                        </div>
                                        <div className={`text-9xl font-bold font-mono tracking-tighter tabular-nums text-white drop-shadow-2xl select-none ${isActive ? 'animate-float' : ''}`}>{formatTime(timeLeft)}</div>
                                        <p className={`mt-4 text-sm font-medium tracking-[0.3em] uppercase text-${themeColor}-300 opacity-80`}>{isActive ? 'Akıştasınız' : 'Hazır mısınız?'}</p>
                                    </div>
                                    <div className="absolute -bottom-10 left-1/2 -translate-x-1/2 flex gap-4">
                                        <button onClick={() => { setIsActive(false); setTimeLeft(durations[mode]*60); }} className="p-4 rounded-2xl glass-panel hover:bg-white/10 active:scale-95 transition-all"><RotateCcw size={24}/></button>
                                        <button onClick={() => setIsActive(!isActive)} className={`h-20 w-24 rounded-3xl bg-${themeColor}-600 flex items-center justify-center shadow-xl shadow-${themeColor}-600/30 hover:scale-105 active:scale-95 transition-all border border-white/10`}>{isActive ? <Pause size={36} fill="white"/> : <Play size={36} fill="white" className="ml-1"/>}</button>
                                        <button onClick={() => setIsCoachOpen(true)} className="p-4 rounded-2xl glass-panel hover:bg-purple-500/20 text-purple-300 active:scale-95 transition-all"><Sparkles size={24}/></button>
                                    </div>
                                </div>
                             </div>

                             {/* SAĞ: Öğrenci Araçları */}
                             <div className="lg:col-span-3 h-full flex flex-col gap-6 animate-slide-up">
                                <div className="glass-panel rounded-[2rem] p-6 max-h-[40%] flex flex-col">
                                    <h3 className="font-bold flex items-center gap-2 text-lg mb-4"><GraduationCap className={`text-${themeColor}-400`}/> Sınav Takvimi</h3>
                                    <div className="flex gap-2 mb-4">
                                        <input value={newExamTitle} onChange={e=>setNewExamTitle(e.target.value)} placeholder="Ders/Sınav Adı" className="flex-1 bg-white/5 rounded-lg px-3 py-2 text-xs outline-none focus:bg-white/10"/>
                                        <input type="date" value={newExamDate} onChange={e=>setNewExamDate(e.target.value)} className="w-24 bg-white/5 rounded-lg px-2 py-2 text-xs outline-none focus:bg-white/10 text-white/70"/>
                                        <button onClick={()=>{if(newExamTitle&&newExamDate){setExams([...exams, {id:Date.now(), title:newExamTitle, date:newExamDate}]); setNewExamTitle('');}}} className={`p-2 rounded-lg bg-${themeColor}-500/50 hover:bg-${themeColor}-500`}><Plus size={14}/></button>
                                    </div>
                                    <div className="flex-1 overflow-y-auto custom-scrollbar space-y-2">
                                        {exams.sort((a,b)=>new Date(a.date)-new Date(b.date)).map(exam => {
                                            const days = getDaysLeft(exam.date);
                                            const isUrgent = days <= 3 && days >= 0;
                                            return (
                                                <div key={exam.id} className={`flex items-center justify-between p-3 rounded-xl border ${isUrgent ? 'bg-red-500/20 border-red-500/30' : 'bg-white/5 border-white/5'} hover:border-white/20 group`}>
                                                    <div><div className="font-medium text-sm">{exam.title}</div><div className={`text-[10px] ${isUrgent?'text-red-300':'text-white/40'}`}>{new Date(exam.date).toLocaleDateString('tr-TR')}</div></div>
                                                    <div className="flex items-center gap-2"><span className={`text-xs font-bold px-2 py-1 rounded ${isUrgent ? 'bg-red-500 text-white' : 'bg-white/10 text-white/70'}`}>{days < 0 ? 'Geçti' : days === 0 ? 'Bugün' : `${days} Gün`}</span><button onClick={() => setExams(exams.filter(e=>e.id!==exam.id))} className="text-white/20 hover:text-white"><X size={12}/></button></div>
                                                </div>
                                            )
                                        })}
                                    </div>
                                </div>
                                <div className="glass-panel flex-1 rounded-[2rem] p-6 flex flex-col relative group">
                                    <div className="absolute top-4 right-4 text-white/20 group-hover:text-white/50 transition-colors"><StickyNote size={20}/></div>
                                    <h3 className="font-bold text-lg mb-2">Hızlı Notlar</h3>
                                    <textarea value={notes} onChange={(e) => setNotes(e.target.value)} className="flex-1 bg-transparent border-none outline-none resize-none text-sm text-white/80 placeholder:text-white/20 leading-relaxed custom-scrollbar" placeholder="Aklına gelenleri buraya karala..."></textarea>
                                </div>
                             </div>
                        </div>
                    )}

                    {/* --- FLASHCARDS TAB --- */}
                    {activeTab === 'flashcards' && (
                        <div className="w-full max-w-4xl h-full flex flex-col animate-slide-up">
                            <div className="glass-panel p-8 rounded-[2rem] h-full flex flex-col items-center">
                                <div className="w-full flex justify-between items-center mb-8">
                                    <h2 className="text-3xl font-bold flex items-center gap-2"><Layers className="text-purple-400"/> AI Bilgi Kartları</h2>
                                    <div className="flex gap-2">
                                        <input value={flashcardTopic} onChange={e=>setFlashcardTopic(e.target.value)} placeholder="Örn: Mitoz Bölünme" className="bg-white/10 border border-white/10 rounded-xl px-4 py-2 outline-none w-64"/>
                                        <button onClick={handleGenerateFlashcards} disabled={isGeneratingCards} className="bg-purple-600 hover:bg-purple-500 px-6 py-2 rounded-xl font-bold flex items-center gap-2 disabled:opacity-50">
                                            {isGeneratingCards ? <Loader2 className="animate-spin" size={18}/> : <Wand2 size={18}/>} Oluştur
                                        </button>
                                    </div>
                                </div>

                                {flashcards.length > 0 ? (
                                    <div className="flex-1 flex flex-col items-center justify-center w-full max-w-2xl">
                                        <div 
                                            className="perspective-1000 w-full h-80 cursor-pointer" 
                                            onClick={() => setIsCardFlipped(!isCardFlipped)}
                                        >
                                            <div className={`relative w-full h-full text-center transition-transform duration-700 transform-style-3d ${isCardFlipped ? 'rotate-y-180' : ''}`}>
                                                {/* ÖN YÜZ */}
                                                <div className="absolute inset-0 backface-hidden glass-panel rounded-3xl flex items-center justify-center p-8 border-2 border-white/5 bg-[#1a1a1a]">
                                                    <div>
                                                        <div className="text-xs uppercase tracking-widest text-purple-400 mb-4">Soru {currentCardIndex + 1}/{flashcards.length}</div>
                                                        <div className="text-2xl font-bold leading-relaxed">{flashcards[currentCardIndex].q}</div>
                                                    </div>
                                                </div>
                                                {/* ARKA YÜZ */}
                                                <div className="absolute inset-0 backface-hidden glass-panel rounded-3xl flex items-center justify-center p-8 border-2 border-purple-500/30 bg-purple-900/20 rotate-y-180">
                                                    <div>
                                                        <div className="text-xs uppercase tracking-widest text-green-400 mb-4">Cevap</div>
                                                        <div className="text-xl leading-relaxed">{flashcards[currentCardIndex].a}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div className="flex items-center gap-8 mt-8">
                                            <button onClick={() => { setCurrentCardIndex(p => Math.max(0, p - 1)); setIsCardFlipped(false); }} disabled={currentCardIndex === 0} className="p-4 rounded-full glass-panel hover:bg-white/10 disabled:opacity-30"><ChevronLeft size={24}/></button>
                                            <button onClick={() => setIsCardFlipped(!isCardFlipped)} className="flex items-center gap-2 text-white/50 hover:text-white"><RefreshCw size={16}/> Çevir</button>
                                            <button onClick={() => { setCurrentCardIndex(p => Math.min(flashcards.length - 1, p + 1)); setIsCardFlipped(false); }} disabled={currentCardIndex === flashcards.length - 1} className="p-4 rounded-full glass-panel hover:bg-white/10 disabled:opacity-30"><ChevronRight size={24}/></button>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="flex-1 flex flex-col items-center justify-center text-white/30">
                                        <Layers size={64} className="mb-4 opacity-50"/>
                                        <p>Konu yaz ve yapay zekanın senin için çalışma kartları hazırlamasını bekle.</p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* --- STATS TAB (UPDATED) --- */}
                    {activeTab === 'stats' && (
                        <div className="w-full max-w-4xl h-full flex flex-col gap-6 animate-slide-up">
                            <div className="glass-panel p-6 rounded-[2rem]">
                                <h3 className="font-bold flex items-center gap-2 mb-6"><BarChart2 className="text-green-400"/> Haftalık Odak Analizi (Dakika)</h3>
                                <div className="h-64 flex items-end justify-between gap-4 px-4">
                                    {getLast7DaysStats().map((stat, i) => (
                                        <div key={i} className="flex flex-col items-center gap-2 flex-1 group">
                                            <div className="w-full bg-white/5 rounded-t-xl relative h-full flex items-end overflow-hidden">
                                                <div 
                                                    className={`w-full bg-${themeColor}-500 opacity-80 group-hover:opacity-100 transition-all duration-1000 ease-out`} 
                                                    style={{ height: `${Math.min(100, (stat.mins / 120) * 100)}%` }}
                                                ></div>
                                            </div>
                                            <div className="text-xs font-bold text-white/50">{stat.day}</div>
                                            <div className="text-xs font-mono absolute -mt-6 bg-black/80 px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity">{stat.mins}dk</div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-6">
                                <div className="glass-panel p-6 rounded-[2rem] flex items-center justify-between">
                                    <div>
                                        <div className="text-3xl font-bold">{tasks.filter(t=>t.completed).length}</div>
                                        <div className="text-xs uppercase text-white/40">Tamamlanan Görev</div>
                                    </div>
                                    <Trophy className="text-yellow-400" size={32}/>
                                </div>
                                <div className="glass-panel p-6 rounded-[2rem] flex items-center justify-between">
                                    <div>
                                        <div className="text-3xl font-bold">{flashcards.length}</div>
                                        <div className="text-xs uppercase text-white/40">Oluşturulan Kart</div>
                                    </div>
                                    <Layers className="text-purple-400" size={32}/>
                                </div>
                            </div>
                        </div>
                    )}

                </div>

                {/* --- ZEN MODE OVERLAY --- */}
                {zenMode && (
                    <div className="fixed inset-0 z-40 flex items-center justify-center">
                        <div className="text-center animate-fade-in">
                            <div className="relative mb-8">
                                <div className={`absolute inset-0 bg-${themeColor}-500/20 blur-[100px] rounded-full animate-pulse`}></div>
                                <div className="text-[12rem] font-bold font-mono tracking-tighter text-white drop-shadow-2xl">
                                    {formatTime(timeLeft)}
                                </div>
                            </div>
                            <button onClick={() => setZenMode(false)} className="text-white/30 hover:text-white transition-colors flex items-center gap-2 mx-auto text-sm uppercase tracking-widest border border-white/10 px-6 py-2 rounded-full hover:bg-white/5">
                                <Minimize2 size={16}/> Çıkış
                            </button>
                        </div>
                    </div>
                )}

                {/* --- AI COACH CHAT --- */}
                {isCoachOpen && (
                    <div className="fixed bottom-24 right-8 w-96 h-[500px] glass-panel rounded-3xl flex flex-col border border-white/10 shadow-2xl z-50 animate-slide-up bg-[#0a0a0a]/90">
                        <div className="p-4 border-b border-white/10 flex justify-between items-center bg-gradient-to-r from-purple-900/30 to-blue-900/30">
                            <h3 className="font-bold flex items-center gap-2 text-purple-300"><Sparkles size={16}/> AI Öğrenci Koçu</h3>
                            <button onClick={() => setIsCoachOpen(false)} className="hover:bg-white/10 p-1 rounded-full"><X size={18}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar">
                            {chatMessages.map((msg, i) => (
                                msg.role !== 'system' && (
                                    <div key={i} className={`flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[85%] p-3 rounded-2xl text-sm leading-relaxed shadow-sm ${msg.role === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-[#1a1a1a] border border-white/10 text-gray-200 rounded-bl-none'}`}>
                                            {msg.text}
                                        </div>
                                    </div>
                                )
                            ))}
                            {isAiProcessing && <div className="text-xs text-white/40 ml-4 flex gap-1 items-center animate-pulse"><Loader2 size={12} className="animate-spin"/> Yazıyor...</div>}
                            <div ref={chatEndRef}></div>
                        </div>
                        <div className="p-3 border-t border-white/10 bg-black/40">
                            <div className="flex gap-2">
                                <input value={chatInput} onChange={e => setChatInput(e.target.value)} onKeyDown={e => e.key === 'Enter' && handleChatSend()} placeholder="Bir şeyler sor..." className="flex-1 bg-white/5 border border-white/10 rounded-xl px-4 py-2 text-sm outline-none focus:border-purple-500 transition-colors" />
                                <button onClick={handleChatSend} disabled={isAiProcessing} className="p-2 bg-purple-600 rounded-xl hover:bg-purple-500 disabled:opacity-50"><Send size={18}/></button>
                            </div>
                        </div>
                    </div>
                )}

                {/* --- DOCK NAVIGATION --- */}
                <div className="fixed bottom-6 left-1/2 -translate-x-1/2 z-50">
                    <div className="glass-panel p-2 rounded-2xl flex items-center gap-2 shadow-2xl shadow-black/50 border border-white/20">
                        <button onClick={() => setActiveTab('timer')} className={`p-4 rounded-xl transition-all mx-2 ${activeTab === 'timer' ? `bg-${themeColor}-500 text-white shadow-lg shadow-${themeColor}-500/50 scale-110 -translate-y-4` : 'text-white/60 hover:bg-white/10'}`}><Clock size={28} fill={activeTab==='timer'?"currentColor":"none"} /></button>
                        <button onClick={() => setActiveTab('flashcards')} className={`p-3 rounded-xl transition-all ${activeTab === 'flashcards' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`}><Layers size={24}/></button>
                        <button onClick={() => setActiveTab('stats')} className={`p-3 rounded-xl transition-all ${activeTab === 'stats' ? 'bg-white text-black shadow-lg scale-110' : 'text-white/60 hover:bg-white/10'}`}><BarChart2 size={24}/></button>
                    </div>
                </div>

                {/* --- SETTINGS MODAL --- */}
                {showSettings && (
                    <div className="fixed inset-0 bg-black/80 backdrop-blur-md z-[100] flex items-center justify-center p-4">
                        <div className="glass-panel w-full max-w-md rounded-3xl p-6 bg-[#0f0f0f] border border-white/10 shadow-2xl animate-fade-in relative overflow-hidden">
                             <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold flex items-center gap-2"><Settings className="text-white/50"/> Ayarlar</h2>
                                <button onClick={() => setShowSettings(false)} className="p-2 hover:bg-white/10 rounded-full"><X size={20}/></button>
                            </div>
                            <div className="space-y-4">
                                <div>
                                    <label className="text-xs font-bold text-white/40 uppercase mb-2 block">Süreler (Dakika)</label>
                                    <div className="grid grid-cols-3 gap-3">
                                        {Object.entries(durations).map(([k, v]) => (
                                            <input key={k} type="number" value={v} onChange={e => setDurations({...durations, [k]: parseInt(e.target.value)||1})} className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-center outline-none focus:bg-white/10" placeholder={k} />
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-purple-400 uppercase mb-2 block flex items-center gap-2"><Key size={12}/> Gemini API Anahtarı</label>
                                    <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="AI_zaSy..." className="w-full bg-white/5 border border-white/10 rounded-lg px-3 py-2 text-sm focus:border-purple-500 outline-none" />
                                </div>
                            </div>
                            <button onClick={() => { setTimeLeft(durations[mode]*60); setShowSettings(false); }} className="w-full mt-6 bg-white text-black font-bold py-3 rounded-xl hover:bg-gray-200">Kaydet</button>
                        </div>
                    </div>
                )}
            </div>
          );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>